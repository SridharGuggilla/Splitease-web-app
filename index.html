<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SplitEase ‚Äî Split Expenses Effortlessly</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #07090f;
  --surface: #0f1318;
  --surface2: #161c26;
  --surface3: #1e2535;
  --border: #252d3d;
  --accent: #4fffb0;
  --accent-dim: rgba(79,255,176,0.12);
  --accent-glow: rgba(79,255,176,0.25);
  --red: #ff5e6c;
  --red-dim: rgba(255,94,108,0.12);
  --yellow: #ffc94d;
  --purple: #a78bfa;
  --blue: #60a5fa;
  --text: #e8eef8;
  --muted: #6b7a99;
  --muted2: #3d4a63;
  --green: #4fffb0;
  --radius: 14px;
  --font: 'Sora', sans-serif;
  --mono: 'Space Mono', monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
::selection{background:var(--accent-dim);color:var(--accent)}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

/* SCREENS */
.screen{display:none;min-height:100vh;animation:fadeIn 0.3s ease}
.screen.active{display:flex;flex-direction:column}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}

/* ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ */
#auth-screen{
  background: radial-gradient(ellipse 80% 60% at 50% -20%, rgba(79,255,176,0.07) 0%, transparent 60%),
              radial-gradient(ellipse 60% 40% at 80% 80%, rgba(167,139,250,0.05) 0%, transparent 50%),
              var(--bg);
  align-items:center;justify-content:center;padding:20px;
}
.auth-wrap{width:100%;max-width:400px}
.brand{text-align:center;margin-bottom:36px}
.brand-icon{
  width:56px;height:56px;border-radius:18px;margin:0 auto 14px;
  background:linear-gradient(135deg,var(--accent),var(--purple));
  display:flex;align-items:center;justify-content:center;font-size:24px;
  box-shadow:0 0 40px var(--accent-glow);
}
.brand-name{font-size:28px;font-weight:800;letter-spacing:-0.5px}
.brand-name span{color:var(--accent)}
.brand-tag{font-size:13px;color:var(--muted);margin-top:4px}
.auth-card{
  background:var(--surface);border:1px solid var(--border);border-radius:20px;
  padding:32px;box-shadow:0 30px 80px rgba(0,0,0,0.6);
  animation:slideUp 0.4s ease;
}
.auth-title{font-size:20px;font-weight:700;margin-bottom:6px}
.auth-sub{font-size:13px;color:var(--muted);margin-bottom:24px}
.form-group{margin-bottom:16px}
label{display:block;font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.6px;margin-bottom:8px}
input[type=email],input[type=password],input[type=text],input[type=number],select,textarea{
  width:100%;padding:12px 14px;background:var(--surface2);border:1px solid var(--border);
  border-radius:10px;color:var(--text);font-family:var(--font);font-size:14px;outline:none;
  transition:border-color 0.2s,box-shadow 0.2s;
}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
input::placeholder,textarea::placeholder{color:var(--muted2)}
.input-error{border-color:var(--red)!important;box-shadow:0 0 0 3px var(--red-dim)!important}
.error-msg{font-size:12px;color:var(--red);margin-top:6px;display:none}
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:8px;
  padding:12px 18px;border-radius:10px;border:none;cursor:pointer;
  font-family:var(--font);font-size:14px;font-weight:600;transition:all 0.2s;
  text-decoration:none;white-space:nowrap;
}
.btn-primary{background:var(--accent);color:#07090f;width:100%;font-size:15px;padding:13px}
.btn-primary:hover{background:#3de89e;box-shadow:0 8px 30px var(--accent-glow);transform:translateY(-1px)}
.btn-primary:active{transform:translateY(0)}
.btn-ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.btn-danger{background:var(--red-dim);color:var(--red);border:1px solid rgba(255,94,108,0.3)}
.btn-danger:hover{background:rgba(255,94,108,0.2)}
.btn-sm{padding:8px 14px;font-size:13px;border-radius:8px}
.btn-icon{padding:9px;border-radius:8px;font-size:16px}
.auth-toggle{text-align:center;margin-top:18px;font-size:13px;color:var(--muted)}
.auth-toggle a{color:var(--accent);cursor:pointer;font-weight:600}
.auth-toggle a:hover{text-decoration:underline}
.divider{display:flex;align-items:center;gap:10px;margin:18px 0;color:var(--muted2);font-size:12px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}

/* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
#app-screen{flex-direction:column;background:var(--bg)}
.topbar{
  background:rgba(15,19,24,0.95);backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);padding:0 24px;height:60px;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:100;
}
.topbar-left{display:flex;align-items:center;gap:12px}
.topbar-brand{font-size:17px;font-weight:800;letter-spacing:-0.3px}
.topbar-brand span{color:var(--accent)}
.topbar-icon{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:13px}
.topbar-right{display:flex;align-items:center;gap:10px}
.user-pill{display:flex;align-items:center;gap:8px;padding:5px 12px 5px 5px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;cursor:pointer;transition:border-color 0.2s}
.user-pill:hover{border-color:var(--accent)}
.avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#07090f;flex-shrink:0}
.avatar-lg{width:54px;height:54px;border-radius:50%;font-size:18px;font-weight:700}
.user-name{font-size:13px;font-weight:600}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app-body{display:flex;flex:1;overflow:hidden;height:calc(100vh - 60px)}
.sidebar{
  width:256px;background:var(--surface);border-right:1px solid var(--border);
  padding:16px 10px;display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;
}
.sidebar-section{font-size:10px;font-weight:700;color:var(--muted2);text-transform:uppercase;letter-spacing:1px;padding:10px 10px 4px}
.nav-item{
  display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:9px;
  cursor:pointer;transition:all 0.15s;font-size:13px;color:var(--muted);font-weight:500;
  position:relative;margin-bottom:1px;
}
.nav-item:hover{background:var(--surface2);color:var(--text)}
.nav-item.active{background:var(--accent-dim);color:var(--accent);font-weight:600}
.nav-item .nav-icon{font-size:15px;width:20px;text-align:center;flex-shrink:0}
.nav-item .nav-badge{margin-left:auto;background:var(--red);color:white;border-radius:10px;padding:2px 6px;font-size:10px;font-weight:700;min-width:18px;text-align:center}
.group-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.nav-item .leave-btn{margin-left:auto;display:none;background:none;border:none;color:var(--red);cursor:pointer;font-size:12px;padding:3px 5px;border-radius:5px}
.nav-item:hover .leave-btn{display:inline}
.sidebar-bottom{margin-top:auto;padding-top:12px;border-top:1px solid var(--border)}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{flex:1;overflow-y:auto;padding:28px}
.page{display:none;animation:slideUp 0.3s ease}
.page.active{display:block}
.page-head{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px;gap:12px;flex-wrap:wrap}
.page-title{font-size:22px;font-weight:800;letter-spacing:-0.3px}
.page-sub{font-size:13px;color:var(--muted);margin-top:3px}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:24px}
.stat{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:transform 0.2s,border-color 0.2s}
.stat:hover{transform:translateY(-2px);border-color:var(--border)}
.stat-label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.stat-val{font-size:26px;font-weight:700;font-family:var(--mono)}
.stat-val.green{color:var(--green)}
.stat-val.red{color:var(--red)}
.stat-val.blue{color:var(--blue)}
.stat-val.purple{color:var(--purple)}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:14px}
.card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card-title{font-size:14px;font-weight:700}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}

/* EXPENSE LIST */
.exp-list{display:flex;flex-direction:column;gap:8px}
.exp-item{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:14px 16px;display:flex;align-items:center;gap:12px;
  transition:border-color 0.15s,transform 0.15s;cursor:default;
}
.exp-item:hover{border-color:var(--muted2);transform:translateX(2px)}
.exp-ico{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.exp-info{flex:1;min-width:0}
.exp-desc{font-weight:600;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.exp-meta{font-size:12px;color:var(--muted);margin-top:2px}
.exp-right{text-align:right;flex-shrink:0}
.exp-total{font-weight:700;font-size:14px;font-family:var(--mono)}
.exp-share{font-size:12px;margin-top:2px}
.you-owe{color:var(--red)}
.owed-you{color:var(--green)}
.settled-txt{color:var(--muted)}
.exp-actions{display:flex;gap:6px;margin-left:8px}
.icon-btn{background:none;border:none;cursor:pointer;padding:6px;border-radius:6px;color:var(--muted);font-size:14px;transition:all 0.15s}
.icon-btn:hover{background:var(--surface3);color:var(--text)}
.icon-btn.del:hover{color:var(--red);background:var(--red-dim)}

/* GROUPS */
.groups-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
.group-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:18px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;
}
.group-card:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 12px 40px rgba(0,0,0,0.4)}
.group-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.gc-teal::before{background:linear-gradient(90deg,var(--accent),var(--purple))}
.gc-red::before{background:linear-gradient(90deg,var(--red),var(--yellow))}
.gc-purple::before{background:linear-gradient(90deg,var(--purple),var(--blue))}
.gc-yellow::before{background:linear-gradient(90deg,var(--yellow),var(--green))}
.gc-blue::before{background:linear-gradient(90deg,var(--blue),var(--accent))}
.group-emoji{font-size:26px;margin-bottom:10px}
.group-name{font-weight:700;font-size:15px;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.group-members{font-size:12px;color:var(--muted);margin-bottom:12px}
.group-bal{font-family:var(--mono);font-weight:700;font-size:17px}
.group-actions{display:flex;gap:6px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}

/* BALANCES */
.bal-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:8px}
.bal-avatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0}
.bal-info{flex:1}
.bal-name{font-weight:600;font-size:14px}
.bal-status{font-size:12px;margin-top:2px}
.bal-amount{font-family:var(--mono);font-weight:700;font-size:15px}
.settle-btn{padding:7px 13px;border-radius:8px;border:1px solid rgba(79,255,176,0.3);background:rgba(79,255,176,0.08);color:var(--accent);font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s;white-space:nowrap}
.settle-btn:hover{background:rgba(79,255,176,0.18)}

/* ACTIVITY */
.act-item{display:flex;align-items:flex-start;gap:10px;padding:12px 0;border-bottom:1px solid var(--border)}
.act-item:last-child{border-bottom:none}
.act-dot{width:7px;height:7px;border-radius:50%;margin-top:5px;flex-shrink:0}
.act-text{font-size:13px;line-height:1.5;color:var(--muted)}
.act-text strong{color:var(--text)}
.act-time{font-size:11px;color:var(--muted2);margin-top:2px}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:200;display:flex;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity 0.2s}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px;width:100%;max-width:460px;transform:translateY(20px);transition:transform 0.25s;max-height:90vh;overflow-y:auto}
.overlay.open .modal{transform:translateY(0)}
.modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
.modal-title{font-size:17px;font-weight:700}
.close-x{background:var(--surface2);border:none;color:var(--muted);width:30px;height:30px;border-radius:7px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
.close-x:hover{color:var(--text);background:var(--surface3)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.split-row{display:flex;gap:8px;margin-bottom:14px}
.split-opt{flex:1;padding:9px;border:1px solid var(--border);border-radius:9px;background:transparent;color:var(--muted);cursor:pointer;font-family:var(--font);font-size:12px;font-weight:600;text-align:center;transition:all 0.15s}
.split-opt.active{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.color-row{display:flex;gap:8px;margin-top:4px}
.color-dot{width:26px;height:26px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.color-dot:hover,.color-dot.active{border-color:white;transform:scale(1.15)}
textarea{resize:vertical;min-height:70px}
select option{background:var(--surface2)}

/* MEMBERS INPUT */
.member-area{border:1px solid var(--border);border-radius:10px;padding:8px;min-height:44px;display:flex;flex-wrap:wrap;align-items:center;gap:4px;cursor:text;transition:border-color 0.2s}
.member-area:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.member-area input{border:none;background:transparent;color:var(--text);font-family:var(--font);font-size:13px;outline:none;flex:1;min-width:80px}
.member-tag{display:inline-flex;align-items:center;gap:5px;background:var(--surface3);border:1px solid var(--border);border-radius:16px;padding:4px 10px;font-size:12px;white-space:nowrap}
.member-tag .rm{cursor:pointer;color:var(--muted);transition:color 0.15s;font-size:11px}
.member-tag .rm:hover{color:var(--red)}

/* TABS */
.tabs{display:flex;gap:3px;background:var(--surface2);padding:3px;border-radius:10px;margin-bottom:18px;border:1px solid var(--border)}
.tab{flex:1;padding:8px;border-radius:8px;border:none;background:transparent;color:var(--muted);font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s}
.tab.active{background:var(--surface);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,0.3)}

/* EMPTY */
.empty{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-icon{font-size:44px;margin-bottom:14px;opacity:0.4;display:block}
.empty h3{font-size:16px;color:var(--text);margin-bottom:6px;font-weight:600}
.empty p{font-size:13px;max-width:260px;margin:0 auto;line-height:1.6}

/* TOAST */
#toast{
  position:fixed;bottom:24px;right:24px;z-index:9999;
  background:var(--surface2);border:1px solid var(--border);border-radius:12px;
  padding:12px 18px;font-size:13px;display:flex;align-items:center;gap:8px;
  transform:translateY(80px);opacity:0;transition:all 0.3s;max-width:320px;
  box-shadow:0 10px 40px rgba(0,0,0,0.5);
}
#toast.show{transform:translateY(0);opacity:1}

/* PROFILE */
.profile-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:14px}
.profile-top{display:flex;align-items:center;gap:16px;margin-bottom:22px;padding-bottom:22px;border-bottom:1px solid var(--border)}

/* LOADING */
.loading{display:flex;align-items:center;justify-content:center;padding:40px;gap:8px;color:var(--muted);font-size:13px}
.spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* RESPONSIVE */
@media(max-width:768px){
  .sidebar{display:none}
  .main{padding:16px}
  .stats-row{grid-template-columns:1fr 1fr}
  .two-col{grid-template-columns:1fr}
  .groups-grid{grid-template-columns:1fr}
}

/* CHART */
.bar-chart{display:flex;align-items:flex-end;gap:5px;height:64px;padding-top:8px}
.bar{flex:1;border-radius:4px 4px 0 0;min-height:3px;transition:height 0.6s ease;cursor:default;position:relative}
.bar:hover::after{content:attr(title);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--surface3);border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-size:11px;white-space:nowrap;color:var(--text);pointer-events:none}
.chart-labels{display:flex;justify-content:space-between;margin-top:4px}
.chart-labels span{font-size:10px;color:var(--muted2);flex:1;text-align:center}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ -->
<div id="auth-screen" class="screen active">
  <div class="auth-wrap">
    <div class="brand">
      <div class="brand-icon">‚úÇÔ∏è</div>
      <div class="brand-name">Split<span>Ease</span></div>
      <div class="brand-tag">Split expenses, not friendships</div>
    </div>
    <div class="auth-card">
      <!-- LOGIN -->
      <div id="login-panel">
        <div class="auth-title">Welcome back</div>
        <div class="auth-sub">Sign in to your account</div>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="li-email" placeholder="you@example.com" autocomplete="email">
          <div class="error-msg" id="li-email-err">Please enter a valid email</div>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="li-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
          <div class="error-msg" id="li-pass-err">Password is required</div>
        </div>
        <div class="error-msg" id="li-err" style="display:block;margin-bottom:12px;text-align:center"></div>
        <button class="btn btn-primary" onclick="login()">Sign In ‚Üí</button>
        <div class="divider">or</div>
        <div class="auth-toggle">New to SplitEase? <a onclick="showPanel('register')">Create free account</a></div>
      </div>
      <!-- REGISTER -->
      <div id="register-panel" style="display:none">
        <div class="auth-title">Create account</div>
        <div class="auth-sub">Start splitting expenses for free</div>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="reg-name" placeholder="Your full name" autocomplete="name">
          <div class="error-msg" id="reg-name-err">Name is required</div>
        </div>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="reg-email" placeholder="you@example.com" autocomplete="email">
          <div class="error-msg" id="reg-email-err">Please enter a valid email</div>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="reg-pass" placeholder="Minimum 6 characters" autocomplete="new-password">
          <div class="error-msg" id="reg-pass-err">Password must be at least 6 characters</div>
        </div>
        <div class="error-msg" id="reg-err" style="display:block;margin-bottom:12px;text-align:center"></div>
        <button class="btn btn-primary" onclick="register()">Create Account ‚Üí</button>
        <div class="divider">or</div>
        <div class="auth-toggle">Already have an account? <a onclick="showPanel('login')">Sign in</a></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ APP SCREEN ‚îÄ‚îÄ -->
<div id="app-screen" class="screen">
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-icon">‚úÇÔ∏è</div>
      <div class="topbar-brand">Split<span>Ease</span></div>
    </div>
    <div class="topbar-right">
      <button class="btn btn-sm btn-primary" onclick="openModal('exp-modal')">+ Expense</button>
      <div class="user-pill" onclick="goTo('profile')">
        <div class="avatar" id="topbar-avatar">?</div>
        <div class="user-name" id="topbar-name">User</div>
      </div>
    </div>
  </div>

  <div class="app-body">
    <!-- SIDEBAR -->
    <nav class="sidebar">
      <div class="sidebar-section">Main</div>
      <div class="nav-item active" onclick="goTo('dashboard')" id="nav-dashboard"><span class="nav-icon">üè†</span> Dashboard</div>
      <div class="nav-item" onclick="goTo('groups')" id="nav-groups"><span class="nav-icon">üë•</span> Groups</div>
      <div class="nav-item" onclick="goTo('expenses')" id="nav-expenses"><span class="nav-icon">üí∏</span> Expenses</div>
      <div class="nav-item" onclick="goTo('balances')" id="nav-balances">
        <span class="nav-icon">‚öñÔ∏è</span> Balances
        <span class="nav-badge" id="owe-badge" style="display:none">0</span>
      </div>
      <div class="nav-item" onclick="goTo('activity')" id="nav-activity"><span class="nav-icon">üîî</span> Activity</div>

      <div class="sidebar-section" style="margin-top:8px">My Groups</div>
      <div id="sidebar-groups-list"></div>

      <div class="sidebar-bottom">
        <div class="nav-item" onclick="goTo('profile')"><span class="nav-icon">üë§</span> Profile</div>
        <div class="nav-item" onclick="logout()" style="color:var(--red)"><span class="nav-icon">üö™</span> Logout</div>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main">

      <!-- DASHBOARD -->
      <div id="page-dashboard" class="page active">
        <div class="page-head">
          <div>
            <div class="page-title" id="welcome-txt">Hello üëã</div>
            <div class="page-sub">Your financial overview</div>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="openModal('grp-modal')">+ New Group</button>
        </div>
        <div class="stats-row">
          <div class="stat"><div class="stat-label">Owed to You</div><div class="stat-val green" id="s-owed">$0.00</div></div>
          <div class="stat"><div class="stat-label">You Owe</div><div class="stat-val red" id="s-owe">$0.00</div></div>
          <div class="stat"><div class="stat-label">Total Spent</div><div class="stat-val blue" id="s-spent">$0.00</div></div>
          <div class="stat"><div class="stat-label">Groups</div><div class="stat-val purple" id="s-groups">0</div></div>
        </div>
        <div class="two-col">
          <div class="card">
            <div class="card-head"><div class="card-title">Spending This Week</div></div>
            <div class="bar-chart" id="spend-chart"></div>
            <div class="chart-labels" id="chart-labels"></div>
          </div>
          <div class="card">
            <div class="card-title" style="margin-bottom:14px">Quick Actions</div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn btn-ghost" onclick="openModal('exp-modal')" style="width:100%;justify-content:flex-start">üí∏ Add Expense</button>
              <button class="btn btn-ghost" onclick="openModal('grp-modal')" style="width:100%;justify-content:flex-start">üë• Create Group</button>
              <button class="btn btn-ghost" onclick="goTo('balances')" style="width:100%;justify-content:flex-start">‚öñÔ∏è Settle Up</button>
              <button class="btn btn-ghost" onclick="exportCSV()" style="width:100%;justify-content:flex-start">üì§ Export CSV</button>
            </div>
          </div>
        </div>
        <div class="card-head"><div class="card-title">Recent Expenses</div><a onclick="goTo('expenses')" style="font-size:12px;color:var(--accent);cursor:pointer">View all ‚Üí</a></div>
        <div class="exp-list" id="dash-exps"></div>
      </div>

      <!-- GROUPS -->
      <div id="page-groups" class="page">
        <div class="page-head">
          <div><div class="page-title">Groups</div><div class="page-sub" id="grp-count-txt">No groups yet</div></div>
          <button class="btn btn-primary btn-sm" onclick="openModal('grp-modal')">+ New Group</button>
        </div>
        <div class="groups-grid" id="groups-grid"></div>
      </div>

      <!-- EXPENSES -->
      <div id="page-expenses" class="page">
        <div class="page-head">
          <div><div class="page-title">Expenses</div><div class="page-sub" id="exp-count-txt">All transactions</div></div>
          <button class="btn btn-primary btn-sm" onclick="openModal('exp-modal')">+ Add</button>
        </div>
        <div class="tabs">
          <button class="tab active" onclick="filterExps(this,'all')">All</button>
          <button class="tab" onclick="filterExps(this,'owe')">I Owe</button>
          <button class="tab" onclick="filterExps(this,'owed')">Owed to Me</button>
          <button class="tab" onclick="filterExps(this,'settled')">Settled</button>
        </div>
        <div class="exp-list" id="all-exps"></div>
      </div>

      <!-- BALANCES -->
      <div id="page-balances" class="page">
        <div class="page-head"><div><div class="page-title">Balances</div><div class="page-sub">Who owes what</div></div></div>
        <div id="bal-list"></div>
      </div>

      <!-- ACTIVITY -->
      <div id="page-activity" class="page">
        <div class="page-head"><div class="page-title">Activity</div></div>
        <div class="card"><div id="act-list"></div></div>
      </div>

      <!-- PROFILE -->
      <div id="page-profile" class="page">
        <div class="page-title" style="margin-bottom:20px">Profile Settings</div>
        <div class="profile-card">
          <div class="profile-top">
            <div class="avatar avatar-lg" id="prof-avatar">?</div>
            <div>
              <div style="font-size:18px;font-weight:700" id="prof-name">User</div>
              <div style="font-size:13px;color:var(--muted)" id="prof-email">email</div>
              <div style="font-size:11px;color:var(--muted2);margin-top:4px">Member since <span id="prof-since">today</span></div>
            </div>
          </div>
          <div class="row2">
            <div class="form-group"><label>Display Name</label><input type="text" id="pf-name"></div>
            <div class="form-group"><label>Currency</label>
              <select id="pf-currency">
                <option value="$">$ USD</option>
                <option value="¬£">¬£ GBP</option>
                <option value="‚Ç¨">‚Ç¨ EUR</option>
                <option value="‚Çπ">‚Çπ INR</option>
                <option value="¬•">¬• JPY</option>
              </select>
            </div>
          </div>
          <button class="btn btn-primary" style="width:auto;padding:10px 22px" onclick="saveProfile()">Save Changes</button>
        </div>
        <div class="profile-card">
          <div class="card-title" style="margin-bottom:10px">Account Stats</div>
          <div style="display:flex;gap:24px;flex-wrap:wrap">
            <div><div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Total Expenses</div><div style="font-size:22px;font-weight:700;font-family:var(--mono)" id="prof-exp-count">0</div></div>
            <div><div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Total Groups</div><div style="font-size:22px;font-weight:700;font-family:var(--mono)" id="prof-grp-count">0</div></div>
            <div><div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Total Spent</div><div style="font-size:22px;font-weight:700;font-family:var(--mono)" id="prof-spent">$0</div></div>
          </div>
        </div>
        <div class="profile-card">
          <div class="card-title" style="margin-bottom:10px;color:var(--red)">Danger Zone</div>
          <p style="font-size:13px;color:var(--muted);margin-bottom:14px">Delete all your data and account permanently.</p>
          <button class="btn btn-danger btn-sm" onclick="deleteAccount()">Delete Account</button>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ -->

<!-- ADD EXPENSE -->
<div class="overlay" id="exp-modal">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title" id="exp-modal-title">Add Expense</div>
      <button class="close-x" onclick="closeModal('exp-modal')">‚úï</button>
    </div>
    <input type="hidden" id="edit-exp-id">
    <div class="form-group"><label>Description</label><input type="text" id="e-desc" placeholder="e.g. Dinner at Pizza Hut"></div>
    <div class="row2">
      <div class="form-group"><label>Amount</label><input type="number" id="e-amt" placeholder="0.00" step="0.01" min="0"></div>
      <div class="form-group"><label>Category</label>
        <select id="e-cat">
          <option>üçï Food</option><option>üöó Transport</option><option>üè† Housing</option>
          <option>üéâ Entertainment</option><option>üõç Shopping</option><option>üè• Health</option>
          <option>‚úàÔ∏è Travel</option><option>üìö Education</option><option>üì¶ Other</option>
        </select>
      </div>
    </div>
    <div class="row2">
      <div class="form-group"><label>Group</label><select id="e-grp"><option value="">-- Personal --</option></select></div>
      <div class="form-group"><label>Paid By</label><select id="e-paid"><option value="me">You</option></select></div>
    </div>
    <div class="form-group"><label>Split Method</label>
      <div class="split-row">
        <button class="split-opt active" onclick="setSplit(this,'equal')">‚öñÔ∏è Equal</button>
        <button class="split-opt" onclick="setSplit(this,'you-paid')">üí∞ You Paid All</button>
        <button class="split-opt" onclick="setSplit(this,'no-split')">üë§ Just Me</button>
      </div>
    </div>
    <div class="form-group"><label>Date</label><input type="date" id="e-date"></div>
    <div class="form-group"><label>Notes (optional)</label><textarea id="e-notes" placeholder="Any details..."></textarea></div>
    <button class="btn btn-primary" onclick="saveExpense()" id="save-exp-btn">Add Expense</button>
  </div>
</div>

<!-- CREATE GROUP -->
<div class="overlay" id="grp-modal">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">Create Group</div>
      <button class="close-x" onclick="closeModal('grp-modal')">‚úï</button>
    </div>
    <div class="form-group"><label>Group Name</label><input type="text" id="g-name" placeholder="e.g. NYC Trip, Apartment, etc."></div>
    <div class="form-group"><label>Category</label>
      <select id="g-type">
        <option>‚úàÔ∏è Trip</option><option>üè† Home</option><option>üíº Work</option>
        <option>üéâ Event</option><option>üéì School</option><option>üë• General</option>
      </select>
    </div>
    <div class="form-group">
      <label>Members (type name + Enter)</label>
      <div class="member-area" id="member-area" onclick="document.getElementById('member-inp').focus()">
        <input type="text" id="member-inp" placeholder="Add member..." onkeydown="onMemberKey(event)">
      </div>
    </div>
    <div class="form-group"><label>Color</label>
      <div class="color-row">
        <div class="color-dot active" id="cd-teal" onclick="pickColor('teal')" style="background:linear-gradient(135deg,#4fffb0,#a78bfa)"></div>
        <div class="color-dot" id="cd-red" onclick="pickColor('red')" style="background:linear-gradient(135deg,#ff5e6c,#ffc94d)"></div>
        <div class="color-dot" id="cd-purple" onclick="pickColor('purple')" style="background:linear-gradient(135deg,#a78bfa,#60a5fa)"></div>
        <div class="color-dot" id="cd-yellow" onclick="pickColor('yellow')" style="background:linear-gradient(135deg,#ffc94d,#4fffb0)"></div>
        <div class="color-dot" id="cd-blue" onclick="pickColor('blue')" style="background:linear-gradient(135deg,#60a5fa,#4fffb0)"></div>
      </div>
    </div>
    <button class="btn btn-primary" onclick="saveGroup()">Create Group</button>
  </div>
</div>

<!-- SETTLE UP -->
<div class="overlay" id="settle-modal">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">Settle Up</div>
      <button class="close-x" onclick="closeModal('settle-modal')">‚úï</button>
    </div>
    <div id="settle-content"></div>
    <div class="form-group" style="margin-top:14px"><label>Payment Method</label>
      <select id="settle-method">
        <option>üíµ Cash</option><option>üè¶ Bank Transfer</option><option>üì± PayPal</option>
        <option>üí≥ Venmo</option><option>üì≤ UPI</option>
      </select>
    </div>
    <div class="form-group"><label>Note (optional)</label><input type="text" id="settle-note" placeholder="Add a note..."></div>
    <button class="btn btn-primary" style="background:var(--accent);margin-top:4px" onclick="confirmSettle()">‚úì Mark as Settled</button>
  </div>
</div>

<!-- EXIT GROUP -->
<div class="overlay" id="exit-modal">
  <div class="modal" style="max-width:380px">
    <div class="modal-head">
      <div class="modal-title">Leave Group?</div>
      <button class="close-x" onclick="closeModal('exit-modal')">‚úï</button>
    </div>
    <p style="color:var(--muted);font-size:14px;line-height:1.7;margin-bottom:20px">
      You're about to leave <strong id="exit-grp-name" style="color:var(--text)"></strong>. 
      All your expenses in this group will remain but you'll no longer be a member.
    </p>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="closeModal('exit-modal')" style="flex:1">Cancel</button>
      <button class="btn btn-danger" onclick="confirmExit()" style="flex:1">Leave Group</button>
    </div>
  </div>
</div>

<!-- DELETE EXPENSE -->
<div class="overlay" id="del-exp-modal">
  <div class="modal" style="max-width:360px">
    <div class="modal-head"><div class="modal-title">Delete Expense?</div><button class="close-x" onclick="closeModal('del-exp-modal')">‚úï</button></div>
    <p style="color:var(--muted);font-size:14px;margin-bottom:20px">This cannot be undone.</p>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="closeModal('del-exp-modal')" style="flex:1">Cancel</button>
      <button class="btn btn-danger" onclick="confirmDelExp()" style="flex:1">Delete</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STORAGE HELPERS ‚Äî per-user namespaced storage
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DB = {
  // users registry: { email -> { name, passHash, initials, currency, joined } }
  getUsers: () => JSON.parse(localStorage.getItem('se_users') || '{}'),
  saveUsers: (u) => localStorage.setItem('se_users', JSON.stringify(u)),

  // per-user data key
  key: (email, type) => `se_u_${btoa(email)}_${type}`,

  getData: (email, type) => JSON.parse(localStorage.getItem(DB.key(email, type)) || 'null'),
  saveData: (email, type, val) => localStorage.setItem(DB.key(email, type), JSON.stringify(val)),

  getGroups: (e) => DB.getData(e, 'groups') || [],
  saveGroups: (e, v) => DB.saveData(e, 'groups', v),

  getExpenses: (e) => DB.getData(e, 'expenses') || [],
  saveExpenses: (e, v) => DB.saveData(e, 'expenses', v),

  getActivity: (e) => DB.getData(e, 'activity') || [],
  saveActivity: (e, v) => DB.saveData(e, 'activity', v),

  getProfile: (e) => DB.getData(e, 'profile') || {},
  saveProfile: (e, v) => DB.saveData(e, 'profile', v),

  hash: async (str) => {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  APP STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let S = {
  user: null,          // current logged-in user email
  groups: [],
  expenses: [],
  activity: [],
  profile: {},
  newMembers: [],
  selectedColor: 'teal',
  selectedSplit: 'equal',
  settleTarget: null,
  exitGroupId: null,
  delExpId: null,
  editExpId: null,
  expFilter: 'all',
  currency: '$',
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPanel(p) {
  document.getElementById('login-panel').style.display = p==='login' ? 'block' : 'none';
  document.getElementById('register-panel').style.display = p==='register' ? 'block' : 'none';
  clearErrors();
}

function clearErrors() {
  document.querySelectorAll('.error-msg').forEach(e => { e.style.display = 'none'; e.textContent = ''; });
  document.querySelectorAll('input').forEach(i => i.classList.remove('input-error'));
}

function showErr(id, msg) {
  const el = document.getElementById(id);
  if(el) { el.style.display = 'block'; el.textContent = msg; }
}

async function register() {
  clearErrors();
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim().toLowerCase();
  const pass = document.getElementById('reg-pass').value;
  let ok = true;
  if(!name) { showErr('reg-name-err','Name is required'); document.getElementById('reg-name').classList.add('input-error'); ok=false; }
  if(!email || !email.includes('@')) { showErr('reg-email-err','Valid email required'); document.getElementById('reg-email').classList.add('input-error'); ok=false; }
  if(pass.length < 6) { showErr('reg-pass-err','Min 6 characters'); document.getElementById('reg-pass').classList.add('input-error'); ok=false; }
  if(!ok) return;

  const users = DB.getUsers();
  if(users[email]) { showErr('reg-err','An account with this email already exists.'); return; }

  const passHash = await DB.hash(pass);
  const initials = name.split(' ').filter(Boolean).map(n=>n[0].toUpperCase()).slice(0,2).join('');
  users[email] = { name, passHash, initials, joined: new Date().toISOString() };
  DB.saveUsers(users);

  // init empty user data
  DB.saveGroups(email, []);
  DB.saveExpenses(email, []);
  DB.saveActivity(email, [{ text: `Welcome to SplitEase, <strong>${name}</strong>! üéâ`, time: now(), color: '#4fffb0' }]);
  DB.saveProfile(email, { currency: '$', name });

  toast('‚úÖ Account created! Please sign in.');
  showPanel('login');
  document.getElementById('li-email').value = email;
}

async function login() {
  clearErrors();
  const email = document.getElementById('li-email').value.trim().toLowerCase();
  const pass = document.getElementById('li-pass').value;
  if(!email) { showErr('li-email-err','Email required'); return; }
  if(!pass) { showErr('li-pass-err','Password required'); return; }

  const users = DB.getUsers();
  if(!users[email]) { showErr('li-err','No account found with this email.'); return; }

  const passHash = await DB.hash(pass);
  if(users[email].passHash !== passHash) { showErr('li-err','Incorrect password.'); return; }

  // Store session
  sessionStorage.setItem('se_session', email);
  initApp(email);
}

function logout() {
  sessionStorage.removeItem('se_session');
  S.user = null;
  document.getElementById('auth-screen').classList.add('active');
  document.getElementById('app-screen').classList.remove('active');
  showPanel('login');
  toast('üëã Logged out');
}

async function deleteAccount() {
  if(!confirm('Delete your account and ALL data? This cannot be undone.')) return;
  const users = DB.getUsers();
  delete users[S.user];
  DB.saveUsers(users);
  ['groups','expenses','activity','profile'].forEach(t => localStorage.removeItem(DB.key(S.user,t)));
  sessionStorage.removeItem('se_session');
  logout();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT APP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initApp(email) {
  S.user = email;
  const users = DB.getUsers();
  const u = users[email];

  S.groups = DB.getGroups(email);
  S.expenses = DB.getExpenses(email);
  S.activity = DB.getActivity(email);
  S.profile = DB.getProfile(email);
  S.currency = S.profile.currency || '$';

  // UI
  const h = new Date().getHours();
  const greet = h<12?'Good morning':'h<18'?'Good afternoon':'Good evening';
  const name = u.name.split(' ')[0];
  document.getElementById('welcome-txt').textContent = (h<12?'Good morning':h<18?'Good afternoon':'Good evening')+`, ${name} üëã`;
  document.getElementById('topbar-avatar').textContent = u.initials;
  document.getElementById('topbar-name').textContent = name;
  document.getElementById('prof-avatar').textContent = u.initials;
  document.getElementById('prof-name').textContent = u.name;
  document.getElementById('prof-email').textContent = email;
  document.getElementById('prof-since').textContent = new Date(u.joined).toLocaleDateString('en-US',{month:'long',year:'numeric'});
  document.getElementById('pf-name').value = S.profile.name || u.name;
  document.getElementById('pf-currency').value = S.currency;

  document.getElementById('auth-screen').classList.remove('active');
  document.getElementById('app-screen').classList.add('active');

  // Set today's date as default for expense form
  document.getElementById('e-date').value = new Date().toISOString().split('T')[0];

  renderAll();
  goTo('dashboard');
}

// Check for existing session on load
window.addEventListener('load', () => {
  const session = sessionStorage.getItem('se_session');
  if(session && DB.getUsers()[session]) {
    initApp(session);
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll() {
  renderStats();
  renderDashExpenses();
  renderSidebarGroups();
  renderGroups();
  renderExpenses();
  renderBalances();
  renderActivity();
  renderChart();
  renderProfile();
  populateExpForm();
}

function C(v) { return `${S.currency}${Math.abs(v).toFixed(2)}`; }

function renderStats() {
  const owed = S.expenses.filter(e=>!e.settled && e.share==='owed').reduce((s,e)=>s+e.shareAmt,0);
  const owe  = S.expenses.filter(e=>!e.settled && e.share==='owe').reduce((s,e)=>s+e.shareAmt,0);
  const spent = S.expenses.reduce((s,e)=>s+e.amount,0);
  document.getElementById('s-owed').textContent = C(owed);
  document.getElementById('s-owe').textContent = C(owe);
  document.getElementById('s-spent').textContent = C(spent);
  document.getElementById('s-groups').textContent = S.groups.length;
  const oweBadge = document.getElementById('owe-badge');
  const oweCount = S.expenses.filter(e=>!e.settled&&e.share==='owe').length;
  oweBadge.textContent = oweCount;
  oweBadge.style.display = oweCount > 0 ? 'inline' : 'none';
}

function renderChart() {
  const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const today = new Date();
  const vals = days.map((_,i) => {
    const d = new Date(today);
    d.setDate(today.getDate() - (6-i));
    const ds = d.toISOString().split('T')[0];
    return S.expenses.filter(e=>e.date===ds).reduce((s,e)=>s+e.amount,0);
  });
  const max = Math.max(...vals, 1);
  const colors = ['#4fffb0','#a78bfa','#ffc94d','#ff5e6c','#60a5fa','#4fffb0','#a78bfa'];
  document.getElementById('spend-chart').innerHTML = vals.map((v,i)=>
    `<div class="bar" style="height:${(v/max)*100}%;background:${colors[i]};opacity:0.75" title="${C(v)}"></div>`
  ).join('');
  document.getElementById('chart-labels').innerHTML = days.map(d=>`<span>${d}</span>`).join('');
}

function expHTML(e, showDel=true) {
  const catIcon = e.category.split(' ')[0];
  const catColors = {'üçï':'rgba(255,94,108,0.15)','üöó':'rgba(79,255,176,0.12)','üè†':'rgba(63,185,80,0.12)',
    'üéâ':'rgba(255,201,77,0.15)','üõç':'rgba(167,139,250,0.15)','üè•':'rgba(255,94,108,0.12)',
    '‚úàÔ∏è':'rgba(96,165,250,0.15)','üìö':'rgba(167,139,250,0.12)','üì¶':'rgba(107,122,153,0.12)'};
  const bg = catColors[catIcon] || 'rgba(107,122,153,0.12)';
  const grpName = e.groupId ? (S.groups.find(g=>g.id===e.groupId)?.name || 'Unknown') : 'Personal';
  const shareClass = e.settled ? 'settled-txt' : e.share==='owe' ? 'you-owe' : e.share==='owed' ? 'owed-you' : 'settled-txt';
  const shareText = e.settled ? '‚úì Settled' : e.share==='owe' ? `You owe ${C(e.shareAmt)}` : e.share==='owed' ? `Lent ${C(e.shareAmt)}` : 'Personal';
  return `<div class="exp-item">
    <div class="exp-ico" style="background:${bg}">${catIcon}</div>
    <div class="exp-info">
      <div class="exp-desc">${esc(e.desc)}</div>
      <div class="exp-meta">${e.paidBy==='me'?'You':esc(e.paidBy)} ‚Ä¢ ${esc(grpName)} ‚Ä¢ ${fmtDate(e.date)}</div>
    </div>
    <div class="exp-right">
      <div class="exp-total">${C(e.amount)}</div>
      <div class="exp-share ${shareClass}">${shareText}</div>
    </div>
    ${showDel ? `<div class="exp-actions">
      <button class="icon-btn" onclick="editExp('${e.id}')" title="Edit">‚úèÔ∏è</button>
      <button class="icon-btn del" onclick="promptDelExp('${e.id}')" title="Delete">üóë</button>
    </div>` : ''}
  </div>`;
}

function renderDashExpenses() {
  const sorted = [...S.expenses].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
  document.getElementById('dash-exps').innerHTML = sorted.length
    ? sorted.map(e=>expHTML(e)).join('')
    : `<div class="empty"><span class="empty-icon">üí∏</span><h3>No expenses yet</h3><p>Add your first expense to get started</p></div>`;
}

function renderSidebarGroups() {
  const colMap = {teal:'#4fffb0',red:'#ff5e6c',purple:'#a78bfa',yellow:'#ffc94d',blue:'#60a5fa'};
  document.getElementById('sidebar-groups-list').innerHTML = S.groups.map(g =>
    `<div class="nav-item" onclick="goTo('groups')">
      <div class="group-dot" style="background:${colMap[g.color]||'#4fffb0'}"></div>
      <span style="flex:1;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(g.name)}</span>
      <button class="leave-btn" onclick="event.stopPropagation();promptExit(${g.id})" title="Leave">‚úï</button>
    </div>`
  ).join('');
}

function renderGroups() {
  document.getElementById('grp-count-txt').textContent = S.groups.length
    ? `${S.groups.length} group${S.groups.length>1?'s':''}`
    : 'Create your first group';
  document.getElementById('groups-grid').innerHTML = S.groups.length
    ? S.groups.map(g => {
        const bal = S.expenses.filter(e=>e.groupId===g.id&&!e.settled)
          .reduce((s,e)=>s+(e.share==='owed'?e.shareAmt:e.share==='owe'?-e.shareAmt:0),0);
        return `<div class="group-card gc-${g.color}">
          <div class="group-emoji">${g.type.split(' ')[0]}</div>
          <div class="group-name">${esc(g.name)}</div>
          <div class="group-members">${g.members.length} member${g.members.length>1?'s':''}: ${g.members.slice(0,2).map(esc).join(', ')}${g.members.length>2?'‚Ä¶':''}</div>
          <div class="group-bal" style="color:${bal>=0?'var(--green)':'var(--red)'}">${bal>=0?'+':''}${C(bal)}</div>
          <div class="group-actions">
            <button class="btn btn-ghost btn-sm" onclick="openModal('exp-modal');setExpGroup(${g.id})" style="flex:1">+ Expense</button>
            <button class="btn btn-danger btn-sm" onclick="promptExit(${g.id})">Leave</button>
          </div>
        </div>`;
      }).join('')
    : `<div class="empty" style="grid-column:1/-1"><span class="empty-icon">üë•</span><h3>No groups yet</h3><p>Create a group to split expenses with friends</p></div>`;
}

function renderExpenses() {
  let exps = [...S.expenses].sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(S.expFilter==='owe') exps = exps.filter(e=>e.share==='owe'&&!e.settled);
  else if(S.expFilter==='owed') exps = exps.filter(e=>e.share==='owed'&&!e.settled);
  else if(S.expFilter==='settled') exps = exps.filter(e=>e.settled);
  document.getElementById('exp-count-txt').textContent = `${exps.length} transaction${exps.length!==1?'s':''}`;
  document.getElementById('all-exps').innerHTML = exps.length
    ? exps.map(e=>expHTML(e)).join('')
    : `<div class="empty"><span class="empty-icon">üìã</span><h3>Nothing here</h3><p>No expenses match this filter</p></div>`;
}

function filterExps(el, f) {
  S.expFilter = f;
  document.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  renderExpenses();
}

function renderBalances() {
  // Compute per-person balances from expenses
  const map = {};
  S.expenses.filter(e=>!e.settled&&e.share!=='none').forEach(e=>{
    const p = e.paidBy==='me' ? (e.share==='owed'?null:e.paidBy) : e.paidBy;
    if(e.share==='owe') {
      map[e.paidBy] = (map[e.paidBy]||0) + e.shareAmt; // they paid, you owe them
    } else if(e.share==='owed') {
      map[e.paidBy==='me'?e.paidBy:'others'] = (map[e.paidBy==='me'?e.paidBy:'others']||0) - e.shareAmt;
    }
  });

  // Build from expenses: who you owe / who owes you
  const people = {};
  S.expenses.filter(e=>!e.settled).forEach(e=>{
    if(e.share==='owe' && e.paidBy!=='me') {
      people[e.paidBy] = (people[e.paidBy]||0) - e.shareAmt;
    } else if(e.share==='owed' && e.paidBy==='me') {
      // need a person name ‚Äî from group members
      const grp = S.groups.find(g=>g.id===e.groupId);
      if(grp) {
        const others = grp.members.filter(m=>m!=='You'&&m!=='me');
        const share = e.shareAmt / Math.max(others.length,1);
        others.forEach(m=>{ people[m]=(people[m]||0)+share; });
      }
    }
  });

  const entries = Object.entries(people).filter(([,v])=>Math.abs(v)>0.01);
  const avatarColors = ['#4fffb0','#a78bfa','#ffc94d','#ff5e6c','#60a5fa'];

  document.getElementById('bal-list').innerHTML = entries.length
    ? entries.map(([name,amt],i) => {
        const initials = name.split(' ').map(n=>n[0].toUpperCase()).join('').substring(0,2);
        const col = avatarColors[i%avatarColors.length];
        return `<div class="bal-item">
          <div class="bal-avatar" style="background:${col}22;color:${col}">${initials}</div>
          <div class="bal-info">
            <div class="bal-name">${esc(name)}</div>
            <div class="bal-status" style="color:${amt>0?'var(--green)':'var(--red)'}">${amt>0?'Owes you':'You owe'}</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px">
            <div class="bal-amount" style="color:${amt>0?'var(--green)':'var(--red)'}">${amt>0?'+':''}${C(amt)}</div>
            ${amt<0?`<button class="settle-btn" onclick="settleUp('${esc(name)}',${Math.abs(amt).toFixed(2)})">Settle Up</button>`:''}
          </div>
        </div>`;
      }).join('')
    : `<div class="empty"><span class="empty-icon">‚öñÔ∏è</span><h3>All settled!</h3><p>No outstanding balances ‚Äî you're all good</p></div>`;
}

function renderActivity() {
  document.getElementById('act-list').innerHTML = S.activity.length
    ? S.activity.slice(0,20).map(a=>`
      <div class="act-item">
        <div class="act-dot" style="background:${a.color}"></div>
        <div>
          <div class="act-text">${a.text}</div>
          <div class="act-time">${a.time}</div>
        </div>
      </div>`).join('')
    : `<div class="empty"><span class="empty-icon">üîî</span><h3>No activity</h3><p>Your actions will appear here</p></div>`;
}

function renderProfile() {
  document.getElementById('prof-exp-count').textContent = S.expenses.length;
  document.getElementById('prof-grp-count').textContent = S.groups.length;
  document.getElementById('prof-spent').textContent = C(S.expenses.reduce((s,e)=>s+e.amount,0));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPENSES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function populateExpForm() {
  const sel = document.getElementById('e-grp');
  sel.innerHTML = '<option value="">-- Personal --</option>' +
    S.groups.map(g=>`<option value="${g.id}">${esc(g.name)}</option>`).join('');
}

function setExpGroup(id) {
  document.getElementById('e-grp').value = id;
  updatePaidByOptions(id);
}

document.addEventListener('change', e => {
  if(e.target.id === 'e-grp') updatePaidByOptions(e.target.value);
});

function updatePaidByOptions(groupId) {
  const pb = document.getElementById('e-paid');
  const grp = S.groups.find(g=>g.id==groupId);
  if(grp) {
    pb.innerHTML = '<option value="me">You</option>' +
      grp.members.filter(m=>m!=='You').map(m=>`<option value="${esc(m)}">${esc(m)}</option>`).join('');
  } else {
    pb.innerHTML = '<option value="me">You</option>';
  }
}

function setSplit(el, type) {
  S.selectedSplit = type;
  document.querySelectorAll('.split-opt').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
}

function editExp(id) {
  const e = S.expenses.find(x=>x.id===id);
  if(!e) return;
  S.editExpId = id;
  document.getElementById('exp-modal-title').textContent = 'Edit Expense';
  document.getElementById('save-exp-btn').textContent = 'Save Changes';
  document.getElementById('e-desc').value = e.desc;
  document.getElementById('e-amt').value = e.amount;
  document.getElementById('e-cat').value = e.category;
  document.getElementById('e-grp').value = e.groupId || '';
  updatePaidByOptions(e.groupId);
  document.getElementById('e-paid').value = e.paidBy;
  document.getElementById('e-date').value = e.date;
  document.getElementById('e-notes').value = e.notes || '';
  openModal('exp-modal');
}

function saveExpense() {
  const desc = document.getElementById('e-desc').value.trim();
  const amt = parseFloat(document.getElementById('e-amt').value);
  const cat = document.getElementById('e-cat').value;
  const groupId = document.getElementById('e-grp').value ? parseInt(document.getElementById('e-grp').value) : null;
  const paidBy = document.getElementById('e-paid').value;
  const date = document.getElementById('e-date').value || new Date().toISOString().split('T')[0];
  const notes = document.getElementById('e-notes').value;

  if(!desc) return toast('‚ö†Ô∏è Please enter a description');
  if(!amt || amt <= 0) return toast('‚ö†Ô∏è Enter a valid amount');

  // Compute split
  let share = 'none', shareAmt = 0;
  const grp = groupId ? S.groups.find(g=>g.id===groupId) : null;
  const memberCount = grp ? grp.members.length : 2;

  if(S.selectedSplit === 'no-split') {
    share = 'none'; shareAmt = amt;
  } else if(paidBy === 'me') {
    share = 'owed'; shareAmt = +(amt * (memberCount-1) / memberCount).toFixed(2);
  } else {
    share = 'owe'; shareAmt = +(amt / memberCount).toFixed(2);
  }
  if(S.selectedSplit === 'you-paid') { share = 'owed'; shareAmt = +(amt * (memberCount-1)/memberCount).toFixed(2); }

  if(S.editExpId) {
    const idx = S.expenses.findIndex(e=>e.id===S.editExpId);
    if(idx>-1) { S.expenses[idx] = {...S.expenses[idx], desc, amount:amt, category:cat, groupId, paidBy, date, notes, share, shareAmt}; }
    addActivity(`You updated expense <strong>${desc}</strong>`, '#ffc94d');
    toast('‚úÖ Expense updated!');
  } else {
    const exp = { id: uid(), desc, amount:amt, category:cat, groupId, paidBy, date, notes, share, shareAmt, settled:false, created: new Date().toISOString() };
    S.expenses.unshift(exp);
    addActivity(`You added <strong>${desc}</strong> ‚Äî ${C(amt)}`, '#4fffb0');
    toast('‚úÖ Expense added!');
  }

  DB.saveExpenses(S.user, S.expenses);
  DB.saveActivity(S.user, S.activity);
  resetExpForm();
  closeModal('exp-modal');
  renderAll();
}

function resetExpForm() {
  S.editExpId = null;
  document.getElementById('exp-modal-title').textContent = 'Add Expense';
  document.getElementById('save-exp-btn').textContent = 'Add Expense';
  document.getElementById('e-desc').value = '';
  document.getElementById('e-amt').value = '';
  document.getElementById('e-notes').value = '';
  document.getElementById('e-date').value = new Date().toISOString().split('T')[0];
  document.getElementById('e-grp').value = '';
  document.getElementById('e-paid').value = 'me';
  setSplit(document.querySelector('.split-opt'), 'equal');
}

function promptDelExp(id) { S.delExpId = id; openModal('del-exp-modal'); }
function confirmDelExp() {
  const e = S.expenses.find(x=>x.id===S.delExpId);
  S.expenses = S.expenses.filter(x=>x.id!==S.delExpId);
  DB.saveExpenses(S.user, S.expenses);
  addActivity(`You deleted expense <strong>${e?.desc||'expense'}</strong>`, '#ff5e6c');
  DB.saveActivity(S.user, S.activity);
  closeModal('del-exp-modal');
  renderAll();
  toast('üóë Expense deleted');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GROUPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let newMembers = [];

function onMemberKey(e) {
  if(e.key === 'Enter' || e.key === ',') {
    e.preventDefault();
    const val = e.target.value.trim().replace(',','');
    if(!val) return;
    newMembers.push(val);
    const tag = document.createElement('div');
    tag.className = 'member-tag';
    tag.dataset.name = val;
    tag.innerHTML = `${esc(val)} <span class="rm" onclick="removeMember(this)">‚úï</span>`;
    document.getElementById('member-area').insertBefore(tag, e.target);
    e.target.value = '';
  }
}
function removeMember(el) {
  const tag = el.parentElement;
  newMembers = newMembers.filter(m=>m!==tag.dataset.name);
  tag.remove();
}
function pickColor(c) {
  S.selectedColor = c;
  ['teal','red','purple','yellow','blue'].forEach(col => {
    document.getElementById(`cd-${col}`).classList.toggle('active', col===c);
  });
}
function saveGroup() {
  const name = document.getElementById('g-name').value.trim();
  const type = document.getElementById('g-type').value;
  if(!name) return toast('‚ö†Ô∏è Group name is required');
  const grp = { id: Date.now(), name, type, color: S.selectedColor, members: ['You', ...newMembers], created: new Date().toISOString() };
  S.groups.push(grp);
  DB.saveGroups(S.user, S.groups);
  addActivity(`You created group <strong>${name}</strong>`, '#a78bfa');
  DB.saveActivity(S.user, S.activity);
  newMembers = [];
  document.getElementById('member-area').querySelectorAll('.member-tag').forEach(t=>t.remove());
  document.getElementById('g-name').value = '';
  closeModal('grp-modal');
  renderAll();
  toast(`‚úÖ Group "${name}" created!`);
}
function promptExit(id) {
  S.exitGroupId = id;
  const g = S.groups.find(g=>g.id===id);
  document.getElementById('exit-grp-name').textContent = g?.name || '';
  openModal('exit-modal');
}
function confirmExit() {
  const g = S.groups.find(g=>g.id===S.exitGroupId);
  S.groups = S.groups.filter(g=>g.id!==S.exitGroupId);
  DB.saveGroups(S.user, S.groups);
  addActivity(`You left group <strong>${g?.name}</strong>`, '#ff5e6c');
  DB.saveActivity(S.user, S.activity);
  closeModal('exit-modal');
  renderAll();
  toast(`üëã Left group "${g?.name}"`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SETTLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function settleUp(person, amount) {
  S.settleTarget = { person, amount };
  document.getElementById('settle-content').innerHTML = `
    <div style="background:rgba(79,255,176,0.06);border:1px solid rgba(79,255,176,0.2);border-radius:12px;padding:20px;text-align:center">
      <div style="font-size:13px;color:var(--muted);margin-bottom:6px">You owe</div>
      <div style="font-size:20px;font-weight:700;margin-bottom:4px">${esc(person)}</div>
      <div style="font-size:32px;font-weight:700;font-family:var(--mono);color:var(--green)">${C(amount)}</div>
    </div>`;
  openModal('settle-modal');
}
function confirmSettle() {
  if(!S.settleTarget) return;
  const { person, amount } = S.settleTarget;
  // Mark relevant expenses as settled
  S.expenses.forEach(e => {
    if(!e.settled && e.share==='owe' && e.paidBy===person) e.settled = true;
  });
  DB.saveExpenses(S.user, S.expenses);
  addActivity(`You settled ${C(amount)} with <strong>${person}</strong>`, '#4fffb0');
  DB.saveActivity(S.user, S.activity);
  closeModal('settle-modal');
  renderAll();
  toast(`‚úÖ Settled with ${person}!`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveProfile() {
  const name = document.getElementById('pf-name').value.trim();
  const currency = document.getElementById('pf-currency').value;
  if(!name) return toast('‚ö†Ô∏è Name cannot be empty');
  S.profile = { ...S.profile, name, currency };
  S.currency = currency;
  DB.saveProfile(S.user, S.profile);
  // Update users registry name
  const users = DB.getUsers();
  users[S.user].name = name;
  users[S.user].initials = name.split(' ').filter(Boolean).map(n=>n[0].toUpperCase()).slice(0,2).join('');
  DB.saveUsers(users);
  document.getElementById('prof-name').textContent = name;
  document.getElementById('topbar-name').textContent = name.split(' ')[0];
  document.getElementById('topbar-avatar').textContent = users[S.user].initials;
  document.getElementById('prof-avatar').textContent = users[S.user].initials;
  renderAll();
  toast('‚úÖ Profile saved!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV() {
  const rows = [['Date','Description','Category','Amount','Paid By','Group','Your Share','Status']];
  S.expenses.forEach(e => {
    const grp = e.groupId ? (S.groups.find(g=>g.id===e.groupId)?.name||'?') : 'Personal';
    const status = e.settled ? 'Settled' : e.share==='owe' ? 'You Owe' : e.share==='owed' ? 'Owed To You' : 'Personal';
    rows.push([e.date,e.desc,e.category,e.amount,e.paidBy==='me'?'You':e.paidBy,grp,e.shareAmt,status]);
  });
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
  a.download = `splitease-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  toast('üì§ CSV exported!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goTo(page) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById(`page-${page}`)?.classList.add('active');
  document.getElementById(`nav-${page}`)?.classList.add('active');
  if(page==='expenses') renderExpenses();
  if(page==='groups') renderGroups();
  if(page==='balances') renderBalances();
  if(page==='activity') renderActivity();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) {
  if(id==='exp-modal') { populateExpForm(); if(!S.editExpId) resetExpForm(); }
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  if(id==='exp-modal') resetExpForm();
}
document.querySelectorAll('.overlay').forEach(o => {
  o.addEventListener('click', e => { if(e.target===o) o.classList.remove('open'); });
});
document.addEventListener('keydown', e => {
  if(e.key==='Escape') document.querySelectorAll('.overlay.open').forEach(o=>o.classList.remove('open'));
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addActivity(text, color='#4fffb0') {
  S.activity.unshift({ text, color, time: 'Just now' });
  if(S.activity.length > 50) S.activity = S.activity.slice(0,50);
}
function toast(msg, dur=3000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(t._t);
  t._t = setTimeout(()=>t.classList.remove('show'), dur);
}
function uid() { return Math.random().toString(36).substring(2,9) + Date.now().toString(36); }
function now() { return new Date().toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}); }
function fmtDate(d) { return new Date(d+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); }
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>

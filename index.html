<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SplitEase — Split Expenses Effortlessly</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<!-- EmailJS for OTP -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07090f;--surface:#0f1318;--surface2:#161c26;--surface3:#1e2535;
  --border:#252d3d;--accent:#4fffb0;--accent-dim:rgba(79,255,176,0.12);
  --accent-glow:rgba(79,255,176,0.25);--red:#ff5e6c;--red-dim:rgba(255,94,108,0.12);
  --yellow:#ffc94d;--purple:#a78bfa;--blue:#60a5fa;--text:#e8eef8;
  --muted:#6b7a99;--muted2:#3d4a63;--green:#4fffb0;--radius:14px;
  --font:'Sora',sans-serif;--mono:'Space Mono',monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
::selection{background:var(--accent-dim);color:var(--accent)}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

/* SCREENS */
.screen{display:none;min-height:100vh;animation:fadeIn 0.3s ease}
.screen.active{display:flex;flex-direction:column}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes spin{to{transform:rotate(360deg)}}

/* AUTH */
#auth-screen{
  background:radial-gradient(ellipse 80% 60% at 50% -20%,rgba(79,255,176,0.07) 0%,transparent 60%),
             radial-gradient(ellipse 60% 40% at 80% 80%,rgba(167,139,250,0.05) 0%,transparent 50%),var(--bg);
  align-items:center;justify-content:center;padding:20px;
}
.auth-wrap{width:100%;max-width:400px}
.brand{text-align:center;margin-bottom:36px}
.brand-icon{width:56px;height:56px;border-radius:18px;margin:0 auto 14px;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 0 40px var(--accent-glow)}
.brand-name{font-size:28px;font-weight:800;letter-spacing:-0.5px}
.brand-name span{color:var(--accent)}
.brand-tag{font-size:13px;color:var(--muted);margin-top:4px}
.auth-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:32px;box-shadow:0 30px 80px rgba(0,0,0,0.6);animation:slideUp 0.4s ease}
.auth-title{font-size:20px;font-weight:700;margin-bottom:6px}
.auth-sub{font-size:13px;color:var(--muted);margin-bottom:24px}
.form-group{margin-bottom:16px}
label{display:block;font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.6px;margin-bottom:8px}
input[type=email],input[type=password],input[type=text],input[type=number],select,textarea{
  width:100%;padding:12px 14px;background:var(--surface2);border:1px solid var(--border);
  border-radius:10px;color:var(--text);font-family:var(--font);font-size:14px;outline:none;
  transition:border-color 0.2s,box-shadow 0.2s;
}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
input::placeholder,textarea::placeholder{color:var(--muted2)}
.input-error{border-color:var(--red)!important;box-shadow:0 0 0 3px var(--red-dim)!important}
.error-msg{font-size:12px;color:var(--red);margin-top:6px;display:none}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 18px;border-radius:10px;border:none;cursor:pointer;font-family:var(--font);font-size:14px;font-weight:600;transition:all 0.2s;text-decoration:none;white-space:nowrap;position:relative;overflow:hidden}
.btn::before{content:'';position:absolute;inset:0;background:rgba(255,255,255,0.06);transform:scaleX(0);transform-origin:left;transition:transform 0.3s ease}
.btn:hover::before{transform:scaleX(1)}
.btn-primary{background:var(--accent);color:#07090f;width:100%;font-size:15px;padding:13px}
.btn-primary:hover{background:#3de89e;box-shadow:0 8px 30px var(--accent-glow);transform:translateY(-1px)}
.btn-primary:active{transform:translateY(0)}
.btn-primary::before{background:rgba(255,255,255,0.1)}
.btn-ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
.btn-ghost:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.btn-danger{background:var(--red-dim);color:var(--red);border:1px solid rgba(255,94,108,0.3)}
.btn-danger:hover{background:rgba(255,94,108,0.2)}
.btn-sm{padding:8px 14px;font-size:13px;border-radius:8px}
.auth-toggle{text-align:center;margin-top:18px;font-size:13px;color:var(--muted)}
.auth-toggle a{color:var(--accent);cursor:pointer;font-weight:600}
.auth-toggle a:hover{text-decoration:underline}
.divider{display:flex;align-items:center;gap:10px;margin:18px 0;color:var(--muted2);font-size:12px}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}

/* APP LAYOUT */
#app-screen{flex-direction:column;background:var(--bg)}
.topbar{background:rgba(15,19,24,0.95);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:0 24px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.topbar-left{display:flex;align-items:center;gap:8px}
.topbar-logo-wrap{display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 8px;border-radius:10px;transition:background 0.2s;user-select:none}
.topbar-logo-wrap:hover{background:var(--surface2)}
.topbar-icon{width:30px;height:30px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.topbar-brand{font-size:17px;font-weight:800;letter-spacing:-0.3px}
.topbar-brand span{color:var(--accent)}
.topbar-right{display:flex;align-items:center;gap:10px}
.user-pill{display:flex;align-items:center;gap:8px;padding:5px 12px 5px 5px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;cursor:pointer;transition:all 0.2s}
.user-pill:hover{border-color:var(--accent);transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,0.3)}
.avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#07090f;flex-shrink:0}
.avatar-lg{width:54px;height:54px;border-radius:50%;font-size:18px;font-weight:700}
.user-name{font-size:13px;font-weight:600}
.mob-back-btn{display:none;background:var(--surface2);border:1px solid var(--border);color:var(--text);width:36px;height:36px;border-radius:10px;cursor:pointer;align-items:center;justify-content:center;transition:all 0.2s;flex-shrink:0}
.mob-back-btn:hover{border-color:var(--accent);color:var(--accent)}
.mob-back-btn.visible{display:flex}
.mob-menu-btn{display:none;background:var(--surface2);border:1px solid var(--border);width:36px;height:36px;border-radius:10px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:4px;transition:all 0.2s;flex-shrink:0}
.mob-menu-btn span{display:block;width:16px;height:2px;background:var(--text);border-radius:2px;transition:all 0.3s}
.mob-menu-btn.open span:nth-child(1){transform:translateY(6px) rotate(45deg)}
.mob-menu-btn.open span:nth-child(2){opacity:0;transform:scaleX(0)}
.mob-menu-btn.open span:nth-child(3){transform:translateY(-6px) rotate(-45deg)}
.mob-menu-btn:hover{border-color:var(--accent)}

/* SIDEBAR */
.app-body{display:flex;flex:1;overflow:hidden;height:calc(100vh - 60px)}
.sidebar{width:256px;background:var(--surface);border-right:1px solid var(--border);padding:16px 10px;display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0}
.sidebar-section{font-size:10px;font-weight:700;color:var(--muted2);text-transform:uppercase;letter-spacing:1px;padding:10px 10px 4px}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:9px;cursor:pointer;transition:all 0.15s;font-size:13px;color:var(--muted);font-weight:500;position:relative;margin-bottom:1px;overflow:hidden}
.nav-item::after{content:'';position:absolute;left:0;top:0;height:100%;width:3px;background:var(--accent);border-radius:0 3px 3px 0;transform:scaleY(0);transition:transform 0.2s cubic-bezier(0.34,1.56,0.64,1)}
.nav-item:hover::after,.nav-item.active::after{transform:scaleY(1)}
.nav-item:hover{background:var(--surface2);color:var(--text)}
.nav-item.active{background:var(--accent-dim);color:var(--accent);font-weight:600}
.nav-item .nav-icon{font-size:15px;width:20px;text-align:center;flex-shrink:0;transition:transform 0.2s ease}
.nav-item:hover .nav-icon{transform:scale(1.2)}
.nav-item .nav-badge{margin-left:auto;background:var(--red);color:white;border-radius:10px;padding:2px 6px;font-size:10px;font-weight:700;min-width:18px;text-align:center}
.group-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.nav-item .leave-btn{margin-left:auto;display:none;background:none;border:none;color:var(--red);cursor:pointer;font-size:12px;padding:3px 5px;border-radius:5px}
.nav-item:hover .leave-btn{display:inline}
.sidebar-bottom{margin-top:auto;padding-top:12px;border-top:1px solid var(--border)}

/* MAIN */
.main{flex:1;overflow-y:auto;padding:28px}
.page{display:none;animation:slideUp 0.3s ease}
.page.active{display:block}
.page-head{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px;gap:12px;flex-wrap:wrap}
.page-title{font-size:22px;font-weight:800;letter-spacing:-0.3px}
.page-sub{font-size:13px;color:var(--muted);margin-top:3px}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:24px}
.stat{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:all 0.2s;position:relative;overflow:hidden;cursor:default}
.stat::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(79,255,176,0.03),transparent);opacity:0;transition:opacity 0.3s}
.stat:hover::before{opacity:1}
.stat:hover{border-color:var(--accent);box-shadow:0 0 0 1px rgba(79,255,176,0.15);transform:translateY(-2px)}
.stat-label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
.stat-val{font-size:26px;font-weight:700;font-family:var(--mono)}
.stat-val.green{color:var(--green)}
.stat-val.red{color:var(--red)}
.stat-val.blue{color:var(--blue)}
.stat-val.purple{color:var(--purple)}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:14px}
.card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card-title{font-size:14px;font-weight:700}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}

/* TABS */
.tabs{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
.tab{padding:7px 14px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s}
.tab:hover{border-color:var(--accent);color:var(--accent)}
.tab.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}

/* EXPENSE LIST */
.exp-list{display:flex;flex-direction:column;gap:8px}
.exp-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;display:flex;align-items:flex-start;gap:12px;transition:border-color 0.15s,transform 0.15s;cursor:default;position:relative}
.exp-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:2px;background:linear-gradient(180deg,var(--accent),var(--purple));transform:scaleY(0);transition:transform 0.25s cubic-bezier(0.34,1.56,0.64,1);border-radius:0 2px 2px 0}
.exp-item:hover::before{transform:scaleY(1)}
.exp-item:hover{border-color:rgba(79,255,176,0.3)}
.exp-item:hover .exp-ico{transform:scale(1.1) rotate(-5deg)}
.exp-ico{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;transition:transform 0.25s cubic-bezier(0.34,1.56,0.64,1)}
.exp-info{flex:1;min-width:0}
.exp-desc{font-weight:600;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.exp-meta{font-size:12px;color:var(--muted);margin-top:2px}
.exp-right{text-align:right;flex-shrink:0}
.exp-total{font-weight:700;font-size:14px;font-family:var(--mono)}
.exp-share{font-size:12px;margin-top:2px}
.you-owe{color:var(--red)}
.owed-you{color:var(--green)}
.settled-txt{color:var(--muted)}
.exp-actions{display:flex;gap:4px;margin-left:4px;flex-shrink:0;align-items:flex-start}
.icon-btn{background:none;border:none;cursor:pointer;padding:6px;border-radius:6px;color:var(--muted);font-size:14px;transition:all 0.15s;transform:scale(1)}
.icon-btn:hover{background:var(--surface3);color:var(--text);transform:scale(1.2)}
.icon-btn.del:hover{color:var(--red);background:var(--red-dim)}

/* CAMERA BUTTON */
.camera-btn{background:none;border:none;cursor:pointer;padding:6px;border-radius:6px;color:var(--muted);font-size:15px;transition:all 0.2s;position:relative;display:flex;align-items:center;justify-content:center}
.camera-btn:hover{background:rgba(79,255,176,0.12);color:var(--accent);transform:scale(1.18)}
.camera-btn.has-receipt{color:var(--accent)}
.camera-btn.has-receipt::after{content:'';position:absolute;top:3px;right:3px;width:7px;height:7px;border-radius:50%;background:var(--accent);border:2px solid var(--bg);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.7;transform:scale(1.2)}}

/* RECEIPT BADGE */
.receipt-badge{display:inline-flex;align-items:center;gap:4px;background:rgba(79,255,176,0.1);color:var(--accent);border:1px solid rgba(79,255,176,0.25);border-radius:6px;padding:2px 8px;font-size:10px;font-weight:700;cursor:pointer;transition:all 0.15s;margin-top:4px}
.receipt-badge:hover{background:rgba(79,255,176,0.22);transform:scale(1.03)}

/* GROUPS */
.groups-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
.group-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
.group-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.group-card::after{content:'';position:absolute;inset:0;background:radial-gradient(circle at var(--mx,50%) var(--my,50%),rgba(79,255,176,0.06) 0%,transparent 60%);opacity:0;transition:opacity 0.3s;pointer-events:none}
.group-card:hover::after{opacity:1}
.group-card:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 12px 40px rgba(0,0,0,0.4)}
.gc-teal::before{background:linear-gradient(90deg,var(--accent),var(--purple))}
.gc-red::before{background:linear-gradient(90deg,var(--red),var(--yellow))}
.gc-purple::before{background:linear-gradient(90deg,var(--purple),var(--blue))}
.gc-yellow::before{background:linear-gradient(90deg,var(--yellow),var(--green))}
.gc-blue::before{background:linear-gradient(90deg,var(--blue),var(--accent))}
.group-emoji{font-size:26px;margin-bottom:10px}
.group-name{font-weight:700;font-size:15px;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.group-members{font-size:12px;color:var(--muted);margin-bottom:12px}
.group-bal{font-family:var(--mono);font-weight:700;font-size:17px}
.group-actions{display:flex;gap:6px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}

/* BALANCES */
.bal-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:8px;transition:all 0.2s}
.bal-item:hover{border-color:var(--accent);transform:translateX(4px);box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.bal-avatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0;transition:transform 0.2s}
.bal-item:hover .bal-avatar{transform:scale(1.1)}
.bal-info{flex:1}
.bal-name{font-weight:600;font-size:14px}
.bal-status{font-size:12px;margin-top:2px}
.bal-amount{font-family:var(--mono);font-weight:700;font-size:15px}
.settle-btn{padding:7px 13px;border-radius:8px;border:1px solid rgba(79,255,176,0.3);background:rgba(79,255,176,0.08);color:var(--accent);font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s;white-space:nowrap;position:relative;overflow:hidden}
.settle-btn::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(79,255,176,0.15),transparent);transform:translateX(-100%);transition:transform 0.6s ease}
.settle-btn:hover::after{transform:translateX(100%)}
.settle-btn:hover{background:rgba(79,255,176,0.18)}

/* ACTIVITY */
.act-item{display:flex;align-items:flex-start;gap:10px;padding:12px 0;border-bottom:1px solid var(--border)}
.act-item:last-child{border-bottom:none}
.act-dot{width:7px;height:7px;border-radius:50%;margin-top:5px;flex-shrink:0}
.act-text{font-size:13px;line-height:1.5;color:var(--muted)}
.act-text strong{color:var(--text)}
.act-time{font-size:11px;color:var(--muted2);margin-top:2px}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:200;display:flex;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(6px);opacity:0;pointer-events:none;transition:opacity 0.2s}
.overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:28px;width:100%;max-width:460px;transform:translateY(20px);transition:transform 0.25s;max-height:90vh;overflow-y:auto}
.overlay.open .modal{transform:translateY(0)}
.modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
.modal-title{font-size:17px;font-weight:700}
.close-x{background:var(--surface2);border:none;color:var(--muted);width:30px;height:30px;border-radius:7px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
.close-x:hover{color:var(--text);background:var(--surface3)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.split-row{display:flex;gap:8px;margin-bottom:14px}
.split-opt{flex:1;padding:9px;border:1px solid var(--border);border-radius:9px;background:transparent;color:var(--muted);cursor:pointer;font-family:var(--font);font-size:12px;font-weight:600;text-align:center;transition:all 0.15s}
.split-opt.active{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.color-row{display:flex;gap:8px;margin-top:4px}
.color-dot{width:26px;height:26px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.color-dot.active{border-color:var(--text);transform:scale(1.15)}
.member-area{min-height:44px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:8px;display:flex;flex-wrap:wrap;gap:6px;cursor:text;transition:border-color 0.2s}
.member-area:focus-within{border-color:var(--accent)}
.member-area input{background:transparent;border:none;outline:none;color:var(--text);font-family:var(--font);font-size:13px;min-width:120px;flex:1;padding:3px 4px}
.member-tag{display:flex;align-items:center;gap:5px;background:var(--accent-dim);color:var(--accent);border:1px solid rgba(79,255,176,0.3);border-radius:6px;padding:3px 8px;font-size:12px;font-weight:600}
.member-tag .rm{cursor:pointer;font-size:11px;opacity:0.7}
.member-tag .rm:hover{opacity:1}

/* EMPTY STATE */
.empty{text-align:center;padding:48px 20px;color:var(--muted)}
.empty-icon{font-size:40px;display:block;margin-bottom:12px;animation:float 3s ease-in-out infinite}

/* TOAST */
#toast{position:fixed;bottom:80px;right:24px;z-index:9999;background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px 18px;font-size:13px;display:flex;align-items:center;gap:8px;transform:translateY(80px);opacity:0;transition:all 0.3s;max-width:320px;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
#toast.show{transform:translateY(0);opacity:1}

/* PROFILE */
.profile-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:14px}
.profile-top{display:flex;align-items:center;gap:16px;margin-bottom:22px;padding-bottom:22px;border-bottom:1px solid var(--border)}

/* CHART */
.bar-chart{display:flex;align-items:flex-end;gap:5px;height:64px;padding-top:8px}
.bar{flex:1;border-radius:4px 4px 0 0;min-height:3px;transition:height 0.6s ease;cursor:default;position:relative}
.bar:hover::after{content:attr(title);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--surface3);border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-size:11px;white-space:nowrap;color:var(--text);pointer-events:none}
.chart-labels{display:flex;justify-content:space-between;margin-top:4px}
.chart-labels span{font-size:10px;color:var(--muted2);flex:1;text-align:center}

/* ── GROUP DETAIL ── */
#page-group-detail.page{display:none}
#page-group-detail.page.active{display:block}
.grp-detail-hero{position:relative;border-radius:20px;padding:32px;margin-bottom:20px;overflow:hidden;background:var(--surface);border:1px solid var(--border)}
.grp-detail-hero::before{content:'';position:absolute;inset:0;opacity:0.06;background:radial-gradient(ellipse 70% 80% at 10% 50%,var(--hero-color,#4fffb0),transparent)}
.grp-detail-hero-content{position:relative;z-index:1}
.grp-detail-back{display:inline-flex;align-items:center;gap:6px;font-size:13px;color:var(--muted);cursor:pointer;margin-bottom:20px;transition:color 0.2s,transform 0.2s;padding:6px 0}
.grp-detail-back:hover{color:var(--accent);transform:translateX(-3px)}
.grp-hero-top{display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:12px}
.grp-hero-left{display:flex;align-items:center;gap:16px}
.grp-hero-emoji{width:60px;height:60px;border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:28px;background:var(--surface2);border:1px solid var(--border);transition:transform 0.3s cubic-bezier(0.34,1.56,0.64,1);cursor:default}
.grp-hero-emoji:hover{transform:scale(1.1) rotate(-8deg)}
.grp-hero-name{font-size:24px;font-weight:800;letter-spacing:-0.5px;margin-bottom:4px}
.grp-hero-meta{font-size:13px;color:var(--muted)}
.grp-hero-right{display:flex;gap:8px;flex-wrap:wrap}
.grp-detail-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-top:24px;padding-top:24px;border-top:1px solid var(--border)}
.grp-detail-stat{text-align:center}
.grp-detail-stat-val{font-size:22px;font-weight:700;font-family:var(--mono)}
.grp-detail-stat-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-top:4px}
.grp-detail-body{display:grid;grid-template-columns:1fr 300px;gap:16px}
.members-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;height:fit-content;position:sticky;top:80px}
.members-panel-title{font-size:13px;font-weight:700;margin-bottom:14px}
.member-row{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);transition:all 0.2s;cursor:default}
.member-row:last-child{border-bottom:none;padding-bottom:0}
.member-row:hover{padding-left:4px}
.member-row-avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;transition:transform 0.2s}
.member-row:hover .member-row-avatar{transform:scale(1.1)}
.member-row-info{flex:1;min-width:0}
.member-row-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.member-row-role{font-size:11px;color:var(--muted);margin-top:1px}
.member-row-bal{font-family:var(--mono);font-size:13px;font-weight:700;flex-shrink:0}

/* EXPENSE TIMELINE */
.exp-timeline{position:relative}
.exp-timeline-item{display:flex;gap:12px;margin-bottom:12px;animation:slideUp 0.35s ease both}
.exp-timeline-item:nth-child(1){animation-delay:0.05s}
.exp-timeline-item:nth-child(2){animation-delay:0.1s}
.exp-timeline-item:nth-child(3){animation-delay:0.15s}
.timeline-connector{display:flex;flex-direction:column;align-items:center;width:40px;flex-shrink:0}
.timeline-dot{width:10px;height:10px;border-radius:50%;border:2px solid var(--accent);background:var(--bg);margin-top:14px;flex-shrink:0;transition:all 0.2s}
.exp-timeline-item:hover .timeline-dot{background:var(--accent);box-shadow:0 0 10px var(--accent-glow)}
.timeline-line{flex:1;width:1px;background:var(--border);margin-top:4px}
.exp-timeline-item:last-child .timeline-line{display:none}
.timeline-card{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;transition:all 0.25s cubic-bezier(0.34,1.56,0.64,1);cursor:default;position:relative;overflow:hidden}
.timeline-card::before{content:'';position:absolute;top:0;left:0;bottom:0;width:2px;background:linear-gradient(180deg,var(--accent),var(--purple));transform:scaleY(0);transition:transform 0.25s cubic-bezier(0.34,1.56,0.64,1)}
.timeline-card:hover{transform:translateX(4px) translateY(-1px);border-color:rgba(79,255,176,0.3);box-shadow:0 8px 24px rgba(0,0,0,0.3)}
.timeline-card:hover::before{transform:scaleY(1)}
.tc-top{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:8px}
.tc-desc{font-weight:600;font-size:14px}
.tc-amount{font-family:var(--mono);font-weight:700;font-size:15px;flex-shrink:0}
.tc-meta{font-size:12px;color:var(--muted);margin-bottom:8px}
.tc-splits{display:flex;flex-direction:column;gap:4px}
.tc-split-row{display:flex;align-items:center;justify-content:space-between;background:var(--surface2);border-radius:8px;padding:6px 10px;font-size:12px;transition:background 0.15s}
.tc-split-row:hover{background:var(--surface3)}
.tc-split-person{display:flex;align-items:center;gap:6px;font-weight:500}
.tc-split-amt{font-family:var(--mono);font-weight:600}
.tc-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:10px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;margin-left:5px}
.tc-badge-paid{background:rgba(79,255,176,0.15);color:var(--accent)}
.tc-badge-owed{background:rgba(255,94,108,0.15);color:var(--red)}
.tc-badge-settled{background:rgba(107,122,153,0.15);color:var(--muted)}
.tc-notes{font-size:11px;color:var(--muted);margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-style:italic}
.tc-actions{display:flex;gap:4px;margin-left:4px;flex-shrink:0}
.grp-empty{text-align:center;padding:48px 20px;color:var(--muted)}
.grp-empty-icon{font-size:40px;margin-bottom:12px;display:block;animation:float 3s ease-in-out infinite}

/* ── BILL RECEIPT STYLES ── */
/* Upload zone in modal */
.bill-upload-zone{border:2px dashed var(--border);border-radius:12px;padding:24px 16px;text-align:center;cursor:pointer;transition:all 0.25s;position:relative;overflow:hidden;background:var(--surface2)}
.bill-upload-zone:hover{border-color:var(--accent);background:var(--accent-dim)}
.bill-upload-zone.dragging{border-color:var(--accent);background:var(--accent-dim);transform:scale(1.01)}
.bill-upload-zone.has-image{padding:0;border-style:solid;border-color:var(--accent)}
.bill-upload-zone input[type=file]{display:none}
.bill-upload-icon{font-size:32px;margin-bottom:10px;display:block}
.bill-upload-label{font-size:13px;color:var(--text);font-weight:600}
.bill-upload-sub{font-size:11px;color:var(--muted);margin-top:4px}
.bill-preview-img{width:100%;max-height:220px;object-fit:cover;display:block;border-radius:10px}
.bill-preview-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:rgba(0,0,0,0.3);position:absolute;bottom:0;left:0;right:0}
.bill-preview-bar span{font-size:11px;color:rgba(255,255,255,0.85);font-weight:600}
/* Receipt in timeline */
.tc-receipt{margin-top:10px;border-radius:10px;overflow:hidden;cursor:pointer;border:1px solid var(--border);transition:all 0.2s;position:relative}
.tc-receipt:hover{border-color:var(--accent);box-shadow:0 4px 16px rgba(0,0,0,0.3)}
.tc-receipt img{width:100%;max-height:160px;object-fit:cover;display:block;transition:transform 0.3s}
.tc-receipt:hover img{transform:scale(1.02)}
.tc-receipt-label{position:absolute;bottom:0;left:0;right:0;padding:8px 12px;background:linear-gradient(transparent,rgba(0,0,0,0.75));font-size:11px;color:rgba(255,255,255,0.9);font-weight:600;display:flex;align-items:center;gap:5px}
/* Bill lightbox */
#bill-lightbox{position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.93);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;opacity:0;pointer-events:none;transition:opacity 0.25s;backdrop-filter:blur(10px);padding:20px}
#bill-lightbox.open{opacity:1;pointer-events:all}
#bill-lightbox img{max-width:100%;max-height:78vh;border-radius:16px;box-shadow:0 30px 80px rgba(0,0,0,0.7);transform:scale(0.9);transition:transform 0.35s cubic-bezier(0.34,1.56,0.64,1)}
#bill-lightbox.open img{transform:scale(1)}
.lb-close{position:absolute;top:16px;right:16px;background:rgba(255,255,255,0.12);border:none;color:white;width:38px;height:38px;border-radius:10px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:background 0.2s}
.lb-close:hover{background:rgba(255,255,255,0.22)}
.lb-info{color:var(--text);font-size:15px;font-weight:700;text-align:center}
.lb-meta{color:var(--muted);font-size:12px;text-align:center;margin-top:2px}
.lb-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

/* MOBILE */
.mob-bottom-nav{display:none;position:fixed;bottom:0;left:0;right:0;z-index:150;background:rgba(15,19,24,0.97);backdrop-filter:blur(16px);border-top:1px solid var(--border);height:64px;padding:0 8px;align-items:center;justify-content:space-around;box-shadow:0 -8px 30px rgba(0,0,0,0.4)}
.mob-bnav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;flex:1;padding:8px 4px;cursor:pointer;border-radius:10px;transition:all 0.2s;position:relative}
.mob-bnav-item:hover,.mob-bnav-item:active{background:var(--surface2)}
.mob-bnav-icon{font-size:20px;line-height:1;filter:grayscale(0.4) opacity(0.7);transition:all 0.2s}
.mob-bnav-item.active .mob-bnav-icon{filter:none;transform:translateY(-2px)}
.mob-bnav-label{font-size:10px;font-weight:600;color:var(--muted);transition:color 0.2s}
.mob-bnav-item.active .mob-bnav-label{color:var(--accent)}
.mob-bnav-center{flex:none;width:52px}
.mob-bnav-add{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--purple));display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:300;color:#07090f;box-shadow:0 4px 20px var(--accent-glow);transition:all 0.2s;transform:translateY(-8px)}
.mob-bnav-center:hover .mob-bnav-add{transform:translateY(-10px) scale(1.1)}
.mob-drawer-overlay{display:none;position:fixed;inset:0;z-index:160;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);opacity:0;transition:opacity 0.3s}
.mob-drawer{display:none;position:fixed;top:0;right:0;bottom:0;z-index:170;width:min(300px,85vw);background:var(--surface);border-left:1px solid var(--border);flex-direction:column;padding:0;overflow-y:auto;transform:translateX(100%);transition:transform 0.35s cubic-bezier(0.32,0.72,0,1);box-shadow:-20px 0 60px rgba(0,0,0,0.5)}
.mob-drawer.open{transform:translateX(0);display:flex}
.mob-drawer-head{display:flex;align-items:center;justify-content:space-between;padding:20px 18px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--surface);z-index:1}
.mob-drawer-user{display:flex;align-items:center;gap:12px;padding:16px 18px;border-bottom:1px solid var(--border);background:var(--surface2)}
.mob-drawer-nav{padding:8px 10px}
.mob-nav-item{display:flex;align-items:center;gap:12px;padding:11px 10px;border-radius:10px;cursor:pointer;font-size:14px;font-weight:500;color:var(--muted);transition:all 0.15s;margin-bottom:2px}
.mob-nav-item:hover,.mob-nav-item:active{background:var(--surface2);color:var(--text);padding-left:14px}
.mob-nav-item span{font-size:17px;width:22px;text-align:center;flex-shrink:0}
.mob-nav-section{font-size:10px;font-weight:700;color:var(--muted2);text-transform:uppercase;letter-spacing:1px;padding:10px 10px 4px}

/* ══════════════════════════════════════════
   ADMIN PANEL
══════════════════════════════════════════ */
#admin-screen{background:var(--bg);flex-direction:column}
.admin-login-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:radial-gradient(ellipse 70% 50% at 50% 0%,rgba(167,139,250,0.09) 0%,transparent 60%),var(--bg)}
.admin-login-card{width:100%;max-width:420px;background:var(--surface);border:1px solid rgba(167,139,250,0.3);border-radius:22px;padding:36px;box-shadow:0 30px 80px rgba(0,0,0,0.7),0 0 0 1px rgba(167,139,250,0.1);animation:slideUp 0.4s ease}
.admin-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(167,139,250,0.12);border:1px solid rgba(167,139,250,0.3);color:var(--purple);border-radius:20px;padding:6px 14px;font-size:12px;font-weight:700;letter-spacing:0.5px;margin-bottom:18px}
.admin-login-title{font-size:22px;font-weight:800;margin-bottom:6px}
.admin-login-sub{font-size:13px;color:var(--muted);margin-bottom:24px}
.admin-topbar{background:rgba(10,8,20,0.97);border-bottom:1px solid rgba(167,139,250,0.2);padding:0 24px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;backdrop-filter:blur(12px)}
.admin-topbar-brand{display:flex;align-items:center;gap:10px}
.admin-logo{width:32px;height:32px;border-radius:9px;background:linear-gradient(135deg,var(--purple),#60a5fa);display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 0 16px rgba(167,139,250,0.4)}
.admin-brand-text{font-size:16px;font-weight:800}
.admin-brand-text span{color:var(--purple)}
.admin-badge-top{background:rgba(167,139,250,0.15);border:1px solid rgba(167,139,250,0.3);color:var(--purple);border-radius:6px;padding:3px 9px;font-size:10px;font-weight:700;letter-spacing:0.8px;text-transform:uppercase}
.admin-body{display:flex;flex:1;min-height:calc(100vh - 60px)}
.admin-sidebar{width:230px;background:var(--surface);border-right:1px solid rgba(167,139,250,0.12);padding:16px 10px;display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.admin-nav-section{font-size:10px;font-weight:700;color:var(--muted2);text-transform:uppercase;letter-spacing:1px;padding:10px 10px 6px;margin-top:4px}
.admin-nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;transition:all 0.15s;font-size:13px;color:var(--muted);font-weight:500;margin-bottom:1px;position:relative}
.admin-nav-item:hover{background:rgba(167,139,250,0.08);color:var(--text)}
.admin-nav-item.active{background:rgba(167,139,250,0.12);color:var(--purple);font-weight:600}
.admin-nav-item.active::before{content:\'\';position:absolute;left:0;top:0;height:100%;width:3px;background:var(--purple);border-radius:0 3px 3px 0}
.admin-nav-icon{font-size:16px;width:22px;text-align:center;flex-shrink:0}
.admin-nav-badge{margin-left:auto;background:var(--red);color:white;border-radius:10px;padding:2px 6px;font-size:10px;font-weight:700}
.admin-main{flex:1;overflow-y:auto;padding:28px}
.admin-page{display:none;animation:slideUp 0.25s ease}
.admin-page.active{display:block}
.admin-page-title{font-size:22px;font-weight:800;margin-bottom:4px;letter-spacing:-0.3px}
.admin-page-sub{font-size:13px;color:var(--muted);margin-bottom:24px}
.admin-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:26px}
.admin-stat{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;position:relative;overflow:hidden;transition:all 0.2s;cursor:default}
.admin-stat:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,0.3)}
.admin-stat::after{content:\'\';position:absolute;top:0;right:0;bottom:0;width:3px}
.admin-stat.purple::after{background:var(--purple)}
.admin-stat.green::after{background:var(--green)}
.admin-stat.blue::after{background:var(--blue)}
.admin-stat.red::after{background:var(--red)}
.admin-stat.yellow::after{background:var(--yellow)}
.admin-stat-icon{font-size:22px;margin-bottom:10px}
.admin-stat-val{font-size:28px;font-weight:700;font-family:var(--mono);margin-bottom:4px}
.admin-stat-label{font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.admin-stat-sub{font-size:11px;color:var(--muted2);margin-top:3px}
.admin-table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.admin-table-head{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px}
.admin-table-title{font-size:14px;font-weight:700}
.admin-search{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:8px 12px;width:220px;transition:border-color 0.2s}
.admin-search:focus-within{border-color:var(--purple)}
.admin-search input{background:none;border:none;outline:none;color:var(--text);font-family:var(--font);font-size:13px;flex:1}
.admin-search input::placeholder{color:var(--muted2)}
table{width:100%;border-collapse:collapse}
thead tr{background:var(--surface2)}
th{padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;white-space:nowrap}
td{padding:13px 16px;font-size:13px;border-top:1px solid var(--border);vertical-align:middle}
tr:hover td{background:rgba(255,255,255,0.015)}
.user-cell{display:flex;align-items:center;gap:10px}
.user-cell-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0}
.user-cell-name{font-weight:600;font-size:13px}
.user-cell-email{font-size:11px;color:var(--muted);margin-top:1px}
.status-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700}
.status-active{background:rgba(79,255,176,0.12);color:var(--green);border:1px solid rgba(79,255,176,0.2)}
.status-banned{background:rgba(255,94,108,0.12);color:var(--red);border:1px solid rgba(255,94,108,0.2)}
.status-admin{background:rgba(167,139,250,0.15);color:var(--purple);border:1px solid rgba(167,139,250,0.25)}
.tbl-btn{background:none;border:1px solid var(--border);color:var(--muted);border-radius:7px;padding:5px 10px;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.15s;font-family:var(--font);white-space:nowrap}
.tbl-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.tbl-btn.danger:hover{border-color:var(--red);color:var(--red);background:var(--red-dim)}
.tbl-btn.purple-h:hover{border-color:var(--purple);color:var(--purple);background:rgba(167,139,250,0.1)}
.tbl-actions{display:flex;gap:5px;flex-wrap:wrap}
.admin-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:14px}
.admin-card-title{font-size:14px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.admin-act-item{display:flex;align-items:flex-start;gap:10px;padding:11px 0;border-bottom:1px solid var(--border)}
.admin-act-item:last-child{border-bottom:none}
.admin-act-dot{width:8px;height:8px;border-radius:50%;margin-top:4px;flex-shrink:0}
.admin-chart-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.admin-chart-label{width:90px;font-size:12px;color:var(--muted);text-align:right;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.admin-chart-bar-wrap{flex:1;background:var(--surface2);border-radius:6px;height:22px;overflow:hidden}
.admin-chart-bar{height:100%;border-radius:6px;transition:width 0.8s cubic-bezier(0.34,1.56,0.64,1);display:flex;align-items:center;padding-left:8px;font-size:10px;font-weight:700;color:#07090f}
.user-detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:14px 0}
.user-detail-item{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px}
.user-detail-label{font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:5px}
.user-detail-val{font-size:15px;font-weight:700;font-family:var(--mono)}
.broadcast-area{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;width:100%;min-height:90px;color:var(--text);font-family:var(--font);font-size:14px;outline:none;resize:vertical;transition:border-color 0.2s;display:block;box-sizing:border-box}
.broadcast-area:focus{border-color:var(--purple)}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border)}
.setting-row:last-child{border-bottom:none}
.setting-info{flex:1}
.setting-name{font-size:14px;font-weight:600}
.setting-desc{font-size:12px;color:var(--muted);margin-top:2px}
.toggle-switch{position:relative;width:42px;height:24px;flex-shrink:0}
.toggle-switch input{opacity:0;width:0;height:0;position:absolute}
.toggle-track{position:absolute;inset:0;background:var(--surface3);border-radius:12px;cursor:pointer;transition:background 0.2s;border:1px solid var(--border)}
.toggle-switch input:checked+.toggle-track{background:var(--purple);border-color:var(--purple)}
.toggle-track::after{content:\'\';position:absolute;width:18px;height:18px;background:white;border-radius:50%;top:2px;left:2px;transition:transform 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.3)}
.toggle-switch input:checked+.toggle-track::after{transform:translateX(18px)}
.admin-pagination{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)}
.admin-pagination-btns{display:flex;gap:5px}
.pg-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:7px;padding:5px 12px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s;font-family:var(--font)}
.pg-btn:hover{border-color:var(--purple);color:var(--purple)}
.pg-btn.active{background:rgba(167,139,250,0.15);border-color:var(--purple);color:var(--purple)}
.pg-btn:disabled{opacity:0.4;cursor:not-allowed}
@media(max-width:768px){.admin-sidebar{display:none}.admin-main{padding:16px}.admin-stats{grid-template-columns:1fr 1fr}.user-detail-grid{grid-template-columns:1fr}th:nth-child(3),td:nth-child(3),th:nth-child(4),td:nth-child(4){display:none}.admin-search{width:100%}}

/* ── INVITE & PARTICIPANTS ── */
.invite-btn{display:inline-flex;align-items:center;gap:7px;padding:8px 16px;background:linear-gradient(135deg,rgba(79,255,176,0.15),rgba(167,139,250,0.15));border:1px solid rgba(79,255,176,0.35);border-radius:10px;color:var(--accent);font-family:var(--font);font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden}
.invite-btn::before{content:'';position:absolute;inset:0;background:rgba(255,255,255,0.05);transform:scaleX(0);transform-origin:left;transition:transform 0.3s}
.invite-btn:hover::before{transform:scaleX(1)}
.invite-btn:hover{border-color:var(--accent);box-shadow:0 0 20px rgba(79,255,176,0.2);transform:translateY(-1px)}
.add-member-btn{background:var(--accent-dim);border:1px solid rgba(79,255,176,0.3);color:var(--accent);border-radius:8px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer;transition:all 0.15s;font-family:var(--font)}
.add-member-btn:hover{background:rgba(79,255,176,0.2)}
.add-member-row{display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
.add-member-row input{flex:1;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;color:var(--text);font-family:var(--font);font-size:13px;outline:none;transition:border-color 0.2s}
.add-member-row input:focus{border-color:var(--accent)}
.add-member-row button{padding:8px 13px;background:var(--accent);color:#07090f;border:none;border-radius:9px;font-weight:700;font-size:13px;cursor:pointer;transition:all 0.15s;font-family:var(--font);white-space:nowrap}
.add-member-row button:hover{background:#3de89e}
.member-row-remove{background:none;border:none;cursor:pointer;color:var(--muted2);font-size:13px;padding:4px;border-radius:5px;transition:all 0.15s;display:none;margin-left:4px;line-height:1}
.member-row:hover .member-row-remove{display:block}
.member-row-remove:hover{color:var(--red);background:var(--red-dim)}
.members-panel-title{font-size:13px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between}
/* Invite modal */
.invite-modal{max-width:480px}
.invite-link-box{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:14px 16px;display:flex;align-items:center;gap:10px;margin-bottom:14px;transition:border-color 0.2s}
.invite-link-box:hover{border-color:var(--accent)}
.invite-link-text{flex:1;font-family:var(--mono);font-size:12px;color:var(--accent);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:text;user-select:all}
.copy-link-btn{background:var(--accent);color:#07090f;border:none;border-radius:8px;padding:7px 14px;font-family:var(--font);font-size:12px;font-weight:700;cursor:pointer;transition:all 0.2s;white-space:nowrap;flex-shrink:0}
.copy-link-btn:hover{background:#3de89e;transform:scale(1.03)}
.copy-link-btn.copied{background:#22c55e;color:white}
.qr-wrap{text-align:center;padding:20px;background:var(--surface2);border:1px solid var(--border);border-radius:14px;margin-bottom:16px;cursor:pointer;transition:border-color 0.2s}
.qr-wrap:hover{border-color:var(--accent)}
.qr-canvas{border-radius:8px;display:block;margin:0 auto}
.invite-tabs{display:flex;gap:6px;margin-bottom:18px}
.invite-tab{flex:1;padding:9px;border:1px solid var(--border);border-radius:9px;background:transparent;color:var(--muted);font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s;text-align:center}
.invite-tab.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}
.invite-panel{display:none}
.invite-panel.active{display:block;animation:slideUp 0.2s ease}
.share-apps{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:4px}
.share-app-btn{display:flex;flex-direction:column;align-items:center;gap:6px;padding:12px 8px;border:1px solid var(--border);border-radius:11px;cursor:pointer;background:var(--surface2);transition:all 0.2s;text-decoration:none}
.share-app-btn:hover{border-color:var(--accent);background:var(--accent-dim);transform:translateY(-2px)}
.share-app-icon{font-size:22px;line-height:1}
.share-app-label{font-size:10px;font-weight:600;color:var(--muted)}
.share-app-btn:hover .share-app-label{color:var(--accent)}
.pending-tag{font-size:10px;font-weight:600;color:var(--purple);background:rgba(167,139,250,0.1);border-radius:4px;padding:1px 5px;margin-left:4px}
.member-row.pending .member-row-avatar{opacity:0.55;border:1px dashed currentColor}
.member-row.pending .member-row-name{color:var(--muted)}
/* RESPONSIVE */
@media(max-width:768px){
  .sidebar{display:none}
  .main{padding:16px;padding-bottom:84px}
  .stats-row{grid-template-columns:1fr 1fr}
  .two-col{grid-template-columns:1fr}
  .groups-grid{grid-template-columns:1fr}
  .grp-detail-body{grid-template-columns:1fr}
  .members-panel{position:static}
  .grp-hero-name{font-size:18px}
  .user-name{display:none!important}
  .mob-add-btn{display:none!important}
  .mob-back-btn.visible{display:flex!important}
  .mob-menu-btn{display:flex!important}
  .mob-bottom-nav{display:flex!important}
  #toast{bottom:80px}
}
@media(min-width:769px){
  .mob-back-btn{display:none!important}
  .mob-menu-btn{display:none!important}
  .mob-bottom-nav{display:none!important}
  .mob-drawer{display:none!important}
  .mob-drawer-overlay{display:none!important}
  .user-name{display:block!important}
  .mob-add-btn{display:inline-flex!important}
}

/* ── ADMIN NAV ── */
.adm-nav{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;transition:all 0.15s;font-size:13px;color:var(--muted);font-weight:500;margin-bottom:1px;position:relative;user-select:none}
.adm-nav span{font-size:15px;width:20px;text-align:center;flex-shrink:0}
.adm-nav:hover{background:rgba(167,139,250,0.08);color:var(--text)}
.adm-nav.active{background:rgba(167,139,250,0.13);color:var(--purple);font-weight:600}
.adm-nav.active::before{content:'';position:absolute;left:0;top:0;height:100%;width:3px;background:var(--purple);border-radius:0 3px 3px 0}
/* ── ADMIN PAGE ── */
.adm-page{display:none;animation:slideUp 0.25s ease}
.adm-page.active{display:block}
/* ── ADMIN STAT CARD ── */
.adm-stat{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;position:relative;overflow:hidden;transition:all 0.2s;cursor:default}
.adm-stat:hover{transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,0.3)}
.adm-stat-accent{position:absolute;top:0;right:0;bottom:0;width:3px}
.adm-stat-icon{font-size:22px;margin-bottom:10px}
.adm-stat-val{font-size:28px;font-weight:700;font-family:var(--mono);margin-bottom:4px}
.adm-stat-label{font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.adm-stat-sub{font-size:11px;color:var(--muted2);margin-top:3px}
/* ── TABLE ── */
.adm-td{padding:13px 16px;font-size:13px;border-top:1px solid var(--border);vertical-align:middle}
.adm-tr:hover .adm-td{background:rgba(255,255,255,0.015)}
/* ── CHART ROW ── */
.adm-chart-row{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.adm-chart-lbl{width:90px;font-size:12px;color:var(--muted);text-align:right;flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.adm-bar-wrap{flex:1;background:var(--surface2);border-radius:6px;height:22px;overflow:hidden}
.adm-bar{height:100%;border-radius:6px;display:flex;align-items:center;padding-left:8px;font-size:10px;font-weight:700;color:#07090f;transition:width 1s cubic-bezier(0.34,1.56,0.64,1)}
/* ── STATUS BADGES ── */
.badge-active{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;background:rgba(79,255,176,0.12);color:var(--green);border:1px solid rgba(79,255,176,0.2)}
.badge-banned{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;background:rgba(255,94,108,0.12);color:var(--red);border:1px solid rgba(255,94,108,0.2)}
.badge-admin{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;background:rgba(167,139,250,0.15);color:var(--purple);border:1px solid rgba(167,139,250,0.25)}
/* ── TOGGLE ── */
.adm-toggle{position:relative;width:42px;height:24px;flex-shrink:0}
.adm-toggle input{opacity:0;width:0;height:0;position:absolute}
.adm-toggle-track{position:absolute;inset:0;background:var(--surface3);border-radius:12px;cursor:pointer;transition:background 0.2s;border:1px solid var(--border)}
.adm-toggle input:checked+.adm-toggle-track{background:var(--purple);border-color:var(--purple)}
.adm-toggle-track::after{content:'';position:absolute;width:18px;height:18px;background:white;border-radius:50%;top:2px;left:2px;transition:transform 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.3)}
.adm-toggle input:checked+.adm-toggle-track::after{transform:translateX(18px)}
/* ── SETTING ROW ── */
.adm-setting-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border)}
.adm-setting-row:last-child{border-bottom:none}
/* ── ACTION BTN ── */
.adm-btn{background:none;border:1px solid var(--border);color:var(--muted);border-radius:7px;padding:5px 10px;font-size:11px;font-weight:600;cursor:pointer;transition:all 0.15s;font-family:var(--font);white-space:nowrap}
.adm-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.adm-btn.red:hover{border-color:var(--red);color:var(--red);background:var(--red-dim)}
.adm-btn.purple:hover{border-color:var(--purple);color:var(--purple);background:rgba(167,139,250,0.1)}
/* ── PG BTNS ── */
.pg-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:7px;padding:5px 11px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s;font-family:var(--font)}
.pg-btn:hover{border-color:var(--purple);color:var(--purple)}
.pg-btn.on{background:rgba(167,139,250,0.15);border-color:var(--purple);color:var(--purple)}
.pg-btn:disabled{opacity:0.35;cursor:not-allowed}
/* ── ADMIN PROFILE BUTTON ── */
.admin-access-btn{display:inline-flex;align-items:center;gap:8px;background:rgba(167,139,250,0.1);border:1px solid rgba(167,139,250,0.3);color:var(--purple);padding:9px 18px;border-radius:10px;font-family:var(--font);font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s}
.admin-access-btn:hover{background:rgba(167,139,250,0.2);transform:translateY(-1px)}
@media(max-width:768px){#admin-sidebar{display:none!important}}


/* ── PASSWORD TOGGLE ── */
.pass-wrap{position:relative}
.pass-wrap input{padding-right:44px}
.pass-eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--muted);font-size:16px;padding:4px;line-height:1;transition:color 0.15s;user-select:none}
.pass-eye:hover{color:var(--accent)}
/* ── FORGOT / OTP ── */
#forgot-panel,#otp-panel,#reset-panel{display:none}
.otp-inputs{display:flex;gap:10px;justify-content:center;margin:20px 0}
.otp-digit{width:52px;height:56px;background:var(--surface2);border:2px solid var(--border);border-radius:12px;color:var(--text);font-family:var(--mono);font-size:22px;font-weight:700;text-align:center;outline:none;transition:border-color 0.2s,box-shadow 0.2s}
.otp-digit:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.otp-digit.filled{border-color:rgba(79,255,176,0.4)}
.resend-link{font-size:12px;color:var(--muted);text-align:center;margin-top:10px}
.resend-link a{color:var(--accent);cursor:pointer;font-weight:600}
.resend-link a:hover{text-decoration:underline}
/* ── LOADING OVERLAY ── */
#db-loading{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px}
#db-loading.hidden{display:none}
.db-spinner{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
.db-loading-txt{font-size:14px;color:var(--muted)}
/* ── BACK LINK ── */
.auth-back{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);cursor:pointer;margin-bottom:16px;transition:color 0.15s}
.auth-back:hover{color:var(--accent)}
/* ── STRENGTH METER ── */
.strength-bar{height:3px;border-radius:3px;margin-top:6px;background:var(--border);overflow:hidden;transition:all 0.3s}
.strength-fill{height:100%;border-radius:3px;transition:width 0.3s,background 0.3s}

</style>
</head>
<body>

<!-- ── AUTH ── -->
<div id="auth-screen" class="screen active">
  <div class="auth-wrap">
    <div class="brand">
      <div class="brand-icon">✂️</div>
      <div class="brand-name">Split<span>Ease</span></div>
      <div class="brand-tag">Split expenses, not friendships</div>
    </div>
    <div class="auth-card">

      <!-- LOGIN -->
      <div id="login-panel">
        <div class="auth-title">Welcome back</div>
        <div class="auth-sub">Sign in to your account</div>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="li-email" placeholder="you@example.com" autocomplete="email" onkeydown="if(event.key==='Enter')login()">
          <div class="error-msg" id="li-email-err"></div>
        </div>
        <div class="form-group">
          <label>Password</label>
          <div class="pass-wrap">
            <input type="password" id="li-pass" placeholder="••••••••" autocomplete="current-password" onkeydown="if(event.key==='Enter')login()">
            <button type="button" class="pass-eye" onclick="togglePass('li-pass',this)" tabindex="-1">👁</button>
          </div>
          <div class="error-msg" id="li-pass-err"></div>
        </div>
        <div style="text-align:right;margin-top:-8px;margin-bottom:16px">
          <a onclick="showPanel('forgot')" style="font-size:12px;color:var(--muted);cursor:pointer;transition:color 0.15s" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color='var(--muted)'">Forgot password?</a>
        </div>
        <div class="error-msg" id="li-err" style="display:block;margin-bottom:12px;text-align:center"></div>
        <button class="btn btn-primary" id="li-btn" onclick="login()">Sign In →</button>
        <div class="divider">or</div>
        <div class="auth-toggle">New to SplitEase? <a onclick="showPanel('register')">Create free account</a></div>
      </div>

      <!-- REGISTER -->
      <div id="register-panel" style="display:none">
        <div class="auth-title">Create account</div>
        <div class="auth-sub">Start splitting expenses for free</div>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="reg-name" placeholder="Your full name" autocomplete="name">
          <div class="error-msg" id="reg-name-err"></div>
        </div>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="reg-email" placeholder="you@example.com" autocomplete="email">
          <div class="error-msg" id="reg-email-err"></div>
        </div>
        <div class="form-group">
          <label>Password</label>
          <div class="pass-wrap">
            <input type="password" id="reg-pass" placeholder="Minimum 6 characters" autocomplete="new-password" oninput="checkStrength(this.value)">
            <button type="button" class="pass-eye" onclick="togglePass('reg-pass',this)" tabindex="-1">👁</button>
          </div>
          <div class="strength-bar"><div class="strength-fill" id="strength-fill" style="width:0%"></div></div>
          <div class="error-msg" id="reg-pass-err"></div>
        </div>
        <div class="error-msg" id="reg-err" style="display:block;margin-bottom:12px;text-align:center"></div>
        <button class="btn btn-primary" id="reg-btn" onclick="register()">Create Account →</button>
        <div class="divider">or</div>
        <div class="auth-toggle">Already have an account? <a onclick="showPanel('login')">Sign in</a></div>
      </div>

      <!-- FORGOT PASSWORD -->
      <div id="forgot-panel">
        <div class="auth-back" onclick="showPanel('login')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
          Back to Sign In
        </div>
        <div class="auth-title">Forgot Password?</div>
        <div class="auth-sub">Enter your email and we'll send a 6-digit OTP to reset your password.</div>
        <div class="form-group">
          <label>Email Address</label>
          <input type="email" id="fp-email" placeholder="you@example.com" onkeydown="if(event.key==='Enter')sendOTP()">
          <div class="error-msg" id="fp-email-err"></div>
        </div>
        <div class="error-msg" id="fp-err" style="display:block;margin-bottom:12px;text-align:center"></div>
        <button class="btn btn-primary" id="fp-btn" onclick="sendOTP()">📧 Send OTP →</button>
      </div>

      <!-- OTP VERIFY -->
      <div id="otp-panel">
        <div class="auth-back" onclick="showPanel('forgot')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
          Change email
        </div>
        <div class="auth-title">Enter OTP</div>
        <div class="auth-sub" id="otp-sub">We sent a 6-digit code to your email.</div>
        <div class="otp-inputs">
          <input class="otp-digit" type="text" maxlength="1" inputmode="numeric" oninput="otpInput(this,0)" onkeydown="otpKey(event,0)">
          <input class="otp-digit" type="text" maxlength="1" inputmode="numeric" oninput="otpInput(this,1)" onkeydown="otpKey(event,1)">
          <input class="otp-digit" type="text" maxlength="1" inputmode="numeric" oninput="otpInput(this,2)" onkeydown="otpKey(event,2)">
          <input class="otp-digit" type="text" maxlength="1" inputmode="numeric" oninput="otpInput(this,3)" onkeydown="otpKey(event,3)">
          <input class="otp-digit" type="text" maxlength="1" inputmode="numeric" oninput="otpInput(this,4)" onkeydown="otpKey(event,4)">
          <input class="otp-digit" type="text" maxlength="1" inputmode="numeric" oninput="otpInput(this,5)" onkeydown="otpKey(event,5)">
        </div>
        <div class="error-msg" id="otp-err" style="display:block;margin-bottom:12px;text-align:center"></div>
        <button class="btn btn-primary" id="otp-btn" onclick="verifyOTP()">✓ Verify OTP →</button>
        <div class="resend-link">Didn't get it? <a onclick="resendOTP()" id="resend-link">Resend OTP</a> <span id="resend-timer"></span></div>
      </div>

      <!-- RESET PASSWORD -->
      <div id="reset-panel">
        <div class="auth-title">Create New Password</div>
        <div class="auth-sub">Choose a strong password for your account.</div>
        <div class="form-group">
          <label>New Password</label>
          <div class="pass-wrap">
            <input type="password" id="rp-pass" placeholder="Minimum 6 characters" oninput="checkStrength(this.value)">
            <button type="button" class="pass-eye" onclick="togglePass('rp-pass',this)" tabindex="-1">👁</button>
          </div>
          <div class="strength-bar"><div class="strength-fill" id="strength-fill2" style="width:0%"></div></div>
        </div>
        <div class="form-group">
          <label>Confirm Password</label>
          <div class="pass-wrap">
            <input type="password" id="rp-pass2" placeholder="Repeat password" onkeydown="if(event.key==='Enter')resetPassword()">
            <button type="button" class="pass-eye" onclick="togglePass('rp-pass2',this)" tabindex="-1">👁</button>
          </div>
        </div>
        <div class="error-msg" id="rp-err" style="display:block;margin-bottom:12px;text-align:center"></div>
        <button class="btn btn-primary" id="rp-btn" onclick="resetPassword()">🔐 Save New Password →</button>
      </div>

    </div>
  </div>
</div>

<!-- ── APP ── -->
<div id="app-screen" class="screen">
  <div class="topbar">
    <div class="topbar-left">
      <button class="mob-back-btn" id="mob-back-btn" onclick="mobileGoBack()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
      </button>
      <div class="topbar-logo-wrap" onclick="goTo('dashboard')">
        <div class="topbar-icon">✂️</div>
        <div class="topbar-brand">Split<span>Ease</span></div>
      </div>
    </div>
    <div class="topbar-right">
      <button class="btn btn-sm btn-primary mob-add-btn" onclick="openModal('exp-modal')">+ Expense</button>
      <div class="user-pill" onclick="goTo('profile')">
        <div class="avatar" id="topbar-avatar">?</div>
        <div class="user-name" id="topbar-name">User</div>
      </div>
      <button class="mob-menu-btn" id="mob-menu-btn" onclick="toggleMobileMenu()">
        <span></span><span></span><span></span>
      </button>
    </div>
  </div>

  <div class="app-body">
    <nav class="sidebar">
      <div class="sidebar-section">Main</div>
      <div class="nav-item active" onclick="goTo('dashboard')" id="nav-dashboard"><span class="nav-icon">🏠</span> Dashboard</div>
      <div class="nav-item" onclick="goTo('groups')" id="nav-groups"><span class="nav-icon">👥</span> Groups</div>
      <div class="nav-item" onclick="goTo('expenses')" id="nav-expenses"><span class="nav-icon">💸</span> Expenses</div>
      <div class="nav-item" onclick="goTo('balances')" id="nav-balances"><span class="nav-icon">⚖️</span> Balances<span class="nav-badge" id="owe-badge" style="display:none">0</span></div>
      <div class="nav-item" onclick="goTo('activity')" id="nav-activity"><span class="nav-icon">🔔</span> Activity</div>
      <div class="sidebar-section" style="margin-top:8px">My Groups</div>
      <div id="sidebar-groups-list"></div>
      <div class="sidebar-bottom">
        <div class="nav-item" onclick="goTo('profile')"><span class="nav-icon">👤</span> Profile</div>
        <div class="nav-item" onclick="logout()" style="color:var(--red)"><span class="nav-icon">🚪</span> Logout</div>
      </div>
    </nav>

    <main class="main">

      <!-- DASHBOARD -->
      <div id="page-dashboard" class="page active">
        <div class="page-head">
          <div><div class="page-title" id="welcome-txt">Hello 👋</div><div class="page-sub">Your financial overview</div></div>
          <button class="btn btn-ghost btn-sm" onclick="openModal('grp-modal')">+ New Group</button>
        </div>
        <div class="stats-row">
          <div class="stat"><div class="stat-label">Owed to You</div><div class="stat-val green" id="s-owed">$0.00</div></div>
          <div class="stat"><div class="stat-label">You Owe</div><div class="stat-val red" id="s-owe">$0.00</div></div>
          <div class="stat"><div class="stat-label">Total Spent</div><div class="stat-val blue" id="s-spent">$0.00</div></div>
          <div class="stat"><div class="stat-label">Groups</div><div class="stat-val purple" id="s-groups">0</div></div>
        </div>
        <div class="two-col">
          <div class="card">
            <div class="card-head"><div class="card-title">Spending This Week</div></div>
            <div class="bar-chart" id="spend-chart"></div>
            <div class="chart-labels" id="chart-labels"></div>
          </div>
          <div class="card">
            <div class="card-title" style="margin-bottom:14px">Quick Actions</div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn btn-ghost" onclick="openModal('exp-modal')" style="width:100%;justify-content:flex-start">💸 Add Expense</button>
              <button class="btn btn-ghost" onclick="openModal('grp-modal')" style="width:100%;justify-content:flex-start">👥 Create Group</button>
              <button class="btn btn-ghost" onclick="goTo('balances')" style="width:100%;justify-content:flex-start">⚖️ Settle Up</button>
              <button class="btn btn-ghost" onclick="exportCSV()" style="width:100%;justify-content:flex-start">📤 Export CSV</button>
            </div>
          </div>
        </div>
        <div class="card-head"><div class="card-title">Recent Expenses</div><a onclick="goTo('expenses')" style="font-size:12px;color:var(--accent);cursor:pointer">View all →</a></div>
        <div class="exp-list" id="dash-exps"></div>
      </div>

      <!-- GROUPS -->
      <div id="page-groups" class="page">
        <div class="page-head">
          <div><div class="page-title">Groups</div><div class="page-sub" id="grp-count-txt">No groups yet</div></div>
          <button class="btn btn-primary btn-sm" onclick="openModal('grp-modal')">+ New Group</button>
        </div>
        <div class="groups-grid" id="groups-grid"></div>
      </div>

      <!-- EXPENSES -->
      <div id="page-expenses" class="page">
        <div class="page-head">
          <div><div class="page-title">Expenses</div><div class="page-sub" id="exp-count-txt">All transactions</div></div>
          <button class="btn btn-primary btn-sm" onclick="openModal('exp-modal')">+ Add</button>
        </div>
        <div class="tabs">
          <button class="tab active" onclick="filterExps(this,'all')">All</button>
          <button class="tab" onclick="filterExps(this,'owe')">I Owe</button>
          <button class="tab" onclick="filterExps(this,'owed')">Owed to Me</button>
          <button class="tab" onclick="filterExps(this,'settled')">Settled</button>
        </div>
        <div class="exp-list" id="all-exps"></div>
      </div>

      <!-- BALANCES -->
      <div id="page-balances" class="page">
        <div class="page-head"><div><div class="page-title">Balances</div><div class="page-sub">Who owes what</div></div></div>
        <div id="bal-list"></div>
      </div>

      <!-- ACTIVITY -->
      <div id="page-activity" class="page">
        <div class="page-head"><div class="page-title">Activity</div></div>
        <div class="card"><div id="act-list"></div></div>
      </div>

      <!-- GROUP DETAIL -->
      <div id="page-group-detail" class="page">
        <div class="grp-detail-hero" id="grp-detail-hero">
          <div class="grp-detail-hero-content">
            <div class="grp-detail-back" onclick="goTo('groups')">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
              Back to Groups
            </div>
            <div class="grp-hero-top">
              <div class="grp-hero-left">
                <div class="grp-hero-emoji" id="grp-detail-emoji">🏠</div>
                <div>
                  <div class="grp-hero-name" id="grp-detail-name">Group</div>
                  <div class="grp-hero-meta" id="grp-detail-meta">0 members</div>
                </div>
              </div>
              <div class="grp-hero-right">
                <button class="btn btn-primary btn-sm" id="grp-detail-add-exp">+ Add Expense</button>
                <button class="invite-btn" id="grp-detail-invite-btn">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
                  Invite People
                </button>
                <button class="btn btn-danger btn-sm" id="grp-detail-leave-btn">Leave</button>
              </div>
            </div>
            <div class="grp-detail-stats">
              <div class="grp-detail-stat"><div class="grp-detail-stat-val" id="gd-total">$0</div><div class="grp-detail-stat-label">Total Spent</div></div>
              <div class="grp-detail-stat"><div class="grp-detail-stat-val green" id="gd-owed">$0</div><div class="grp-detail-stat-label">Owed to You</div></div>
              <div class="grp-detail-stat"><div class="grp-detail-stat-val red" id="gd-owe">$0</div><div class="grp-detail-stat-label">You Owe</div></div>
              <div class="grp-detail-stat"><div class="grp-detail-stat-val purple" id="gd-exp-count">0</div><div class="grp-detail-stat-label">Expenses</div></div>
            </div>
          </div>
        </div>
        <div class="grp-detail-body">
          <div>
            <div class="card-head" style="margin-bottom:14px">
              <div class="card-title">Expense History</div>
              <select id="gd-filter" onchange="filterGroupExps()" style="padding:6px 10px;font-size:12px;border-radius:8px;background:var(--surface2);border:1px solid var(--border);color:var(--text);font-family:var(--font)">
                <option value="all">All</option><option value="owe">I Owe</option><option value="owed">Owed to Me</option><option value="settled">Settled</option>
              </select>
            </div>
            <div class="exp-timeline" id="grp-detail-exps"></div>
          </div>
          <div>
            <div class="members-panel">
              <div class="members-panel-title">
                <span>👥 Members &amp; Balances</span>
                <button class="add-member-btn" onclick="toggleAddMemberRow()">+ Add</button>
              </div>
              <div id="grp-members-list"></div>
              <div class="add-member-row" id="add-member-row" style="display:none">
                <input type="text" id="new-member-name" placeholder="Member name..." onkeydown="if(event.key==='Enter')addMemberToGroup()">
                <button onclick="addMemberToGroup()">Add</button>
              </div>
              <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
                <button class="invite-btn" style="width:100%;justify-content:center" id="grp-panel-invite-btn">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                  Share Invite Link
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PROFILE -->
      <div id="page-profile" class="page">
        <div class="page-title" style="margin-bottom:20px">Profile Settings</div>
        <div class="profile-card">
          <div class="profile-top">
            <div class="avatar avatar-lg" id="prof-avatar">?</div>
            <div>
              <div style="font-size:18px;font-weight:700" id="prof-name">User</div>
              <div style="font-size:13px;color:var(--muted)" id="prof-email">email</div>
              <div style="font-size:11px;color:var(--muted2);margin-top:4px">Member since <span id="prof-since">today</span></div>
            </div>
          </div>
          <div class="row2">
            <div class="form-group"><label>Display Name</label><input type="text" id="pf-name"></div>
            <div class="form-group"><label>Currency</label>
              <select id="pf-currency">
                <option value="$">$ USD</option><option value="£">£ GBP</option><option value="€">€ EUR</option><option value="₹">₹ INR</option><option value="¥">¥ JPY</option>
              </select>
            </div>
          </div>
          <button class="btn btn-primary" style="width:auto;padding:10px 22px" onclick="saveProfile()">Save Changes</button>
        </div>
        <div class="profile-card">
          <div class="card-title" style="margin-bottom:10px">Account Stats</div>
          <div style="display:flex;gap:24px;flex-wrap:wrap">
            <div><div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Total Expenses</div><div style="font-size:22px;font-weight:700;font-family:var(--mono)" id="prof-exp-count">0</div></div>
            <div><div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Total Groups</div><div style="font-size:22px;font-weight:700;font-family:var(--mono)" id="prof-grp-count">0</div></div>
            <div><div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Total Spent</div><div style="font-size:22px;font-weight:700;font-family:var(--mono)" id="prof-spent">$0</div></div>
          </div>
        </div>
        <div class="profile-card">
          <div class="card-title" style="margin-bottom:10px;color:var(--red)">Danger Zone</div>
          <p style="font-size:13px;color:var(--muted);margin-bottom:14px">Delete all your data and account permanently.</p>
          <button class="btn btn-danger btn-sm" onclick="deleteAccount()">Delete Account</button>
        </div>
      </div>

    </main>
  </div><!-- end app-body -->

  <!-- Mobile bottom nav -->
  <nav class="mob-bottom-nav">
    <div class="mob-bnav-item" onclick="goTo('dashboard')" id="mbnav-dashboard"><div class="mob-bnav-icon">🏠</div><div class="mob-bnav-label">Home</div></div>
    <div class="mob-bnav-item" onclick="goTo('groups')" id="mbnav-groups"><div class="mob-bnav-icon">👥</div><div class="mob-bnav-label">Groups</div></div>
    <div class="mob-bnav-item mob-bnav-center" onclick="openModal('exp-modal')"><div class="mob-bnav-add">+</div></div>
    <div class="mob-bnav-item" onclick="goTo('balances')" id="mbnav-balances"><div class="mob-bnav-icon">⚖️</div><div class="mob-bnav-label">Balances</div></div>
    <div class="mob-bnav-item" onclick="toggleMobileMenu()"><div class="mob-bnav-icon">☰</div><div class="mob-bnav-label">More</div></div>
  </nav>

</div><!-- end app-screen -->

<!-- Mobile drawer overlay -->
<div class="mob-drawer-overlay" id="mob-drawer-overlay" onclick="closeMobileMenu()"></div>
<!-- Mobile drawer -->
<nav class="mob-drawer" id="mob-drawer">
  <div class="mob-drawer-head">
    <div style="display:flex;align-items:center;gap:10px">
      <div class="topbar-icon" style="width:28px;height:28px;font-size:12px">✂️</div>
      <div style="font-size:15px;font-weight:800">Split<span style="color:var(--accent)">Ease</span></div>
    </div>
    <button onclick="closeMobileMenu()" style="background:var(--surface2);border:none;color:var(--muted);width:30px;height:30px;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center">✕</button>
  </div>
  <div class="mob-drawer-user">
    <div class="avatar" id="mob-avatar" style="width:40px;height:40px;font-size:14px;flex-shrink:0">?</div>
    <div><div style="font-weight:600;font-size:14px" id="mob-uname">User</div><div style="font-size:12px;color:var(--muted);margin-top:1px" id="mob-uemail">email</div></div>
  </div>
  <div class="mob-drawer-nav">
    <div class="mob-nav-item" onclick="mobGoTo('dashboard')"><span>🏠</span> Dashboard</div>
    <div class="mob-nav-item" onclick="mobGoTo('expenses')"><span>💸</span> All Expenses</div>
    <div class="mob-nav-item" onclick="mobGoTo('activity')"><span>🔔</span> Activity</div>
    <div class="mob-nav-item" onclick="mobGoTo('profile')"><span>👤</span> Profile</div>
  </div>
  <div style="padding-top:8px;border-top:1px solid var(--border)">
    <div class="mob-nav-section">My Groups</div>
    <div id="mob-groups-list"></div>
  </div>
  <div style="margin-top:auto;padding-top:12px;border-top:1px solid var(--border)">
    <div class="mob-nav-item" onclick="logout()" style="color:var(--red)"><span>🚪</span> Logout</div>
  </div>
</nav>

<!-- ── MODALS ── -->

<!-- ADD/EDIT EXPENSE -->
<div class="overlay" id="exp-modal">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title" id="exp-modal-title">Add Expense</div>
      <button class="close-x" onclick="closeModal('exp-modal')">✕</button>
    </div>
    <input type="hidden" id="edit-exp-id">
    <div class="form-group"><label>Description</label><input type="text" id="e-desc" placeholder="e.g. Dinner at Pizza Hut"></div>
    <div class="row2">
      <div class="form-group"><label>Amount</label><input type="number" id="e-amt" placeholder="0.00" step="0.01" min="0"></div>
      <div class="form-group"><label>Category</label>
        <select id="e-cat">
          <option>🍕 Food</option><option>🚗 Transport</option><option>🏠 Housing</option>
          <option>🎉 Entertainment</option><option>🛍 Shopping</option><option>🏥 Health</option>
          <option>✈️ Travel</option><option>📚 Education</option><option>📦 Other</option>
        </select>
      </div>
    </div>
    <div class="row2">
      <div class="form-group"><label>Group</label><select id="e-grp"><option value="">-- Personal --</option></select></div>
      <div class="form-group"><label>Paid By</label><select id="e-paid"><option value="me">You</option></select></div>
    </div>
    <div class="form-group"><label>Split Method</label>
      <div class="split-row">
        <button class="split-opt active" onclick="setSplit(this,'equal')">⚖️ Equal</button>
        <button class="split-opt" onclick="setSplit(this,'you-paid')">💰 You Paid All</button>
        <button class="split-opt" onclick="setSplit(this,'no-split')">👤 Just Me</button>
      </div>
    </div>
    <div class="form-group"><label>Date</label><input type="date" id="e-date"></div>
    <div class="form-group"><label>Notes (optional)</label><textarea id="e-notes" placeholder="Any details..." rows="2"></textarea></div>
    <!-- Bill Snap Upload -->
    <div class="form-group">
      <label>📷 Bill Receipt (optional)</label>
      <div class="bill-upload-zone" id="bill-upload-zone"
           onclick="document.getElementById('bill-file-input').click()"
           ondragover="event.preventDefault();this.classList.add('dragging')"
           ondragleave="this.classList.remove('dragging')"
           ondrop="handleBillDrop(event)">
        <input type="file" id="bill-file-input" accept="image/*" capture="environment" onchange="handleBillUpload(event)">
        <div id="bill-placeholder">
          <span class="bill-upload-icon">📷</span>
          <div class="bill-upload-label">Tap to snap or upload a bill photo</div>
          <div class="bill-upload-sub">JPG, PNG, HEIC supported</div>
        </div>
        <img id="bill-modal-preview" class="bill-preview-img" style="display:none" alt="Receipt preview">
        <div class="bill-preview-bar" id="bill-preview-bar" style="display:none">
          <span>📷 Receipt attached</span>
          <button type="button" onclick="event.stopPropagation();clearBillUpload()" style="background:rgba(255,94,108,0.3);border:none;color:var(--red);border-radius:5px;padding:3px 8px;cursor:pointer;font-size:11px;font-weight:600">✕ Remove</button>
        </div>
      </div>
    </div>
    <button class="btn btn-primary" onclick="saveExpense()" id="save-exp-btn">Add Expense</button>
  </div>
</div>

<!-- CREATE GROUP -->
<div class="overlay" id="grp-modal">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">Create Group</div>
      <button class="close-x" onclick="closeModal('grp-modal')">✕</button>
    </div>
    <div class="form-group"><label>Group Name</label><input type="text" id="g-name" placeholder="e.g. NYC Trip, Apartment, etc."></div>
    <div class="form-group"><label>Category</label>
      <select id="g-type">
        <option>✈️ Trip</option><option>🏠 Home</option><option>💼 Work</option>
        <option>🎉 Event</option><option>🎓 School</option><option>👥 General</option>
      </select>
    </div>
    <div class="form-group">
      <label>Members (type name + Enter)</label>
      <div class="member-area" id="member-area" onclick="document.getElementById('member-inp').focus()">
        <input type="text" id="member-inp" placeholder="Add member..." onkeydown="onMemberKey(event)">
      </div>
    </div>
    <div class="form-group"><label>Color</label>
      <div class="color-row">
        <div class="color-dot active" id="cd-teal" onclick="pickColor('teal')" style="background:linear-gradient(135deg,#4fffb0,#a78bfa)"></div>
        <div class="color-dot" id="cd-red" onclick="pickColor('red')" style="background:linear-gradient(135deg,#ff5e6c,#ffc94d)"></div>
        <div class="color-dot" id="cd-purple" onclick="pickColor('purple')" style="background:linear-gradient(135deg,#a78bfa,#60a5fa)"></div>
        <div class="color-dot" id="cd-yellow" onclick="pickColor('yellow')" style="background:linear-gradient(135deg,#ffc94d,#4fffb0)"></div>
        <div class="color-dot" id="cd-blue" onclick="pickColor('blue')" style="background:linear-gradient(135deg,#60a5fa,#4fffb0)"></div>
      </div>
    </div>
    <button class="btn btn-primary" onclick="saveGroup()">Create Group</button>
  </div>
</div>

<!-- SETTLE UP -->
<div class="overlay" id="settle-modal">
  <div class="modal">
    <div class="modal-head"><div class="modal-title">Settle Up</div><button class="close-x" onclick="closeModal('settle-modal')">✕</button></div>
    <div id="settle-content"></div>
    <div class="form-group" style="margin-top:14px"><label>Payment Method</label>
      <select id="settle-method"><option>💵 Cash</option><option>🏦 Bank Transfer</option><option>📱 PayPal</option><option>💳 Venmo</option><option>📲 UPI</option></select>
    </div>
    <div class="form-group"><label>Note (optional)</label><input type="text" id="settle-note" placeholder="Add a note..."></div>
    <button class="btn btn-primary" style="background:var(--accent);margin-top:4px" onclick="confirmSettle()">✓ Mark as Settled</button>
  </div>
</div>

<!-- EXIT GROUP -->
<div class="overlay" id="exit-modal">
  <div class="modal" style="max-width:380px">
    <div class="modal-head"><div class="modal-title">Leave Group?</div><button class="close-x" onclick="closeModal('exit-modal')">✕</button></div>
    <p style="color:var(--muted);font-size:14px;line-height:1.7;margin-bottom:20px">You're about to leave <strong id="exit-grp-name" style="color:var(--text)"></strong>. All your expenses in this group will remain but you'll no longer be a member.</p>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="closeModal('exit-modal')" style="flex:1">Cancel</button>
      <button class="btn btn-danger" onclick="confirmExit()" style="flex:1">Leave Group</button>
    </div>
  </div>
</div>

<!-- DELETE EXPENSE -->
<div class="overlay" id="del-exp-modal">
  <div class="modal" style="max-width:360px">
    <div class="modal-head"><div class="modal-title">Delete Expense?</div><button class="close-x" onclick="closeModal('del-exp-modal')">✕</button></div>
    <p style="color:var(--muted);font-size:14px;margin-bottom:20px">This cannot be undone.</p>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="closeModal('del-exp-modal')" style="flex:1">Cancel</button>
      <button class="btn btn-danger" onclick="confirmDelExp()" style="flex:1">Delete</button>
    </div>
  </div>
</div>

<!-- INVITE PEOPLE MODAL -->
<div class="overlay" id="invite-modal">
  <div class="modal invite-modal">
    <div class="modal-head">
      <div class="modal-title">Invite People</div>
      <button class="close-x" onclick="closeModal('invite-modal')">✕</button>
    </div>

    <!-- Group identity strip -->
    <div id="invite-group-strip" style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:12px;margin-bottom:18px">
      <div id="inv-grp-emoji" style="font-size:24px">🏠</div>
      <div>
        <div id="inv-grp-name" style="font-weight:700;font-size:15px">Group</div>
        <div id="inv-grp-meta" style="font-size:12px;color:var(--muted)">0 members</div>
      </div>
    </div>

    <!-- Tab switcher -->
    <div class="invite-tabs">
      <button class="invite-tab active" onclick="switchInviteTab('link',this)">🔗 Share Link</button>
      <button class="invite-tab" onclick="switchInviteTab('qr',this)">📱 QR Code</button>
      <button class="invite-tab" onclick="switchInviteTab('apps',this)">💬 Share Via</button>
    </div>

    <!-- Link panel -->
    <div class="invite-panel active" id="inv-panel-link">
      <p style="font-size:13px;color:var(--muted);margin-bottom:14px;line-height:1.6">Share this link with anyone you want to invite. When they open it, they'll be added to the group automatically.</p>
      <div class="invite-link-box">
        <span class="invite-link-text" id="inv-link-text">Generating...</span>
        <button class="copy-link-btn" id="copy-link-btn" onclick="copyInviteLink()">Copy</button>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost btn-sm" style="flex:1" onclick="regenerateInviteLink()">🔄 New Link</button>
        <button class="btn btn-ghost btn-sm" style="flex:1" onclick="shareNative()">↗ Share</button>
      </div>
    </div>

    <!-- QR code panel -->
    <div class="invite-panel" id="inv-panel-qr">
      <p style="font-size:13px;color:var(--muted);margin-bottom:16px">Let people scan this QR code on their phone to join the group instantly.</p>
      <div class="qr-wrap" onclick="downloadQR()">
        <canvas id="qr-canvas" class="qr-canvas" width="200" height="200"></canvas>
        <div class="qr-label">Tap to download QR code</div>
      </div>
    </div>

    <!-- Share apps panel -->
    <div class="invite-panel" id="inv-panel-apps">
      <p style="font-size:13px;color:var(--muted);margin-bottom:16px">Send the invite directly through your favourite app.</p>
      <div class="share-apps" id="share-apps-grid"></div>
    </div>

    <!-- Direct add section -->
    <div style="margin-top:18px;padding-top:18px;border-top:1px solid var(--border)">
      <div style="font-size:12px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.6px;margin-bottom:10px">Or add directly by name</div>
      <div class="add-member-row" style="margin-top:0;padding-top:0;border-top:none">
        <input type="text" id="inv-direct-name" placeholder="Enter their name..." onkeydown="if(event.key==='Enter')addMemberDirect()">
        <button onclick="addMemberDirect()">Add</button>
      </div>
      <div id="inv-added-list" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<!-- BILL LIGHTBOX -->
<div id="bill-lightbox" onclick="if(event.target===this)closeBillLightbox()">
  <button class="lb-close" onclick="closeBillLightbox()">✕</button>
  <img id="lb-img" src="" alt="Bill receipt">
  <div><div class="lb-info" id="lb-title"></div><div class="lb-meta" id="lb-meta"></div></div>
  <div class="lb-actions">
    <button class="btn btn-ghost btn-sm" onclick="downloadBill()">⬇ Download</button>
    <button class="btn btn-ghost btn-sm" onclick="closeBillLightbox()">Close</button>
  </div>
</div>

<!-- Hidden file input for quick camera capture from expense list -->
<input type="file" id="quick-bill-input" accept="image/*" capture="environment" style="display:none" onchange="handleQuickBillUpload(event)">

<div id="toast"></div>

<script>

// ╔══════════════════════════════════════════════════════════════════════╗
// ║              SPLITEASE — SETUP INSTRUCTIONS                          ║
// ║                                                                      ║
// ║  This app uses Firebase Realtime Database for cross-device sync.    ║
// ║  Follow these 3 steps to make it work:                              ║
// ║                                                                      ║
// ║  STEP 1: Create a Firebase project                                   ║
// ║    → https://console.firebase.google.com                            ║
// ║    → "Add project" → name it → continue                             ║
// ║                                                                      ║
// ║  STEP 2: Add a Realtime Database                                     ║
// ║    → Build → Realtime Database → Create database                    ║
// ║    → Start in TEST MODE (so anyone can read/write)                   ║
// ║    → Copy the database URL (ends in .firebaseio.com)                ║
// ║                                                                      ║
// ║  STEP 3: Get your config & paste it in FIREBASE_CONFIG below        ║
// ║    → Project Settings (gear icon) → Your apps → Web app             ║
// ║    → Register app → copy the firebaseConfig object                   ║
// ║                                                                      ║
// ║  EMAILJS (for OTP password reset emails):                           ║
// ║    → https://www.emailjs.com  (free 200 emails/month)               ║
// ║    → Create account → Add Email Service → Create Template           ║
// ║    → Template variables: {{to_email}} {{otp_code}} {{user_name}}    ║
// ║    → Copy Service ID, Template ID, Public Key into config below     ║
// ║    → Note: OTP also shows in browser console for testing            ║
// ╚══════════════════════════════════════════════════════════════════════╝

// ═══════════════════════════════════════════════════════════
//  FIREBASE CONFIG
//  ► REPLACE with your own project credentials from:
//    https://console.firebase.google.com
//    Project Settings → Your apps → Firebase SDK snippet → Config
// ═══════════════════════════════════════════════════════════
const FIREBASE_CONFIG = {
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAn2QsTf6P6BBaYxnD6u7Zv-LdXpdTxjUU",
  authDomain: "splitease-8bce9.firebaseapp.com",
  databaseURL: "https://splitease-8bce9-default-rtdb.firebaseio.com",
  projectId: "splitease-8bce9",
  storageBucket: "splitease-8bce9.firebasestorage.app",
  messagingSenderId: "518539903984",
  appId: "1:518539903984:web:62cab4848b3ad987e65335",
  measurementId: "G-B63992W2BR"
};

// ═══════════════════════════════════════════════════════════
//  EMAILJS CONFIG (for OTP emails — free tier works fine)
//  ► Sign up at https://www.emailjs.com
//  ► Create a service, template, get your keys
//  ► Template variables: {{to_email}}, {{otp_code}}, {{user_name}}
// ═══════════════════════════════════════════════════════════
const EMAILJS_SERVICE_ID  = 'service_splitease';   // ← your EmailJS service ID
const EMAILJS_TEMPLATE_ID = 'template_otp';        // ← your EmailJS template ID
const EMAILJS_PUBLIC_KEY  = 'YOUR_PUBLIC_KEY';     // ← your EmailJS public key

// ─── Firebase init ───────────────────────────────────────
firebase.initializeApp(FIREBASE_CONFIG);
const RTDB = firebase.database();

// ─── Safe key encode (email → firebase path safe) ────────
function fbKey(email){ return email.replace(/\./g,'_dot_').replace(/@/g,'_at_'); }
function fbKeyDecode(k){ return k.replace(/_dot_/g,'.').replace(/_at_/g,'@'); }

// ═══ FIREBASE DB LAYER ═══════════════════════════════════
// All reads/writes go to Firebase Realtime Database.
// localStorage is ONLY used for receipts (base64 images are too large for RTDB free tier)
// and for caching the session email.

const DB = {
  // ── Users (stored in /users/{fbKey(email)}) ──
  getUsers: () => {
    // Returns cached users object (populated by loadAllUsers)
    return DB._usersCache || {};
  },
  _usersCache: null,
  loadAllUsers: () => new Promise(resolve => {
    RTDB.ref('users').once('value', snap => {
      const raw = snap.val() || {};
      // Decode keys back to emails
      const decoded = {};
      Object.keys(raw).forEach(k => { decoded[fbKeyDecode(k)] = raw[k]; });
      DB._usersCache = decoded;
      resolve(decoded);
    });
  }),
  getUser: (email) => new Promise(resolve => {
    RTDB.ref('users/' + fbKey(email)).once('value', snap => resolve(snap.val()));
  }),
  saveUser: (email, userData) => {
    if(!DB._usersCache) DB._usersCache = {};
    DB._usersCache[email] = userData;
    return RTDB.ref('users/' + fbKey(email)).set(userData);
  },
  saveUsers: (usersObj) => {
    DB._usersCache = usersObj;
    const encoded = {};
    Object.keys(usersObj).forEach(email => { encoded[fbKey(email)] = usersObj[email]; });
    return RTDB.ref('users').set(encoded);
  },

  // ── Per-user data (groups, expenses, activity, profile) ──
  getData: (email, type) => new Promise(resolve => {
    RTDB.ref('data/' + fbKey(email) + '/' + type).once('value', snap => resolve(snap.val()));
  }),
  saveData: (email, type, val) => RTDB.ref('data/' + fbKey(email) + '/' + type).set(val),

  getGroups: (email) => DB._cache[email]?.groups || [],
  saveGroups: (email, v) => { DB._setCache(email,'groups',v); return DB.saveData(email,'groups',v); },
  getExpenses: (email) => DB._cache[email]?.expenses || [],
  saveExpenses: (email, v) => { DB._setCache(email,'expenses',v); return DB.saveData(email,'expenses',v); },
  getActivity: (email) => DB._cache[email]?.activity || [],
  saveActivity: (email, v) => { DB._setCache(email,'activity',v); return DB.saveData(email,'activity',v); },
  getProfile: (email) => DB._cache[email]?.profile || {},
  saveProfile: (email, v) => { DB._setCache(email,'profile',v); return DB.saveData(email,'profile',v); },

  // Local cache so UI remains synchronous after initial load
  _cache: {},
  _setCache: (email, type, val) => { if(!DB._cache[email]) DB._cache[email]={}; DB._cache[email][type]=val; },
  loadUserData: (email) => new Promise(resolve => {
    RTDB.ref('data/' + fbKey(email)).once('value', snap => {
      const d = snap.val() || {};
      DB._cache[email] = d;
      resolve(d);
    });
  }),

  // ── Receipts — localStorage only (base64 too large for free RTDB) ──
  receiptKey: (email, expId) => `se_r_${btoa(email)}_${expId}`,
  getReceipt: (email, expId) => localStorage.getItem(DB.receiptKey(email, expId)) || null,
  saveReceipt: (email, expId, dataUrl) => { try { localStorage.setItem(DB.receiptKey(email, expId), dataUrl); return true; } catch(e) { return false; } },
  deleteReceipt: (email, expId) => localStorage.removeItem(DB.receiptKey(email, expId)),

  // ── Invite tokens (Firebase) ──
  getInvites: () => DB._invitesCache || {},
  _invitesCache: null,
  loadInvites: () => new Promise(resolve => {
    RTDB.ref('invites').once('value', snap => { DB._invitesCache = snap.val() || {}; resolve(DB._invitesCache); });
  }),
  saveInvites: v => { DB._invitesCache = v; return RTDB.ref('invites').set(v); },
  createInviteToken: (email, groupId, groupName) => {
    const token = Math.random().toString(36).substring(2,9) + Math.random().toString(36).substring(2,9);
    const invites = DB.getInvites();
    invites[token] = { groupId, groupOwner: email, groupName, createdAt: new Date().toISOString() };
    DB.saveInvites(invites);
    return token;
  },
  getInviteByToken: token => { return DB.getInvites()[token] || null; },
  revokeInviteForGroup: (email, groupId) => {
    const invites = DB.getInvites();
    Object.keys(invites).forEach(t => { if(invites[t].groupOwner===email && invites[t].groupId===groupId) delete invites[t]; });
    DB.saveInvites(invites);
  },

  // ── Admin settings (Firebase) ──
  getAdminCfg: () => new Promise(resolve => {
    RTDB.ref('admin/config').once('value', snap => {
      resolve(snap.val() || { email:'admin@splitease.com', passHash:'', maintenance:false, registrations:true, invites:true });
    });
  }),
  saveAdminCfg: cfg => RTDB.ref('admin/config').set(cfg),
  _adminCfgCache: null,

  // ── Ban list (Firebase) ──
  getBanned: () => DB._bannedCache || [],
  _bannedCache: null,
  loadBanned: () => new Promise(resolve => {
    RTDB.ref('admin/banned').once('value', snap => {
      DB._bannedCache = snap.val() || [];
      resolve(DB._bannedCache);
    });
  }),
  saveBanned: b => { DB._bannedCache = b; return RTDB.ref('admin/banned').set(b); },

  // ── Hash util ──
  hash: async str => {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  },

  // ── Delete user completely ──
  deleteUserAllData: async (email) => {
    await RTDB.ref('users/' + fbKey(email)).remove();
    await RTDB.ref('data/' + fbKey(email)).remove();
    delete DB._cache[email];
    if(DB._usersCache) delete DB._usersCache[email];
    // Remove receipts from localStorage
    const prefix = `se_r_${btoa(email)}_`;
    Object.keys(localStorage).filter(k=>k.startsWith(prefix)).forEach(k=>localStorage.removeItem(k));
  }
};

// ═══ STATE ═══
let S = {
  user: null, groups: [], expenses: [], activity: [], profile: {},
  newMembers: [], selectedColor: 'teal', selectedSplit: 'equal',
  settleTarget: null, exitGroupId: null, delExpId: null, editExpId: null,
  expFilter: 'all', currency: '$', activeGroupId: null,
  currentPage: 'dashboard', pageHistory: [],
  pendingBillDataUrl: null, // bill staged in modal before saving expense
  quickBillExpId: null,     // which expense id the quick camera is targeting
  lightboxExpId: null,      // currently shown in lightbox
};

// ═══ AUTH ═══
function showPanel(p) {
  ['login-panel','register-panel','forgot-panel','otp-panel','reset-panel'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.style.display='none';
  });
  const show=document.getElementById(p+'-panel')||document.getElementById(p);
  if(show) show.style.display='block';
  clearErrors();
}
function clearErrors() {
  document.querySelectorAll('.error-msg').forEach(e=>{e.style.display='none';e.textContent='';});
  document.querySelectorAll('input').forEach(i=>i.classList.remove('input-error'));
}
function showErr(id, msg) { const el=document.getElementById(id); if(el){el.style.display='block';el.textContent=msg;} }

// ── Password visibility toggle ──
function togglePass(inputId, btn) {
  const inp = document.getElementById(inputId);
  if(!inp) return;
  const isPass = inp.type === 'password';
  inp.type = isPass ? 'text' : 'password';
  btn.textContent = isPass ? '🙈' : '👁';
}

// ── Password strength ──
function checkStrength(val) {
  const fills = ['strength-fill','strength-fill2'];
  fills.forEach(id => {
    const el = document.getElementById(id); if(!el) return;
    let score = 0;
    if(val.length >= 6) score++;
    if(val.length >= 10) score++;
    if(/[A-Z]/.test(val)) score++;
    if(/[0-9]/.test(val)) score++;
    if(/[^A-Za-z0-9]/.test(val)) score++;
    const pct = (score/5)*100;
    const color = score<=1?'#ff5e6c':score<=3?'#ffc94d':'#4fffb0';
    el.style.width = pct+'%';
    el.style.background = color;
  });
}

// ── Register ──
async function register() {
  clearErrors();
  const name=document.getElementById('reg-name').value.trim();
  const email=document.getElementById('reg-email').value.trim().toLowerCase();
  const pass=document.getElementById('reg-pass').value;
  let ok=true;
  if(!name){showErr('reg-name-err','Name is required');document.getElementById('reg-name').classList.add('input-error');ok=false;}
  if(!email||!email.includes('@')){showErr('reg-email-err','Valid email required');document.getElementById('reg-email').classList.add('input-error');ok=false;}
  if(pass.length<6){showErr('reg-pass-err','Min 6 characters');document.getElementById('reg-pass').classList.add('input-error');ok=false;}
  if(!ok)return;
  setBtnLoading('reg-btn',true,'Creating Account…');
  try {
    // Check if email already exists in Firebase
    const existing = await DB.getUser(email);
    if(existing){ showErr('reg-err','An account with this email already exists.'); setBtnLoading('reg-btn',false,'Create Account →'); return; }
    const passHash=await DB.hash(pass);
    const initials=name.split(' ').filter(Boolean).map(n=>n[0].toUpperCase()).slice(0,2).join('');
    const userData={name,passHash,initials,joined:new Date().toISOString()};
    await DB.saveUser(email, userData);
    await DB.saveData(email,'groups',[]);
    await DB.saveData(email,'expenses',[]);
    await DB.saveData(email,'activity',[{text:`Welcome to SplitEase, <strong>${name}</strong>! 🎉`,time:now(),color:'#4fffb0'}]);
    await DB.saveData(email,'profile',{currency:'$',name});
    DB._cache[email]={groups:[],expenses:[],activity:[{text:`Welcome to SplitEase, <strong>${name}</strong>! 🎉`,time:now(),color:'#4fffb0'}],profile:{currency:'$',name}};
    if(!DB._usersCache) DB._usersCache={};
    DB._usersCache[email]=userData;
    toast('✅ Account created! Please sign in.');
    showPanel('login');
    document.getElementById('li-email').value=email;
  } catch(err) {
    showErr('reg-err','Network error. Please check your connection and try again.');
    console.error(err);
  }
  setBtnLoading('reg-btn',false,'Create Account →');
}

// ── Login ──
async function login() {
  clearErrors();
  const email=document.getElementById('li-email').value.trim().toLowerCase();
  const pass=document.getElementById('li-pass').value;
  if(!email){showErr('li-email-err','Email required');document.getElementById('li-email').classList.add('input-error');return;}
  if(!pass){showErr('li-pass-err','Password required');document.getElementById('li-pass').classList.add('input-error');return;}

  // Check ban (from Firebase cache)
  const banned = DB.getBanned();
  if(banned.includes(email)){showErr('li-err','🚫 This account has been suspended. Contact support.');return;}

  setBtnLoading('li-btn',true,'Signing In…');
  try {
    const u = await DB.getUser(email);
    if(!u){ showErr('li-err','No account found with this email.'); setBtnLoading('li-btn',false,'Sign In →'); return; }
    const passHash=await DB.hash(pass);
    if(u.passHash!==passHash){ showErr('li-err','Incorrect password.'); setBtnLoading('li-btn',false,'Sign In →'); return; }
    // Load all user data
    await DB.loadUserData(email);
    if(!DB._usersCache) DB._usersCache={};
    DB._usersCache[email]=u;
    sessionStorage.setItem('se_session',email);
    initApp(email,u);
  } catch(err) {
    showErr('li-err','Connection error. Please try again.');
    console.error(err);
  }
  setBtnLoading('li-btn',false,'Sign In →');
}

function logout() {
  sessionStorage.removeItem('se_session');
  S.user=null;
  document.getElementById('auth-screen').classList.add('active');
  document.getElementById('app-screen').classList.remove('active');
  showPanel('login');
  toast('👋 Logged out');
}

async function deleteAccount() {
  if(!confirm('Delete your account and ALL data? This cannot be undone.'))return;
  await DB.deleteUserAllData(S.user);
  sessionStorage.removeItem('se_session');
  logout();
  toast('🗑 Account deleted');
}

// ── Button loading state ──
function setBtnLoading(id, loading, txt) {
  const btn=document.getElementById(id); if(!btn) return;
  btn.disabled=loading;
  btn.style.opacity=loading?'0.7':'1';
  if(txt) btn.textContent=loading?txt:btn.dataset.origTxt||txt;
  if(!loading && btn.dataset.origTxt) btn.textContent=btn.dataset.origTxt;
  if(loading && !btn.dataset.origTxt) btn.dataset.origTxt=btn.textContent;
}

// ═══ FORGOT PASSWORD / OTP ═══
let OTP_STATE = { code:'', email:'', expiry:0, resendTimer:null };

async function sendOTP() {
  clearErrors();
  const email=(document.getElementById('fp-email')?.value||'').trim().toLowerCase();
  if(!email||!email.includes('@')){ showErr('fp-email-err','Valid email required'); return; }
  setBtnLoading('fp-btn',true,'Sending OTP…');
  try {
    const u = await DB.getUser(email);
    if(!u){ showErr('fp-err','No account found with this email.'); setBtnLoading('fp-btn',false,'📧 Send OTP →'); return; }
    // Generate 6-digit OTP
    const otp = Math.floor(100000 + Math.random() * 900000).toString();
    OTP_STATE = { code:otp, email, expiry: Date.now() + 10*60*1000, resendTimer:null };
    // Send via EmailJS
    try {
      await emailjs.init(EMAILJS_PUBLIC_KEY);
      await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
        to_email: email,
        otp_code: otp,
        user_name: u.name || 'there',
        app_name: 'SplitEase'
      });
      toast('📧 OTP sent! Check your inbox.');
    } catch(emailErr) {
      // EmailJS not configured — show OTP in console for testing
      console.warn('EmailJS not configured. OTP for testing:', otp);
      toast('⚠️ Email service not configured. OTP: ' + otp + ' (check console)');
    }
    document.getElementById('otp-sub').textContent=`We sent a 6-digit code to ${email}`;
    showPanel('otp');
    // Clear OTP inputs and focus first
    document.querySelectorAll('.otp-digit').forEach(d=>{d.value='';d.classList.remove('filled');});
    setTimeout(()=>{ const d=document.querySelector('.otp-digit'); if(d) d.focus(); },100);
    startResendTimer();
  } catch(err) { showErr('fp-err','Connection error. Please try again.'); console.error(err); }
  setBtnLoading('fp-btn',false,'📧 Send OTP →');
}

function otpInput(inp, idx) {
  inp.value = inp.value.replace(/\D/g,'').slice(-1);
  inp.classList.toggle('filled', inp.value!=='');
  if(inp.value && idx < 5) {
    const next=document.querySelectorAll('.otp-digit')[idx+1]; if(next) next.focus();
  }
  // Auto-verify when all 6 digits entered
  const digits=document.querySelectorAll('.otp-digit');
  const full=[...digits].every(d=>d.value!=='');
  if(full) setTimeout(verifyOTP, 200);
}
function otpKey(e, idx) {
  if(e.key==='Backspace') {
    const digits=document.querySelectorAll('.otp-digit');
    if(!digits[idx].value && idx>0) { digits[idx-1].focus(); digits[idx-1].value=''; digits[idx-1].classList.remove('filled'); }
  }
}

function verifyOTP() {
  const digits=[...document.querySelectorAll('.otp-digit')].map(d=>d.value).join('');
  if(digits.length<6){ showErr('otp-err','Please enter all 6 digits'); return; }
  if(Date.now()>OTP_STATE.expiry){ showErr('otp-err','OTP expired. Please request a new one.'); return; }
  if(digits!==OTP_STATE.code){ showErr('otp-err','Incorrect OTP. Please try again.'); return; }
  // OTP correct
  clearErrors();
  showPanel('reset');
  document.getElementById('rp-pass').value='';
  document.getElementById('rp-pass2').value='';
}

async function resendOTP() {
  if(OTP_STATE.resendTimerCount>0) return;
  const fpEmail=document.getElementById('fp-email');
  if(fpEmail&&OTP_STATE.email) fpEmail.value=OTP_STATE.email;
  await sendOTP();
}

let _resendCountdown=0;
function startResendTimer() {
  _resendCountdown=60;
  const link=document.getElementById('resend-link');
  const timer=document.getElementById('resend-timer');
  if(link) link.style.opacity='0.4';
  const interval=setInterval(()=>{
    _resendCountdown--;
    if(timer) timer.textContent=`(${_resendCountdown}s)`;
    if(_resendCountdown<=0){
      clearInterval(interval);
      if(timer) timer.textContent='';
      if(link) link.style.opacity='1';
    }
  },1000);
}

async function resetPassword() {
  const pass=document.getElementById('rp-pass').value;
  const pass2=document.getElementById('rp-pass2').value;
  if(pass.length<6){ showErr('rp-err','Password must be at least 6 characters'); return; }
  if(pass!==pass2){ showErr('rp-err','Passwords do not match'); return; }
  setBtnLoading('rp-btn',true,'Saving…');
  try {
    const u = await DB.getUser(OTP_STATE.email);
    if(!u){ showErr('rp-err','User not found.'); setBtnLoading('rp-btn',false,'🔐 Save New Password →'); return; }
    const passHash = await DB.hash(pass);
    await DB.saveUser(OTP_STATE.email, {...u, passHash});
    toast('✅ Password reset successfully! Please sign in.');
    OTP_STATE={code:'',email:'',expiry:0,resendTimer:null};
    showPanel('login');
  } catch(err) { showErr('rp-err','Connection error. Please try again.'); console.error(err); }
  setBtnLoading('rp-btn',false,'🔐 Save New Password →');
}

// ═══ INIT APP ═══
function initApp(email, u) {
  if(!u) u = DB._usersCache?.[email] || {};
  S.user=email;
  S.groups=DB.getGroups(email);
  S.expenses=DB.getExpenses(email);
  S.activity=DB.getActivity(email);
  S.profile=DB.getProfile(email);
  S.currency=S.profile.currency||'$';
  const h=new Date().getHours();
  const greet=h<12?'Good morning':h<18?'Good afternoon':'Good evening';
  const name=(u.name||email).split(' ')[0];
  document.getElementById('welcome-txt').textContent=`${greet}, ${name} 👋`;
  document.getElementById('topbar-avatar').textContent=u.initials||name[0].toUpperCase();
  document.getElementById('topbar-name').textContent=name;
  document.getElementById('prof-avatar').textContent=u.initials||name[0].toUpperCase();
  document.getElementById('prof-name').textContent=u.name||name;
  document.getElementById('prof-email').textContent=email;
  document.getElementById('prof-since').textContent=new Date(u.joined||Date.now()).toLocaleDateString('en-US',{month:'long',year:'numeric'});
  document.getElementById('pf-name').value=S.profile.name||u.name||name;
  document.getElementById('pf-currency').value=S.currency;
  const mobAvatar=document.getElementById('mob-avatar');
  const mobUname=document.getElementById('mob-uname');
  const mobUemail=document.getElementById('mob-uemail');
  if(mobAvatar)mobAvatar.textContent=u.initials||name[0].toUpperCase();
  if(mobUname)mobUname.textContent=u.name||name;
  if(mobUemail)mobUemail.textContent=email;
  const overlay=document.getElementById('mob-drawer-overlay');
  if(overlay){overlay.style.display='none';overlay.style.opacity='0';}
  document.getElementById('auth-screen').classList.remove('active');
  document.getElementById('app-screen').classList.add('active');
  document.getElementById('e-date').value=new Date().toISOString().split('T')[0];
  renderAll();
  goTo('dashboard');
  checkPendingInviteAfterLogin();
}

// ── App startup — connect to Firebase first, then restore session ──
window.addEventListener('load', async () => {
  const loadingEl = document.getElementById('db-loading');
  const loadingTxt = document.getElementById('db-loading-txt');
  try {
    loadingTxt.textContent = 'Connecting to database…';
    // Load shared data needed before login
    await Promise.all([
      DB.loadAllUsers(),
      DB.loadInvites(),
      DB.loadBanned(),
    ]);
    checkInviteLink();
    const session = sessionStorage.getItem('se_session');
    if(session && DB._usersCache?.[session]) {
      loadingTxt.textContent = 'Loading your data…';
      await DB.loadUserData(session);
      if(loadingEl) loadingEl.classList.add('hidden');
      initApp(session, DB._usersCache[session]);
    } else {
      if(loadingEl) loadingEl.classList.add('hidden');
    }
  } catch(err) {
    console.error('Firebase connection error:', err);
    if(loadingTxt) loadingTxt.textContent = '⚠️ Could not connect to database. Check Firebase config.';
    // Show error but let user see auth screen
    setTimeout(()=>{ if(loadingEl) loadingEl.classList.add('hidden'); }, 3000);
  }
});

// ═══ RENDER ═══
function renderAll() {
  renderStats();renderDashExpenses();renderSidebarGroups();renderGroups();
  renderExpenses();renderBalances();renderActivity();renderChart();renderProfile();populateExpForm();
  if(S.activeGroupId&&document.getElementById('page-group-detail').classList.contains('active'))renderGroupDetail();
}

function C(v){return `${S.currency}${Math.abs(v).toFixed(2)}`;}

function renderStats() {
  const owed=S.expenses.filter(e=>!e.settled&&e.share==='owed').reduce((s,e)=>s+e.shareAmt,0);
  const owe=S.expenses.filter(e=>!e.settled&&e.share==='owe').reduce((s,e)=>s+e.shareAmt,0);
  const spent=S.expenses.reduce((s,e)=>s+e.amount,0);
  document.getElementById('s-owed').textContent=C(owed);
  document.getElementById('s-owe').textContent=C(owe);
  document.getElementById('s-spent').textContent=C(spent);
  document.getElementById('s-groups').textContent=S.groups.length;
  const oweCount=S.expenses.filter(e=>!e.settled&&e.share==='owe').length;
  const badge=document.getElementById('owe-badge');
  badge.textContent=oweCount;badge.style.display=oweCount>0?'inline':'none';
}

function renderChart() {
  const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const today=new Date();
  const vals=days.map((_,i)=>{const d=new Date(today);d.setDate(today.getDate()-(6-i));const ds=d.toISOString().split('T')[0];return S.expenses.filter(e=>e.date===ds).reduce((s,e)=>s+e.amount,0);});
  const max=Math.max(...vals,1);
  const colors=['#4fffb0','#a78bfa','#ffc94d','#ff5e6c','#60a5fa','#4fffb0','#a78bfa'];
  document.getElementById('spend-chart').innerHTML=vals.map((v,i)=>`<div class="bar" style="height:${(v/max)*100}%;background:${colors[i]};opacity:0.75" title="${C(v)}"></div>`).join('');
  document.getElementById('chart-labels').innerHTML=days.map(d=>`<span>${d}</span>`).join('');
}

const catColors={'🍕':'rgba(255,94,108,0.15)','🚗':'rgba(79,255,176,0.12)','🏠':'rgba(63,185,80,0.12)','🎉':'rgba(255,201,77,0.15)','🛍':'rgba(167,139,250,0.15)','🏥':'rgba(255,94,108,0.12)','✈️':'rgba(96,165,250,0.15)','📚':'rgba(167,139,250,0.12)','📦':'rgba(107,122,153,0.12)'};

function expHTML(e, showActions=true) {
  const catIcon=e.category.split(' ')[0];
  const bg=catColors[catIcon]||'rgba(107,122,153,0.12)';
  const grpName=e.groupId?(S.groups.find(g=>g.id===e.groupId)?.name||'Unknown'):'Personal';
  const shareClass=e.settled?'settled-txt':e.share==='owe'?'you-owe':e.share==='owed'?'owed-you':'settled-txt';
  const shareText=e.settled?'✓ Settled':e.share==='owe'?`You owe ${C(e.shareAmt)}`:e.share==='owed'?`Lent ${C(e.shareAmt)}`:'Personal';
  const receipt=DB.getReceipt(S.user,e.id);
  return `<div class="exp-item">
    <div class="exp-ico" style="background:${bg}">${catIcon}</div>
    <div class="exp-info">
      <div class="exp-desc">${esc(e.desc)}</div>
      <div class="exp-meta">${e.paidBy==='me'?'You':esc(e.paidBy)} • ${esc(grpName)} • ${fmtDate(e.date)}</div>
      ${receipt?`<div class="receipt-badge" onclick="openBillLightbox('${e.id}','${esc(e.desc)}','${fmtDate(e.date)}')">📷 View Receipt</div>`:''}
    </div>
    <div class="exp-right">
      <div class="exp-total">${C(e.amount)}</div>
      <div class="exp-share ${shareClass}">${shareText}</div>
    </div>
    ${showActions?`<div class="exp-actions">
      <button class="camera-btn ${receipt?'has-receipt':''}" onclick="quickCameraForExp('${e.id}')" title="${receipt?'Change receipt photo':'Add receipt photo'}">📷</button>
      <button class="icon-btn" onclick="editExp('${e.id}')" title="Edit">✏️</button>
      <button class="icon-btn del" onclick="promptDelExp('${e.id}')" title="Delete">🗑</button>
    </div>`:''}
  </div>`;
}

function renderDashExpenses() {
  const sorted=[...S.expenses].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
  document.getElementById('dash-exps').innerHTML=sorted.length?sorted.map(e=>expHTML(e)).join(''):`<div class="empty"><span class="empty-icon">💸</span><h3>No expenses yet</h3><p>Add your first expense to get started</p></div>`;
}

function renderSidebarGroups() {
  const colMap={teal:'#4fffb0',red:'#ff5e6c',purple:'#a78bfa',yellow:'#ffc94d',blue:'#60a5fa'};
  document.getElementById('sidebar-groups-list').innerHTML=S.groups.map(g=>`
    <div class="nav-item" onclick="openGroupDetail(${g.id})">
      <div class="group-dot" style="background:${colMap[g.color]||'#4fffb0'}"></div>
      <span style="flex:1;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(g.name)}</span>
      <button class="leave-btn" onclick="event.stopPropagation();promptExit(${g.id})" title="Leave">✕</button>
    </div>`).join('');
}

function renderGroups() {
  document.getElementById('grp-count-txt').textContent=S.groups.length?`${S.groups.length} group${S.groups.length>1?'s':''}`:'Create your first group';
  document.getElementById('groups-grid').innerHTML=S.groups.length?S.groups.map(g=>{
    const bal=S.expenses.filter(e=>e.groupId===g.id&&!e.settled).reduce((s,e)=>s+(e.share==='owed'?e.shareAmt:e.share==='owe'?-e.shareAmt:0),0);
    const expCount=S.expenses.filter(e=>e.groupId===g.id).length;
    const receiptCount=S.expenses.filter(e=>e.groupId===g.id&&DB.getReceipt(S.user,e.id)).length;
    return `<div class="group-card gc-${g.color}" onclick="openGroupDetail(${g.id})"
      onmousemove="this.style.setProperty('--mx',event.offsetX/this.offsetWidth*100+'%');this.style.setProperty('--my',event.offsetY/this.offsetHeight*100+'%')">
      <div class="group-emoji">${g.type.split(' ')[0]}</div>
      <div class="group-name">${esc(g.name)}</div>
      <div class="group-members">${g.members.length} member${g.members.length>1?'s':''} • ${expCount} expense${expCount!==1?'s':''}${receiptCount>0?` • 📷 ${receiptCount}`:''}
      </div>
      <div class="group-bal" style="color:${bal>=0?'var(--green)':'var(--red)'}">${bal>=0?'+':''}${C(bal)}</div>
      <div class="group-actions">
        <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openModal('exp-modal');setExpGroup(${g.id})" style="flex:1">+ Expense</button>
        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();promptExit(${g.id})">Leave</button>
      </div>
    </div>`;
  }).join(''):`<div class="empty" style="grid-column:1/-1"><span class="empty-icon">👥</span><h3>No groups yet</h3><p>Create a group to split expenses with friends</p></div>`;
}

function renderExpenses() {
  let exps=[...S.expenses].sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(S.expFilter==='owe')exps=exps.filter(e=>e.share==='owe'&&!e.settled);
  else if(S.expFilter==='owed')exps=exps.filter(e=>e.share==='owed'&&!e.settled);
  else if(S.expFilter==='settled')exps=exps.filter(e=>e.settled);
  document.getElementById('exp-count-txt').textContent=`${exps.length} transaction${exps.length!==1?'s':''}`;
  document.getElementById('all-exps').innerHTML=exps.length?exps.map(e=>expHTML(e)).join(''):`<div class="empty"><span class="empty-icon">📋</span><h3>Nothing here</h3><p>No expenses match this filter</p></div>`;
}

function filterExps(el,f) {
  S.expFilter=f;
  document.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');renderExpenses();
}

function renderBalances() {
  const people={};
  S.expenses.filter(e=>!e.settled).forEach(e=>{
    if(e.share==='owe'&&e.paidBy!=='me')people[e.paidBy]=(people[e.paidBy]||0)-e.shareAmt;
    else if(e.share==='owed'&&e.paidBy==='me'){
      const grp=S.groups.find(g=>g.id===e.groupId);
      if(grp){const others=grp.members.filter(m=>m!=='You'&&m!=='me');const share=e.shareAmt/Math.max(others.length,1);others.forEach(m=>{people[m]=(people[m]||0)+share;});}
    }
  });
  const entries=Object.entries(people).filter(([,v])=>Math.abs(v)>0.01);
  const avatarColors=['#4fffb0','#a78bfa','#ffc94d','#ff5e6c','#60a5fa'];
  document.getElementById('bal-list').innerHTML=entries.length?entries.map(([name,amt],i)=>{
    const initials=name.split(' ').map(n=>n[0].toUpperCase()).join('').substring(0,2);
    const col=avatarColors[i%avatarColors.length];
    return `<div class="bal-item">
      <div class="bal-avatar" style="background:${col}22;color:${col}">${initials}</div>
      <div class="bal-info"><div class="bal-name">${esc(name)}</div><div class="bal-status" style="color:${amt>0?'var(--green)':'var(--red)'}">${amt>0?'Owes you':'You owe'}</div></div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="bal-amount" style="color:${amt>0?'var(--green)':'var(--red)'}">${amt>0?'+':''}${C(amt)}</div>
        ${amt<0?`<button class="settle-btn" onclick="settleUp('${esc(name)}',${Math.abs(amt).toFixed(2)})">Settle Up</button>`:''}
      </div>
    </div>`;
  }).join(''):`<div class="empty"><span class="empty-icon">⚖️</span><h3>All settled!</h3><p>No outstanding balances</p></div>`;
}

function renderActivity() {
  document.getElementById('act-list').innerHTML=S.activity.length?S.activity.slice(0,20).map(a=>`
    <div class="act-item">
      <div class="act-dot" style="background:${a.color}"></div>
      <div><div class="act-text">${a.text}</div><div class="act-time">${a.time}</div></div>
    </div>`).join(''):`<div class="empty"><span class="empty-icon">🔔</span><h3>No activity</h3><p>Your actions will appear here</p></div>`;
}

function renderProfile() {
  document.getElementById('prof-exp-count').textContent=S.expenses.length;
  document.getElementById('prof-grp-count').textContent=S.groups.length;
  document.getElementById('prof-spent').textContent=C(S.expenses.reduce((s,e)=>s+e.amount,0));
}

// ═══ EXPENSES ═══
function populateExpForm() {
  const sel=document.getElementById('e-grp');
  sel.innerHTML='<option value="">-- Personal --</option>'+S.groups.map(g=>`<option value="${g.id}">${esc(g.name)}</option>`).join('');
}

function setExpGroup(id) {
  document.getElementById('e-grp').value=id;updatePaidByOptions(id);
}

document.addEventListener('change',e=>{if(e.target.id==='e-grp')updatePaidByOptions(e.target.value);});

function updatePaidByOptions(groupId) {
  const pb=document.getElementById('e-paid');
  const grp=S.groups.find(g=>g.id==groupId);
  if(grp)pb.innerHTML='<option value="me">You</option>'+grp.members.filter(m=>m!=='You').map(m=>`<option value="${esc(m)}">${esc(m)}</option>`).join('');
  else pb.innerHTML='<option value="me">You</option>';
}

function setSplit(el,type) {
  S.selectedSplit=type;
  document.querySelectorAll('.split-opt').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
}

function editExp(id) {
  const e=S.expenses.find(x=>x.id===id);if(!e)return;
  S.editExpId=id;
  document.getElementById('exp-modal-title').textContent='Edit Expense';
  document.getElementById('save-exp-btn').textContent='Save Changes';
  document.getElementById('e-desc').value=e.desc;
  document.getElementById('e-amt').value=e.amount;
  document.getElementById('e-cat').value=e.category;
  document.getElementById('e-grp').value=e.groupId||'';
  updatePaidByOptions(e.groupId);
  document.getElementById('e-paid').value=e.paidBy;
  document.getElementById('e-date').value=e.date;
  document.getElementById('e-notes').value=e.notes||'';
  // Load existing receipt into modal preview
  const existing=DB.getReceipt(S.user,id);
  if(existing){S.pendingBillDataUrl=existing;showBillModalPreview(existing);}
  else{S.pendingBillDataUrl=null;clearBillUpload();}
  openModal('exp-modal');
}

function saveExpense() {
  const desc=document.getElementById('e-desc').value.trim();
  const amt=parseFloat(document.getElementById('e-amt').value);
  const cat=document.getElementById('e-cat').value;
  const groupId=document.getElementById('e-grp').value?parseInt(document.getElementById('e-grp').value):null;
  const paidBy=document.getElementById('e-paid').value;
  const date=document.getElementById('e-date').value||new Date().toISOString().split('T')[0];
  const notes=document.getElementById('e-notes').value;
  if(!desc)return toast('⚠️ Please enter a description');
  if(!amt||amt<=0)return toast('⚠️ Enter a valid amount');

  let share='none',shareAmt=0;
  const grp=groupId?S.groups.find(g=>g.id===groupId):null;
  const memberCount=grp?grp.members.length:2;
  if(S.selectedSplit==='no-split'){share='none';shareAmt=amt;}
  else if(paidBy==='me'){share='owed';shareAmt=+(amt*(memberCount-1)/memberCount).toFixed(2);}
  else{share='owe';shareAmt=+(amt/memberCount).toFixed(2);}
  if(S.selectedSplit==='you-paid'){share='owed';shareAmt=+(amt*(memberCount-1)/memberCount).toFixed(2);}

  let expId;
  if(S.editExpId) {
    expId=S.editExpId;
    const idx=S.expenses.findIndex(e=>e.id===expId);
    if(idx>-1)S.expenses[idx]={...S.expenses[idx],desc,amount:amt,category:cat,groupId,paidBy,date,notes,share,shareAmt};
    addActivity(`You updated expense <strong>${desc}</strong>`,'#ffc94d');
    toast('✅ Expense updated!');
  } else {
    expId=uid();
    S.expenses.unshift({id:expId,desc,amount:amt,category:cat,groupId,paidBy,date,notes,share,shareAmt,settled:false,created:new Date().toISOString()});
    addActivity(`You added <strong>${desc}</strong> — ${C(amt)}`,'#4fffb0');
    toast('✅ Expense added!');
  }

  // Save receipt if staged
  if(S.pendingBillDataUrl) {
    const saved=DB.saveReceipt(S.user,expId,S.pendingBillDataUrl);
    if(!saved)toast('⚠️ Receipt not saved — storage full. Try a smaller image.');
  }

  DB.saveExpenses(S.user,S.expenses);
  DB.saveActivity(S.user,S.activity);
  S.pendingBillDataUrl=null;
  resetExpForm();closeModal('exp-modal');renderAll();
}

function resetExpForm() {
  S.editExpId=null;S.pendingBillDataUrl=null;
  document.getElementById('exp-modal-title').textContent='Add Expense';
  document.getElementById('save-exp-btn').textContent='Add Expense';
  document.getElementById('e-desc').value='';
  document.getElementById('e-amt').value='';
  document.getElementById('e-notes').value='';
  document.getElementById('e-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('e-grp').value='';
  document.getElementById('e-paid').value='me';
  setSplit(document.querySelector('.split-opt'),'equal');
  clearBillUpload();
}

function promptDelExp(id){S.delExpId=id;openModal('del-exp-modal');}
function confirmDelExp() {
  const e=S.expenses.find(x=>x.id===S.delExpId);
  S.expenses=S.expenses.filter(x=>x.id!==S.delExpId);
  DB.deleteReceipt(S.user,S.delExpId); // remove receipt too
  DB.saveExpenses(S.user,S.expenses);
  addActivity(`You deleted expense <strong>${e?.desc||'expense'}</strong>`,'#ff5e6c');
  DB.saveActivity(S.user,S.activity);
  closeModal('del-exp-modal');renderAll();toast('🗑 Expense deleted');
}

// ═══ BILL RECEIPT ═══
function handleBillUpload(event) {
  const file=event.target.files[0];
  if(!file)return;
  compressAndPreview(file, dataUrl=>{
    S.pendingBillDataUrl=dataUrl;
    showBillModalPreview(dataUrl);
  });
  event.target.value=''; // reset so same file can be selected again
}

function handleBillDrop(event) {
  event.preventDefault();
  event.currentTarget.classList.remove('dragging');
  const file=event.dataTransfer.files[0];
  if(file&&file.type.startsWith('image/'))compressAndPreview(file,dataUrl=>{S.pendingBillDataUrl=dataUrl;showBillModalPreview(dataUrl);});
}

function compressAndPreview(file, callback) {
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      const maxW=1200,maxH=1600;
      let {width:w,height:h}=img;
      if(w>maxW||h>maxH){const ratio=Math.min(maxW/w,maxH/h);w=Math.round(w*ratio);h=Math.round(h*ratio);}
      canvas.width=w;canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      callback(canvas.toDataURL('image/jpeg',0.82));
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
}

function showBillModalPreview(dataUrl) {
  const zone=document.getElementById('bill-upload-zone');
  const placeholder=document.getElementById('bill-placeholder');
  const preview=document.getElementById('bill-modal-preview');
  const bar=document.getElementById('bill-preview-bar');
  zone.classList.add('has-image');
  placeholder.style.display='none';
  preview.src=dataUrl;preview.style.display='block';
  bar.style.display='flex';
}

function clearBillUpload() {
  S.pendingBillDataUrl=null;
  const zone=document.getElementById('bill-upload-zone');
  const placeholder=document.getElementById('bill-placeholder');
  const preview=document.getElementById('bill-modal-preview');
  const bar=document.getElementById('bill-preview-bar');
  zone.classList.remove('has-image');
  placeholder.style.display='block';
  preview.src='';preview.style.display='none';
  bar.style.display='none';
}

// Quick camera button — capture without opening full modal
function quickCameraForExp(expId) {
  const receipt=DB.getReceipt(S.user,expId);
  if(receipt) {
    // If receipt exists, show it in lightbox with option to change
    const e=S.expenses.find(x=>x.id===expId);
    openBillLightbox(expId,e?.desc||'Receipt',fmtDate(e?.date||''));
    return;
  }
  S.quickBillExpId=expId;
  document.getElementById('quick-bill-input').click();
}

function handleQuickBillUpload(event) {
  const file=event.target.files[0];
  if(!file||!S.quickBillExpId)return;
  compressAndPreview(file,dataUrl=>{
    const saved=DB.saveReceipt(S.user,S.quickBillExpId,dataUrl);
    if(saved){
      toast('📷 Receipt saved!');
      const e=S.expenses.find(x=>x.id===S.quickBillExpId);
      if(e){addActivity(`Receipt added to <strong>${e.desc}</strong>`,'#60a5fa');DB.saveActivity(S.user,S.activity);}
      renderAll();
      if(S.activeGroupId&&document.getElementById('page-group-detail').classList.contains('active'))renderGroupDetail();
    } else {
      toast('⚠️ Could not save receipt — storage may be full');
    }
    S.quickBillExpId=null;
  });
  event.target.value='';
}

// ═══ BILL LIGHTBOX ═══
function openBillLightbox(expId, desc, dateTxt) {
  const dataUrl=DB.getReceipt(S.user,expId);
  if(!dataUrl)return toast('No receipt attached');
  S.lightboxExpId=expId;
  document.getElementById('lb-img').src=dataUrl;
  document.getElementById('lb-title').textContent=desc;
  document.getElementById('lb-meta').textContent=dateTxt;
  document.getElementById('bill-lightbox').classList.add('open');
  document.body.style.overflow='hidden';
}

function closeBillLightbox() {
  document.getElementById('bill-lightbox').classList.remove('open');
  document.getElementById('lb-img').src='';
  document.body.style.overflow='';
  S.lightboxExpId=null;
}

function downloadBill() {
  const src=document.getElementById('lb-img').src;
  if(!src||!src.startsWith('data:'))return;
  const a=document.createElement('a');
  a.href=src;
  a.download=`receipt-${document.getElementById('lb-title').textContent.replace(/\s+/g,'-')}.jpg`;
  a.click();
}

// ═══ GROUPS ═══
let newMembers=[];

function onMemberKey(e) {
  if(e.key==='Enter'||e.key===','){
    e.preventDefault();
    const val=e.target.value.trim().replace(',','');
    if(!val)return;
    newMembers.push(val);
    const tag=document.createElement('div');
    tag.className='member-tag';tag.dataset.name=val;
    tag.innerHTML=`${esc(val)} <span class="rm" onclick="removeMember(this)">✕</span>`;
    document.getElementById('member-area').insertBefore(tag,e.target);
    e.target.value='';
  }
}
function removeMember(el){const tag=el.parentElement;newMembers=newMembers.filter(m=>m!==tag.dataset.name);tag.remove();}
function pickColor(c) {
  S.selectedColor=c;
  ['teal','red','purple','yellow','blue'].forEach(col=>document.getElementById(`cd-${col}`).classList.toggle('active',col===c));
}
function saveGroup() {
  const name=document.getElementById('g-name').value.trim();
  const type=document.getElementById('g-type').value;
  if(!name)return toast('⚠️ Group name is required');
  const grp={id:Date.now(),name,type,color:S.selectedColor,members:['You',...newMembers],created:new Date().toISOString()};
  S.groups.push(grp);DB.saveGroups(S.user,S.groups);
  addActivity(`You created group <strong>${name}</strong>`,'#a78bfa');DB.saveActivity(S.user,S.activity);
  newMembers=[];
  document.getElementById('member-area').querySelectorAll('.member-tag').forEach(t=>t.remove());
  document.getElementById('g-name').value='';
  closeModal('grp-modal');renderAll();toast(`✅ Group "${name}" created!`);
}
function promptExit(id){S.exitGroupId=id;const g=S.groups.find(g=>g.id===id);document.getElementById('exit-grp-name').textContent=g?.name||'';openModal('exit-modal');}
function confirmExit() {
  const g=S.groups.find(g=>g.id===S.exitGroupId);
  S.groups=S.groups.filter(g=>g.id!==S.exitGroupId);DB.saveGroups(S.user,S.groups);
  DB.revokeInviteForGroup(S.user,S.exitGroupId);
  addActivity(`You left group <strong>${g?.name}</strong>`,'#ff5e6c');DB.saveActivity(S.user,S.activity);
  closeModal('exit-modal');renderAll();toast(`👋 Left group "${g?.name}"`);
  if(S.currentPage==='group-detail')goTo('groups');
}

// ── Add / Remove members inline ──
function toggleAddMemberRow() {
  const row=document.getElementById('add-member-row');
  const isOpen=row.style.display!=='none';
  row.style.display=isOpen?'none':'flex';
  if(!isOpen)document.getElementById('new-member-name').focus();
}

function addMemberToGroup() {
  const name=document.getElementById('new-member-name').value.trim();
  if(!name)return;
  const g=S.groups.find(x=>x.id===S.activeGroupId);
  if(!g)return;
  if(g.members.includes(name)||(g.pendingMembers||[]).includes(name))return toast(`⚠️ ${name} is already in this group`);
  g.members.push(name);
  DB.saveGroups(S.user,S.groups);
  document.getElementById('new-member-name').value='';
  document.getElementById('add-member-row').style.display='none';
  addActivity(`You added <strong>${esc(name)}</strong> to <strong>${esc(g.name)}</strong>`,'#4fffb0');
  DB.saveActivity(S.user,S.activity);
  renderGroupDetail();renderSidebarGroups();
  toast(`✅ ${name} added to group!`);
}

function removeMemberFromGroup(memberName) {
  if(!confirm(`Remove ${memberName} from this group?`))return;
  const g=S.groups.find(x=>x.id===S.activeGroupId);
  if(!g)return;
  g.members=g.members.filter(m=>m!==memberName);
  if(g.pendingMembers)g.pendingMembers=g.pendingMembers.filter(m=>m!==memberName);
  DB.saveGroups(S.user,S.groups);
  addActivity(`You removed <strong>${esc(memberName)}</strong> from <strong>${esc(g.name)}</strong>`,'#ffc94d');
  DB.saveActivity(S.user,S.activity);
  renderGroupDetail();toast(`🗑 ${memberName} removed`);
}

// ── INVITE SYSTEM ──
let S_inviteGroupId = null;
let S_inviteToken = null;

function openInviteModal(groupId) {
  S_inviteGroupId = groupId;
  const g = S.groups.find(x=>x.id===groupId);
  if(!g)return;
  // Fill group strip
  document.getElementById('inv-grp-emoji').textContent=g.type.split(' ')[0];
  document.getElementById('inv-grp-name').textContent=g.name;
  document.getElementById('inv-grp-meta').textContent=`${g.members.length} member${g.members.length>1?'s':''}`;
  // Reset direct-add list
  document.getElementById('inv-added-list').innerHTML='';
  document.getElementById('inv-direct-name').value='';
  // Default tab
  switchInviteTab('link', document.querySelector('.invite-tab'));
  // Generate or reuse invite token
  const existing = findExistingToken(groupId);
  S_inviteToken = existing || DB.createInviteToken(S.user, groupId, g.name);
  updateInviteLinkDisplay();
  openModal('invite-modal');
}

function findExistingToken(groupId) {
  const invites = DB.getInvites();
  return Object.keys(invites).find(t => invites[t].groupOwner===S.user && invites[t].groupId===groupId) || null;
}

function buildInviteURL(token) {
  const base = window.location.href.split('?')[0].split('#')[0];
  return `${base}?join=${token}`;
}

function updateInviteLinkDisplay() {
  const url = buildInviteURL(S_inviteToken);
  document.getElementById('inv-link-text').textContent = url;
  document.getElementById('copy-link-btn').textContent = 'Copy';
  document.getElementById('copy-link-btn').classList.remove('copied');
  // Render QR if visible
  if(document.getElementById('inv-panel-qr').classList.contains('active')) renderQRCode(url);
  // Render share apps
  renderShareApps(url);
}

function switchInviteTab(tab, el) {
  document.querySelectorAll('.invite-tab').forEach(t=>t.classList.remove('active'));
  // find clicked element — may pass button element or just tab name
  document.querySelectorAll('.invite-tab').forEach(t=>{if(t.textContent.toLowerCase().includes(tab))t.classList.add('active');});
  document.querySelectorAll('.invite-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById(`inv-panel-${tab}`).classList.add('active');
  if(tab==='qr'&&S_inviteToken) renderQRCode(buildInviteURL(S_inviteToken));
  if(tab==='apps'&&S_inviteToken) renderShareApps(buildInviteURL(S_inviteToken));
}

function copyInviteLink() {
  const url = buildInviteURL(S_inviteToken);
  navigator.clipboard.writeText(url).then(()=>{
    const btn = document.getElementById('copy-link-btn');
    btn.textContent = '✓ Copied!';btn.classList.add('copied');
    setTimeout(()=>{btn.textContent='Copy';btn.classList.remove('copied');},2500);
    toast('🔗 Invite link copied to clipboard!');
  }).catch(()=>{
    // Fallback
    const el = document.createElement('textarea');
    el.value=url;document.body.appendChild(el);el.select();document.execCommand('copy');document.body.removeChild(el);
    toast('🔗 Link copied!');
  });
}

function regenerateInviteLink() {
  DB.revokeInviteForGroup(S.user, S_inviteGroupId);
  const g = S.groups.find(x=>x.id===S_inviteGroupId);
  S_inviteToken = DB.createInviteToken(S.user, S_inviteGroupId, g.name);
  updateInviteLinkDisplay();
  toast('🔄 New invite link generated');
}

function shareNative() {
  const url = buildInviteURL(S_inviteToken);
  const g = S.groups.find(x=>x.id===S_inviteGroupId);
  if(navigator.share) {
    navigator.share({
      title:`Join "${g?.name}" on SplitEase`,
      text:`Hey! Join my group "${g?.name}" on SplitEase to split expenses together.`,
      url
    }).catch(()=>{});
  } else {
    copyInviteLink();
  }
}

function renderShareApps(url) {
  const g = S.groups.find(x=>x.id===S_inviteGroupId);
  const text = encodeURIComponent(`Join "${g?.name}" on SplitEase — split expenses together! `);
  const encodedUrl = encodeURIComponent(url);
  const apps = [
    {icon:'💬',label:'WhatsApp',href:`https://wa.me/?text=${text}${encodedUrl}`},
    {icon:'✉️',label:'Email',href:`mailto:?subject=${encodeURIComponent(`Join ${g?.name} on SplitEase`)}&body=${text}${encodedUrl}`},
    {icon:'🐦',label:'Twitter/X',href:`https://twitter.com/intent/tweet?text=${text}&url=${encodedUrl}`},
    {icon:'📘',label:'Facebook',href:`https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}`},
    {icon:'💼',label:'LinkedIn',href:`https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`},
    {icon:'📲',label:'Telegram',href:`https://t.me/share/url?url=${encodedUrl}&text=${text}`},
    {icon:'📱',label:'SMS',href:`sms:?body=${text}${encodedUrl}`},
    {icon:'📋',label:'Copy',href:'#'},
  ];
  document.getElementById('share-apps-grid').innerHTML = apps.map(a=>
    `<a class="share-app-btn" href="${a.href}" target="_blank" rel="noopener" onclick="${a.label==='Copy'?'copyInviteLink();return false':''}">
      <span class="share-app-icon">${a.icon}</span>
      <span class="share-app-label">${a.label}</span>
    </a>`
  ).join('');
}

// QR Code generator (pure JS, no library needed)
function renderQRCode(text) {
  const canvas = document.getElementById('qr-canvas');
  if(!canvas)return;
  // Use a simple URL-based QR for simplicity — using Google Charts API approach but locally
  // We'll draw a styled placeholder with the link and use a QR API
  const size = Math.min(window.innerWidth - 100, 200);
  canvas.width = size; canvas.height = size;
  const ctx = canvas.getContext('2d');
  // Draw background
  ctx.fillStyle = '#ffffff';
  ctx.roundRect(0,0,size,size,12);ctx.fill();
  // Draw QR pattern using a simple encoding visual
  // For a real QR we use a data URL image approach via the API
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = () => {
    ctx.clearRect(0,0,size,size);
    ctx.fillStyle='#ffffff';ctx.fillRect(0,0,size,size);
    ctx.drawImage(img,10,10,size-20,size-20);
    // Add SplitEase logo in center
    ctx.fillStyle='rgba(255,255,255,0.9)';
    ctx.beginPath();ctx.arc(size/2,size/2,18,0,Math.PI*2);ctx.fill();
    ctx.font=`${Math.floor(size/10)}px serif`;
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('✂️',size/2,size/2);
  };
  img.onerror = () => {
    // Fallback: draw a simple pattern
    ctx.fillStyle='#0f1318';ctx.fillRect(0,0,size,size);
    ctx.fillStyle='#4fffb0';ctx.font=`${size/6}px sans-serif`;ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('✂️',size/2,size/2-20);
    ctx.font=`${size/16}px sans-serif`;ctx.fillStyle='#6b7a99';
    ctx.fillText('QR not available',size/2,size/2+20);
    ctx.fillText('Copy link instead →',size/2,size/2+40);
  };
  img.src=`https://api.qrserver.com/v1/create-qr-code/?size=${size}x${size}&data=${encodeURIComponent(text)}&color=07090f&bgcolor=ffffff&qzone=1`;
}

function downloadQR() {
  const canvas = document.getElementById('qr-canvas');
  if(!canvas)return;
  const a=document.createElement('a');
  a.download=`splitease-invite-qr.png`;
  a.href=canvas.toDataURL('image/png');
  a.click();toast('📱 QR code downloaded!');
}

// ── Add member directly from invite modal ──
function addMemberDirect() {
  const name=document.getElementById('inv-direct-name').value.trim();
  if(!name)return;
  const g=S.groups.find(x=>x.id===S_inviteGroupId);
  if(!g)return;
  if(g.members.includes(name)||(g.pendingMembers||[]).includes(name)){toast(`⚠️ ${name} is already in this group`);return;}
  g.members.push(name);
  DB.saveGroups(S.user,S.groups);
  document.getElementById('inv-direct-name').value='';
  // Update the added list display
  const list=document.getElementById('inv-added-list');
  const chip=document.createElement('div');
  chip.style.cssText='display:inline-flex;align-items:center;gap:6px;background:rgba(79,255,176,0.1);border:1px solid rgba(79,255,176,0.25);color:var(--accent);border-radius:8px;padding:4px 10px;font-size:12px;font-weight:600;margin:3px;';
  chip.innerHTML=`✓ ${esc(name)}`;
  list.appendChild(chip);
  addActivity(`You added <strong>${esc(name)}</strong> to <strong>${esc(g.name)}</strong>`,'#4fffb0');
  DB.saveActivity(S.user,S.activity);
  // Update group meta in modal
  document.getElementById('inv-grp-meta').textContent=`${g.members.length} member${g.members.length>1?'s':''}`;
  renderGroupMembers(g,S.expenses.filter(e=>e.groupId===g.id));
  renderSidebarGroups();
  toast(`✅ ${name} added to group!`);
}

// ── Handle incoming invite links on page load ──
function checkInviteLink() {
  const params = new URLSearchParams(window.location.search);
  const token = params.get('join');
  if(!token)return;
  const invite = DB.getInviteByToken(token);
  if(!invite){
    // Clean URL
    window.history.replaceState({},'',window.location.pathname);
    return;
  }
  // Show invite landing
  S.pendingInviteToken = token;
  S.pendingInvite = invite;
  showInviteLanding(invite);
}

function showInviteLanding(invite) {
  // If not logged in, show auth first with a notice
  if(!S.user) {
    // Store token in session for after login
    sessionStorage.setItem('se_pending_invite', JSON.stringify({token:S.pendingInviteToken, invite}));
    // Add a notice above auth card
    const brand=document.querySelector('.brand');
    if(brand){
      const notice=document.createElement('div');
      notice.style.cssText='background:rgba(79,255,176,0.1);border:1px solid rgba(79,255,176,0.3);border-radius:12px;padding:14px 18px;margin-bottom:16px;text-align:center;';
      notice.innerHTML=`<div style="font-size:18px;margin-bottom:6px">🎉</div><div style="font-weight:700;color:var(--accent);margin-bottom:4px">You're invited!</div><div style="font-size:13px;color:var(--muted)">Sign in or create an account to join <strong style="color:var(--text)">${esc(invite.groupName)}</strong></div>`;
      brand.parentNode.insertBefore(notice, brand.nextSibling);
    }
    window.history.replaceState({},'',window.location.pathname);
    return;
  }
  // Already logged in — accept invite
  acceptInvite(S.pendingInviteToken, invite);
}

function acceptInvite(token, invite) {
  // Find the group in the owner's storage
  const ownerGroups = DB.getGroups(invite.groupOwner);
  const targetGroup = ownerGroups.find(g=>g.id===invite.groupId);
  if(!targetGroup){toast('⚠️ This invite is no longer valid');window.history.replaceState({},'',window.location.pathname);return;}

  const users=DB.getUsers();
  const currentUser=users[S.user];
  const memberName=currentUser?.name?.split(' ')[0]||'Someone';

  // Check not already in group
  if(targetGroup.members.includes(memberName)){
    toast(`You're already in "${targetGroup.name}"!`);
    window.history.replaceState({},'',window.location.pathname);
    return;
  }

  // Add current user to the group in owner's storage
  targetGroup.members.push(memberName);
  DB.saveGroups(invite.groupOwner, ownerGroups);

  // Also add the group to current user's groups (copy of group)
  const alreadyHave = S.groups.find(g=>g.id===invite.groupId);
  if(!alreadyHave){
    S.groups.push({...targetGroup});
    DB.saveGroups(S.user, S.groups);
  }

  addActivity(`You joined group <strong>${esc(targetGroup.name)}</strong>`,'#4fffb0');
  DB.saveActivity(S.user,S.activity);

  window.history.replaceState({},'',window.location.pathname);
  renderAll();
  toast(`🎉 You joined "${targetGroup.name}"!`);

  // Navigate to the group detail
  setTimeout(()=>{
    const g=S.groups.find(g=>g.id===invite.groupId);
    if(g)openGroupDetail(g.id);
  },800);
}

// Check for pending invite after login
function checkPendingInviteAfterLogin() {
  const raw=sessionStorage.getItem('se_pending_invite');
  if(!raw)return;
  sessionStorage.removeItem('se_pending_invite');
  try{
    const {token,invite}=JSON.parse(raw);
    setTimeout(()=>acceptInvite(token,invite),600);
  }catch(e){}
}

// ═══ SETTLE ═══
function settleUp(person,amount) {
  S.settleTarget={person,amount};
  document.getElementById('settle-content').innerHTML=`<div style="background:rgba(79,255,176,0.06);border:1px solid rgba(79,255,176,0.2);border-radius:12px;padding:20px;text-align:center"><div style="font-size:13px;color:var(--muted);margin-bottom:6px">You owe</div><div style="font-size:20px;font-weight:700;margin-bottom:4px">${esc(person)}</div><div style="font-size:32px;font-weight:700;font-family:var(--mono);color:var(--green)">${C(amount)}</div></div>`;
  openModal('settle-modal');
}
function confirmSettle() {
  if(!S.settleTarget)return;
  const{person,amount}=S.settleTarget;
  S.expenses.forEach(e=>{if(!e.settled&&e.share==='owe'&&e.paidBy===person)e.settled=true;});
  DB.saveExpenses(S.user,S.expenses);
  addActivity(`You settled ${C(amount)} with <strong>${person}</strong>`,'#4fffb0');DB.saveActivity(S.user,S.activity);
  closeModal('settle-modal');renderAll();toast(`✅ Settled with ${person}!`);
}

// ═══ PROFILE ═══
async function saveProfile() {
  const name=document.getElementById('pf-name').value.trim();
  const currency=document.getElementById('pf-currency').value;
  if(!name)return toast('⚠️ Name cannot be empty');
  S.profile={...S.profile,name,currency};S.currency=currency;
  DB.saveProfile(S.user,S.profile);
  const u=DB._usersCache?.[S.user]||{};
  const initials=name.split(' ').filter(Boolean).map(n=>n[0].toUpperCase()).slice(0,2).join('');
  const updated={...u,name,initials};
  if(DB._usersCache) DB._usersCache[S.user]=updated;
  DB.saveUser(S.user,updated);
  document.getElementById('prof-name').textContent=name;
  document.getElementById('topbar-name').textContent=name.split(' ')[0];
  document.getElementById('topbar-avatar').textContent=initials;
  document.getElementById('prof-avatar').textContent=initials;
  renderAll();toast('✅ Profile saved!');
}

// ═══ EXPORT ═══
function exportCSV() {
  const rows=[['Date','Description','Category','Amount','Paid By','Group','Your Share','Status','Has Receipt']];
  S.expenses.forEach(e=>{
    const grp=e.groupId?(S.groups.find(g=>g.id===e.groupId)?.name||'?'):'Personal';
    const status=e.settled?'Settled':e.share==='owe'?'You Owe':e.share==='owed'?'Owed To You':'Personal';
    const hasReceipt=DB.getReceipt(S.user,e.id)?'Yes':'No';
    rows.push([e.date,e.desc,e.category,e.amount,e.paidBy==='me'?'You':e.paidBy,grp,e.shareAmt,status,hasReceipt]);
  });
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download=`splitease-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();toast('📤 CSV exported!');
}

// ═══ NAVIGATION ═══
function goTo(page) {
  if(S.currentPage&&S.currentPage!==page){
    if(!S.pageHistory)S.pageHistory=[];
    S.pageHistory.push(S.currentPage);
    if(S.pageHistory.length>10)S.pageHistory.shift();
  }
  S.currentPage=page;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const el=document.getElementById(`page-${page}`);if(el)el.classList.add('active');
  const navEl=document.getElementById(`nav-${page}`);if(navEl)navEl.classList.add('active');
  // Bottom nav highlights
  const bnMap={dashboard:'mbnav-dashboard',groups:'mbnav-groups',balances:'mbnav-balances'};
  document.querySelectorAll('.mob-bnav-item[id]').forEach(i=>i.classList.remove('active'));
  if(bnMap[page])document.getElementById(bnMap[page])?.classList.add('active');
  // Back button
  const backBtn=document.getElementById('mob-back-btn');
  if(backBtn){
    const deep=['group-detail','expenses','balances','activity','profile','groups'];
    if(deep.includes(page))backBtn.classList.add('visible');
    else{backBtn.classList.remove('visible');if(page==='dashboard')S.pageHistory=[];}
  }
  document.querySelector('.main')?.scrollTo({top:0,behavior:'smooth'});
  if(page==='expenses')renderExpenses();
  if(page==='groups')renderGroups();
  if(page==='balances')renderBalances();
  if(page==='activity')renderActivity();
}

function mobileGoBack() {
  if(!S.pageHistory)S.pageHistory=[];
  if(S.pageHistory.length>0){
    const prev=S.pageHistory.pop();
    S.currentPage=prev;
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.getElementById(`page-${prev}`)?.classList.add('active');
    document.getElementById(`nav-${prev}`)?.classList.add('active');
    const bnMap={dashboard:'mbnav-dashboard',groups:'mbnav-groups',balances:'mbnav-balances'};
    document.querySelectorAll('.mob-bnav-item[id]').forEach(i=>i.classList.remove('active'));
    if(bnMap[prev])document.getElementById(bnMap[prev])?.classList.add('active');
    const backBtn=document.getElementById('mob-back-btn');
    if(backBtn&&prev==='dashboard'){backBtn.classList.remove('visible');S.pageHistory=[];}
    document.querySelector('.main')?.scrollTo({top:0,behavior:'smooth'});
  } else {goTo('dashboard');}
}

// ═══ MOBILE MENU ═══
function toggleMobileMenu() {
  const drawer=document.getElementById('mob-drawer');
  const overlay=document.getElementById('mob-drawer-overlay');
  const btn=document.getElementById('mob-menu-btn');
  if(drawer.classList.contains('open')){closeMobileMenu();}
  else{
    renderMobileDrawerGroups();
    drawer.classList.add('open');
    overlay.style.display='block';setTimeout(()=>overlay.style.opacity='1',10);
    btn?.classList.add('open');
  }
}
function closeMobileMenu() {
  const drawer=document.getElementById('mob-drawer');
  const overlay=document.getElementById('mob-drawer-overlay');
  const btn=document.getElementById('mob-menu-btn');
  drawer.classList.remove('open');
  overlay.style.opacity='0';setTimeout(()=>overlay.style.display='none',300);
  btn?.classList.remove('open');
}
function mobGoTo(page){closeMobileMenu();setTimeout(()=>goTo(page),50);}
function renderMobileDrawerGroups() {
  const colMap={teal:'#4fffb0',red:'#ff5e6c',purple:'#a78bfa',yellow:'#ffc94d',blue:'#60a5fa'};
  const el=document.getElementById('mob-groups-list');if(!el)return;
  el.innerHTML=S.groups.length?S.groups.map(g=>`
    <div class="mob-nav-item" onclick="closeMobileMenu();setTimeout(()=>openGroupDetail(${g.id}),50)">
      <div style="width:8px;height:8px;border-radius:50%;background:${colMap[g.color]||'#4fffb0'};flex-shrink:0"></div>
      <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:13px">${esc(g.name)}</span>
      <span style="font-size:10px;color:var(--muted)">›</span>
    </div>`).join(''):`<div style="padding:8px 10px;font-size:12px;color:var(--muted2)">No groups yet</div>`;
}

// ═══ GROUP DETAIL ═══
const heroColors={teal:'#4fffb0',red:'#ff5e6c',purple:'#a78bfa',yellow:'#ffc94d',blue:'#60a5fa'};
const avatarPalette=['#4fffb0','#a78bfa','#ffc94d','#ff5e6c','#60a5fa','#fb923c','#34d399'];

function openGroupDetail(groupId) {
  S.activeGroupId=groupId;renderGroupDetail();
  goTo('group-detail');
  document.getElementById('nav-groups').classList.add('active');
}

function renderGroupDetail() {
  const g=S.groups.find(x=>x.id===S.activeGroupId);if(!g)return;
  const grpExps=S.expenses.filter(e=>e.groupId===g.id);
  const heroColor=heroColors[g.color]||'#4fffb0';
  document.getElementById('grp-detail-hero').style.setProperty('--hero-color',heroColor);
  document.getElementById('grp-detail-emoji').textContent=g.type.split(' ')[0];
  document.getElementById('grp-detail-name').textContent=g.name;
  document.getElementById('grp-detail-meta').textContent=`${g.members.length} member${g.members.length>1?'s':''} • Created ${new Date(g.created).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}`;
  document.getElementById('grp-detail-add-exp').onclick=()=>{openModal('exp-modal');setExpGroup(g.id);};
  document.getElementById('grp-detail-leave-btn').onclick=()=>promptExit(g.id);
  document.getElementById('grp-detail-invite-btn').onclick=()=>openInviteModal(g.id);
  document.getElementById('grp-panel-invite-btn').onclick=()=>openInviteModal(g.id);
  const total=grpExps.reduce((s,e)=>s+e.amount,0);
  const owed=grpExps.filter(e=>!e.settled&&e.share==='owed').reduce((s,e)=>s+e.shareAmt,0);
  const owe=grpExps.filter(e=>!e.settled&&e.share==='owe').reduce((s,e)=>s+e.shareAmt,0);
  document.getElementById('gd-total').textContent=C(total);
  document.getElementById('gd-owed').textContent=C(owed);
  document.getElementById('gd-owe').textContent=C(owe);
  document.getElementById('gd-exp-count').textContent=grpExps.length;
  renderGroupMembers(g,grpExps);
  renderGroupExpTimeline(g,grpExps,'all');
}

function renderGroupMembers(g,grpExps) {
  const mb={};
  g.members.forEach((m,i)=>{mb[m]={name:m,balance:0,paid:0,color:avatarPalette[i%avatarPalette.length],pending:false};});
  // Mark pending members (invited but not registered)
  const users=DB.getUsers();
  if(g.pendingMembers){g.pendingMembers.forEach((m,i)=>{if(!mb[m]){mb[m]={name:m,balance:0,paid:0,color:avatarPalette[(Object.keys(mb).length+i)%avatarPalette.length],pending:true};}});}
  grpExps.filter(e=>!e.settled).forEach(e=>{
    const payer=e.paidBy==='me'?'You':e.paidBy;
    const perHead=e.amount/g.members.length;
    g.members.forEach(m=>{
      if(!mb[m])return;
      if(m===payer||(e.paidBy==='me'&&m==='You')){mb[m].balance+=e.amount-perHead;mb[m].paid+=e.amount;}
      else mb[m].balance-=perHead;
    });
  });
  document.getElementById('grp-members-list').innerHTML=Object.values(mb).map(m=>{
    const initials=m.name.split(' ').map(n=>n[0].toUpperCase()).join('').substring(0,2);
    const isYou=m.name==='You';const bal=m.balance;
    const pendingTag=m.pending?`<span class="pending-tag">Invited</span>`:'';
    const removeBtn=(!isYou&&!m.pending)?`<button class="member-row-remove" onclick="removeMemberFromGroup('${esc(m.name)}')" title="Remove">✕</button>`:'';
    return `<div class="member-row${m.pending?' pending':''}">
      <div class="member-row-avatar" style="background:${m.color}22;color:${m.color}">${initials}</div>
      <div class="member-row-info">
        <div class="member-row-name">${esc(m.name)}${isYou?' <span style="font-size:10px;color:var(--muted)">(you)</span>':''}${pendingTag}</div>
        <div class="member-row-role">${m.pending?'Awaiting join':'Paid '+C(m.paid)}</div>
      </div>
      <div class="member-row-bal" style="color:${bal>0?'var(--green)':bal<0?'var(--red)':'var(--muted)'}">${m.pending?'—':(bal>0?'+':'')+C(bal)}</div>
      ${removeBtn}
    </div>`;
  }).join('');
}

function filterGroupExps() {
  const g=S.groups.find(x=>x.id===S.activeGroupId);if(!g)return;
  const filter=document.getElementById('gd-filter').value;
  renderGroupExpTimeline(g,S.expenses.filter(e=>e.groupId===g.id),filter);
}

function renderGroupExpTimeline(g,allExps,filter) {
  let exps=[...allExps].sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(filter==='owe')exps=exps.filter(e=>e.share==='owe'&&!e.settled);
  else if(filter==='owed')exps=exps.filter(e=>e.share==='owed'&&!e.settled);
  else if(filter==='settled')exps=exps.filter(e=>e.settled);
  if(!exps.length){
    document.getElementById('grp-detail-exps').innerHTML=`<div class="grp-empty"><span class="grp-empty-icon">💸</span><h3 style="font-size:16px;color:var(--text);margin-bottom:6px">No expenses yet</h3><p style="font-size:13px">Add the first expense to this group</p><button class="btn btn-primary btn-sm" style="margin-top:16px" onclick="openModal('exp-modal');setExpGroup(${g.id})">+ Add Expense</button></div>`;
    return;
  }
  document.getElementById('grp-detail-exps').innerHTML=exps.map(e=>{
    const catIcon=e.category.split(' ')[0];
    const bg=catColors[catIcon]||'rgba(107,122,153,0.12)';
    const paidBy=e.paidBy==='me'?'You':e.paidBy;
    const perHead=+(e.amount/g.members.length).toFixed(2);
    const shareClass=e.settled?'settled-txt':e.share==='owe'?'you-owe':e.share==='owed'?'owed-you':'settled-txt';
    const shareText=e.settled?'✓ Settled':e.share==='owe'?`You owe ${C(e.shareAmt)}`:e.share==='owed'?`Lent ${C(e.shareAmt)}`:'Personal';
    const receipt=DB.getReceipt(S.user,e.id);

    const splitRows=g.members.map((m,i)=>{
      const isPayerMember=(m==='You'&&e.paidBy==='me')||m===e.paidBy;
      const col=avatarPalette[i%avatarPalette.length];
      const initials=m.split(' ').map(n=>n[0].toUpperCase()).join('').substring(0,2);
      const badge=isPayerMember?`<span class="tc-badge tc-badge-paid">Paid</span>`:e.settled?`<span class="tc-badge tc-badge-settled">Settled</span>`:`<span class="tc-badge tc-badge-owed">Owes</span>`;
      return `<div class="tc-split-row">
        <div class="tc-split-person">
          <div style="width:22px;height:22px;border-radius:50%;background:${col}22;color:${col};display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700">${initials}</div>
          ${esc(m)}${badge}
        </div>
        <div class="tc-split-amt" style="color:${isPayerMember?'var(--green)':'var(--muted)'}">${isPayerMember?`+${C(e.amount-perHead)}`:`-${C(perHead)}`}</div>
      </div>`;
    }).join('');

    const receiptSection=receipt?`
      <div class="tc-receipt" onclick="openBillLightbox('${e.id}','${esc(e.desc)}','${fmtDate(e.date)}')">
        <img src="${receipt}" alt="Receipt for ${esc(e.desc)}" loading="lazy">
        <div class="tc-receipt-label">📷 Tap to view full receipt</div>
      </div>`:'';

    return `<div class="exp-timeline-item">
      <div class="timeline-connector">
        <div class="timeline-dot"></div>
        <div class="timeline-line"></div>
      </div>
      <div class="timeline-card">
        <div class="tc-top">
          <div style="flex:1;min-width:0">
            <div style="display:flex;align-items:center;gap:8px">
              <div style="width:32px;height:32px;border-radius:9px;background:${bg};display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0">${catIcon}</div>
              <div class="tc-desc">${esc(e.desc)}</div>
            </div>
            <div class="tc-meta" style="margin-top:6px;margin-left:40px">${esc(paidBy)} paid • ${fmtDate(e.date)}</div>
          </div>
          <div style="display:flex;align-items:flex-start;gap:6px;flex-shrink:0">
            <div style="text-align:right">
              <div class="tc-amount">${C(e.amount)}</div>
              <div class="exp-share ${shareClass}" style="font-size:11px;margin-top:2px">${shareText}</div>
            </div>
            <div class="tc-actions">
              <button class="camera-btn ${receipt?'has-receipt':''}" onclick="quickCameraForExp('${e.id}')" title="${receipt?'View/change receipt':'Add receipt photo'}">📷</button>
              <button class="icon-btn" onclick="editExp('${e.id}')" title="Edit">✏️</button>
              <button class="icon-btn del" onclick="promptDelExp('${e.id}')" title="Delete">🗑</button>
            </div>
          </div>
        </div>
        <div class="tc-splits">${splitRows}</div>
        ${e.notes?`<div class="tc-notes">📝 ${esc(e.notes)}</div>`:''}
        ${receiptSection}
      </div>
    </div>`;
  }).join('');
}

// ═══ MODALS ═══
function openModal(id) {
  if(id==='exp-modal'){populateExpForm();if(!S.editExpId)resetExpForm();}
  document.getElementById(id).classList.add('open');
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  if(id==='exp-modal')resetExpForm();
}
document.querySelectorAll('.overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    document.querySelectorAll('.overlay.open').forEach(o=>o.classList.remove('open'));
    closeBillLightbox();
  }
});

// ═══ UTILS ═══
function addActivity(text,color='#4fffb0'){S.activity.unshift({text,color,time:'Just now'});if(S.activity.length>50)S.activity=S.activity.slice(0,50);}
function toast(msg,dur=3500){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),dur);}
function uid(){return Math.random().toString(36).substring(2,9)+Date.now().toString(36);}
function now(){return new Date().toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});}
function fmtDate(d){return new Date(d+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}


// ═══════════════════════════════════════════════
//  ADMIN PANEL — SplitEase
//  Credentials: change ADMIN_EMAIL / set password
//  on first login via Settings tab
// ═══════════════════════════════════════════════

// ADM_CFG_KEY removed — config now in Firebase
const ADM_AUDIT_KEY = 'se_admin_audit'; // stored in Firebase
const ADM_BC_KEY    = 'se_admin_bc'; // stored in Firebase
// ADM_BAN_KEY removed — ban list now in Firebase

// ── Config helpers ──
// admCfg/saveAdmCfg defined in Firebase section above

// Admin config loaded from Firebase via loadAdmCfg()


// ── Admin Config (Firebase-backed) ──
let _admCfgCache = { email:'admin@splitease.com', passHash:'', maintenance:false, registrations:true, invites:true };
async function loadAdmCfg() {
  try {
    const cfg = await DB.getAdminCfg();
    if(cfg) _admCfgCache = cfg;
    if(!_admCfgCache.passHash){
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode('Admin@2024'));
      _admCfgCache.passHash = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
      await DB.saveAdminCfg(_admCfgCache);
    }
  } catch(e){ console.warn('Could not load admin config', e); }
}
function admCfg() { return _admCfgCache; }
function saveAdmCfg(c){ _admCfgCache = c; DB.saveAdminCfg(c); }

// ── Audit log ──
function admAudit(action, detail=''){
  const log = JSON.parse(localStorage.getItem(ADM_AUDIT_KEY)||'[]');
  log.unshift({action, detail, time: new Date().toISOString()});
  if(log.length>300) log.length=300;
  localStorage.setItem(ADM_AUDIT_KEY, JSON.stringify(log));
}
function clearAuditLog(){
  localStorage.removeItem(ADM_AUDIT_KEY);
  renderAuditLog();
  toast('🗑 Audit log cleared');
}

// ── Ban helpers ──
function getBanned(){ return DB.getBanned(); }
function saveBanned(b){ DB.saveBanned(b); }

// ── State ──
let ADM = { on:false, page:'overview', uPage:0, uPer:10 };

// ── Open admin panel ──
async function openAdminPanel(){
  document.getElementById('auth-screen').classList.remove('active');
  document.getElementById('app-screen').classList.remove('active');
  document.getElementById('admin-screen').classList.add('active');
  await loadAdmCfg();
  if(ADM.on){ showAdminApp(); } else { showAdminLogin(); }
}

function showAdminLogin(){
  document.getElementById('admin-login-view').style.display='flex';
  document.getElementById('admin-app-view').style.display='none';
  document.getElementById('adm-err').textContent='';
}
async function showAdminApp(){
  document.getElementById('admin-login-view').style.display='none';
  document.getElementById('admin-app-view').style.display='flex';
  // Reload fresh data from Firebase
  await DB.loadAllUsers();
  await DB.loadBanned();
  await DB.loadInvites();
  const cfg=admCfg();
  document.getElementById('adm-topbar-email').textContent=cfg.email;
  const t=new Date();
  document.getElementById('adm-topbar-time').textContent=t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  document.getElementById('adm-refresh-time').textContent='Loaded '+t.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const ub=document.getElementById('adm-user-badge');
  if(ub) ub.textContent=Object.keys(DB.getUsers()).length;
  adminGoTo('overview');
  loadSettingsUI();
}

function exitAdminScreen(){
  document.getElementById('admin-screen').classList.remove('active');
  if(S.user){
    document.getElementById('app-screen').classList.add('active');
  } else {
    document.getElementById('auth-screen').classList.add('active');
  }
}

async function adminLogin(){
  const email = document.getElementById('adm-email').value.trim().toLowerCase();
  const pass  = document.getElementById('adm-pass').value;
  const errEl = document.getElementById('adm-err');
  errEl.textContent='';
  if(!email||!pass){ errEl.textContent='Please fill in both fields'; return; }
  await loadAdmCfg();
  const cfg = admCfg();
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pass));
  const hash = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  if(email!==cfg.email || hash!==cfg.passHash){
    errEl.textContent='🚫 Invalid credentials';
    admAudit('FAILED_LOGIN', email);
    return;
  }
  ADM.on=true;
  sessionStorage.setItem('se_admin','1');
  admAudit('LOGIN');
  showAdminApp();
}

function adminLogout(){
  ADM.on=false;
  sessionStorage.removeItem('se_admin');
  admAudit('LOGOUT');
  showAdminLogin();
}

function adminGoTo(page){
  ADM.page=page;
  document.querySelectorAll('.adm-nav').forEach(n=>n.classList.remove('active'));
  document.querySelectorAll('.adm-page').forEach(p=>p.classList.remove('active'));
  const navEl=document.getElementById('adm-nav-'+page);
  const pageEl=document.getElementById('adm-page-'+page);
  if(navEl) navEl.classList.add('active');
  if(pageEl) pageEl.classList.add('active');
  const renderers = {
    overview: renderAdminOverview,
    users: renderAdminUsers,
    sessions: renderAdminSessions,
    groups: renderAdminGroups,
    expenses: renderAdminExpenses,
    broadcast: renderBCHistory,
    logs: renderAuditLog,
    settings: loadSettingsUI,
  };
  if(renderers[page]) renderers[page]();
}

// ─── OVERVIEW ─────────────────────────────────────
function renderAdminOverview(){
  const users = DB.getUsers();
  const emails = Object.keys(users);
  let totalGrp=0, totalExp=0, totalSpent=0;
  // Load fresh data for all users for accurate stats
  const invites=Object.keys(DB.getInvites()).length;
  const banned=getBanned().length;
  totalGrp=0;totalExp=0;totalSpent=0;
  emails.forEach(e=>{
    // Use cached data - requires user to have logged in to be counted in detail
    const exps=DB.getExpenses(e)||[];
    totalGrp+=(DB.getGroups(e)||[]).length;
    totalExp+=exps.length;
    totalSpent+=exps.reduce((s,x)=>s+(x.amount||0),0);
  });
  document.getElementById('adm-overview-sub').textContent='Last updated '+new Date().toLocaleString();

  const stats=[
    {icon:'👥',val:emails.length,label:'Total Users',sub:'Registered accounts',color:'#a78bfa'},
    {icon:'🏘',val:totalGrp,label:'Total Groups',sub:'Across all users',color:'#4fffb0'},
    {icon:'💸',val:totalExp,label:'Total Expenses',sub:'All transactions',color:'#60a5fa'},
    {icon:'💰',val:'$'+totalSpent.toFixed(0),label:'Total Tracked',sub:'Combined spending',color:'#ffc94d'},
    {icon:'🔗',val:invites,label:'Active Invites',sub:'Open invite links',color:'#fb923c'},
    {icon:'🚫',val:banned,label:'Banned Users',sub:'Suspended accounts',color:'#ff5e6c'},
  ];
  document.getElementById('adm-stats-grid').innerHTML=stats.map(s=>`
    <div class="adm-stat">
      <div class="adm-stat-accent" style="background:${s.color}"></div>
      <div class="adm-stat-icon">${s.icon}</div>
      <div class="adm-stat-val">${s.val}</div>
      <div class="adm-stat-label">${s.label}</div>
      <div class="adm-stat-sub">${s.sub}</div>
    </div>`).join('');

  // Registration chart
  const monthMap={};
  emails.forEach(e=>{
    const d=new Date(users[e].joined);
    const k=d.toLocaleDateString('en-US',{month:'short',year:'2-digit'});
    monthMap[k]=(monthMap[k]||0)+1;
  });
  const months=Object.entries(monthMap).slice(-7);
  const maxR=Math.max(...months.map(m=>m[1]),1);
  const barC=['#a78bfa','#60a5fa','#4fffb0','#ffc94d','#ff5e6c','#fb923c','#34d399'];
  document.getElementById('adm-reg-chart').innerHTML=months.length
    ? months.map((m,i)=>`<div class="adm-chart-row"><div class="adm-chart-lbl">${m[0]}</div><div class="adm-bar-wrap"><div class="adm-bar" style="width:${Math.round((m[1]/maxR)*100)}%;background:${barC[i%barC.length]}">${m[1]}</div></div></div>`).join('')
    : '<div style="color:var(--muted);font-size:13px;padding:8px 0">No registrations yet</div>';

  // Top groups
  const gData=[];
  emails.forEach(e=>DB.getGroups(e).forEach(g=>{
    const ec=DB.getExpenses(e).filter(x=>x.groupId===g.id).length;
    gData.push({name:g.name,ec,owner:users[e]?.name||e});
  }));
  gData.sort((a,b)=>b.ec-a.ec);
  const topG=gData.slice(0,6);
  const maxG=Math.max(...topG.map(g=>g.ec),1);
  document.getElementById('adm-top-groups').innerHTML=topG.length
    ? topG.map((g,i)=>`<div class="adm-chart-row"><div class="adm-chart-lbl" title="${g.name}">${g.name}</div><div class="adm-bar-wrap"><div class="adm-bar" style="width:${Math.round((g.ec/maxG)*100)}%;background:${barC[i%barC.length]}">${g.ec}</div></div></div>`).join('')
    : '<div style="color:var(--muted);font-size:13px;padding:8px 0">No groups yet</div>';

  // Recent activity across all users
  const allActs=[];
  emails.forEach(e=>DB.getActivity(e).slice(0,4).forEach(a=>allActs.push({...a,uName:users[e]?.name||e})));
  document.getElementById('adm-recent-act').innerHTML=allActs.slice(0,12).map(a=>`
    <div style="display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="width:8px;height:8px;border-radius:50%;background:${a.color||'#4fffb0'};margin-top:5px;flex-shrink:0"></div>
      <div><div style="font-size:13px">${a.text} <span style="color:var(--muted);font-size:11px">— ${esc(a.uName)}</span></div>
      <div style="font-size:11px;color:var(--muted2);margin-top:2px">${a.time||''}</div></div>
    </div>`).join('') || '<div style="color:var(--muted);font-size:13px;padding:8px 0">No activity yet</div>';
}

// ─── USERS ────────────────────────────────────────
function renderAdminUsers(){
  const users=DB.getUsers();
  const emails=Object.keys(users);
  const q=(document.getElementById('adm-user-search')?.value||'').toLowerCase();
  const banned=getBanned();
  const cfg=admCfg();
  const filtered=emails.filter(e=>!q||e.includes(q)||users[e].name.toLowerCase().includes(q));
  const total=filtered.length;
  const start=ADM.uPage*ADM.uPer;
  const page=filtered.slice(start,start+ADM.uPer);
  const pal=['#4fffb0','#a78bfa','#ffc94d','#ff5e6c','#60a5fa','#fb923c','#34d399'];

  document.getElementById('adm-users-title').textContent=`${total} User${total!==1?'s':''}`;
  const ub=document.getElementById('adm-user-badge');
  if(ub) ub.textContent=emails.length;

  document.getElementById('adm-users-tbody').innerHTML=page.map((email,i)=>{
    const u=users[email];
    const grpC=DB.getGroups(email).length;
    const expC=DB.getExpenses(email).length;
    const isBan=banned.includes(email);
    const isAdm=email===cfg.email;
    const init=u.initials||(u.name||'?')[0].toUpperCase();
    const col=pal[(start+i)%pal.length];
    const badge=isAdm?'<span class="badge-admin">🛡 Admin</span>':isBan?'<span class="badge-banned">🚫 Banned</span>':'<span class="badge-active">● Active</span>';
    return `<tr class="adm-tr">
      <td class="adm-td"><div style="display:flex;align-items:center;gap:10px">
        <div style="width:34px;height:34px;border-radius:50%;background:${col}22;color:${col};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0">${init}</div>
        <div><div style="font-weight:600;font-size:13px">${esc(u.name)}</div><div style="font-size:11px;color:var(--muted)">${esc(email)}</div></div>
      </div></td>
      <td class="adm-td" style="font-size:12px;color:var(--muted)">${new Date(u.joined).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</td>
      <td class="adm-td">${grpC}</td>
      <td class="adm-td">${expC}</td>
      <td class="adm-td">${badge}</td>
      <td class="adm-td"><div style="display:flex;gap:5px;flex-wrap:wrap">
        <button class="adm-btn" onclick="viewUserDetail('${esc(email)}')">👁 View</button>
        <button class="adm-btn purple" onclick="admImpersonate('${esc(email)}')">🎭 Login As</button>
        ${!isAdm?`<button class="adm-btn red" onclick="${isBan?'admUnban':'admBan'}('${esc(email)}')">${isBan?'✓ Unban':'🚫 Ban'}</button>`:''}
        ${!isAdm?`<button class="adm-btn red" onclick="admDeleteUser('${esc(email)}')">🗑</button>`:''}
      </div></td>
    </tr>`;
  }).join('')||`<tr><td colspan="6" style="padding:32px;text-align:center;color:var(--muted)">No users found</td></tr>`;

  // Pagination
  const pages=Math.ceil(total/ADM.uPer);
  document.getElementById('adm-users-info').textContent=`Showing ${Math.min(start+1,total)}–${Math.min(start+ADM.uPer,total)} of ${total}`;
  let pb=`<button class="pg-btn" onclick="admUPage(${ADM.uPage-1})" ${ADM.uPage===0?'disabled':''}>‹</button>`;
  for(let p=0;p<pages;p++) pb+=`<button class="pg-btn ${p===ADM.uPage?'on':''}" onclick="admUPage(${p})">${p+1}</button>`;
  pb+=`<button class="pg-btn" onclick="admUPage(${ADM.uPage+1})" ${ADM.uPage>=pages-1?'disabled':''}>›</button>`;
  document.getElementById('adm-users-pages').innerHTML=pb;
}
function admUPage(p){ ADM.uPage=p; renderAdminUsers(); }

function viewUserDetail(email){
  const users=DB.getUsers();
  const u=users[email];
  if(!u)return;
  const grps=DB.getGroups(email);
  const exps=DB.getExpenses(email);
  const totalSpent=exps.reduce((s,e)=>s+e.amount,0);
  const settled=exps.filter(e=>e.settled).length;
  const isBan=getBanned().includes(email);
  document.getElementById('adm-modal-title').textContent=u.name;
  document.getElementById('adm-modal-body').innerHTML=`
    <div style="display:flex;align-items:center;gap:14px;padding-bottom:16px;margin-bottom:16px;border-bottom:1px solid var(--border)">
      <div style="width:54px;height:54px;border-radius:50%;background:rgba(167,139,250,0.2);color:var(--purple);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;flex-shrink:0">${u.initials||'?'}</div>
      <div><div style="font-size:18px;font-weight:700">${esc(u.name)}</div><div style="font-size:13px;color:var(--muted);margin-top:2px">${esc(email)}</div><div style="margin-top:8px">${isBan?'<span class="badge-banned">🚫 Banned</span>':'<span class="badge-active">● Active</span>'}</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px">
      ${[['Joined',new Date(u.joined).toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'})],['Groups',grps.length],['Total Expenses',exps.length],['Total Spent','$'+totalSpent.toFixed(2)],['Settled',settled],['Outstanding',exps.length-settled]].map(([l,v])=>`<div style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px"><div style="font-size:10px;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:5px">${l}</div><div style="font-size:15px;font-weight:700;font-family:var(--mono)">${v}</div></div>`).join('')}
    </div>
    <div style="margin-bottom:16px">
      <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px">Groups (${grps.length})</div>
      ${grps.length?grps.map(g=>`<div style="display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--surface2);border-radius:8px;margin-bottom:6px;font-size:13px"><span>${g.type.split(' ')[0]}</span><span style="font-weight:600;flex:1">${esc(g.name)}</span><span style="color:var(--muted)">${g.members.length} members</span></div>`).join(''):'<div style="color:var(--muted);font-size:13px">No groups</div>'}
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      ${!isBan?`<button class="btn btn-danger btn-sm" onclick="admBan('${esc(email)}');closeModal('adm-user-modal')">🚫 Ban User</button>`:`<button class="btn btn-ghost btn-sm" onclick="admUnban('${esc(email)}');closeModal('adm-user-modal')">✓ Unban</button>`}
      <button class="btn btn-danger btn-sm" onclick="admDeleteUser('${esc(email)}');closeModal('adm-user-modal')">🗑 Delete Account</button>
      <button class="btn btn-ghost btn-sm" onclick="admImpersonate('${esc(email)}');closeModal('adm-user-modal')">🎭 Login As User</button>
    </div>`;
  openModal('adm-user-modal');
}

function admBan(email){
  if(!confirm(`Ban ${email}? They will be blocked from logging in.`))return;
  const b=getBanned(); if(!b.includes(email))b.push(email); saveBanned(b);
  admAudit('BAN_USER',email); renderAdminUsers(); toast(`🚫 ${email} banned`);
}
function admUnban(email){
  saveBanned(getBanned().filter(e=>e!==email));
  admAudit('UNBAN_USER',email); renderAdminUsers(); toast(`✅ ${email} unbanned`);
}
async function admDeleteUser(email){
  if(!confirm("Permanently delete "+email+" and ALL their data?"))return;
  await DB.deleteUserAllData(email);
  saveBanned(getBanned().filter(e=>e!==email));
  await DB.loadAllUsers();
  admAudit("DELETE_USER",email); renderAdminUsers(); renderAdminOverview();
  toast("Deleted "+email);
}
function admImpersonate(email){
  if(!DB.getUsers()[email])return toast('User not found');
  exitAdminScreen();
  toast(`🎭 Viewing as ${email}`);
  initApp(email);
  admAudit('IMPERSONATE',email);
}

// ─── SESSIONS ────────────────────────────────────
function renderAdminSessions(){
  const session=sessionStorage.getItem('se_session');
  const users=DB.getUsers();
  document.getElementById('adm-sessions-body').innerHTML=session&&users[session]
    ?`<div style="display:flex;align-items:center;gap:14px;padding:16px;background:rgba(79,255,176,0.05);border:1px solid rgba(79,255,176,0.15);border-radius:12px">
        <div style="width:12px;height:12px;border-radius:50%;background:var(--green);box-shadow:0 0 10px var(--green);flex-shrink:0;animation:pulse 2s infinite"></div>
        <div style="flex:1">
          <div style="font-weight:700">${esc(users[session].name)}</div>
          <div style="font-size:12px;color:var(--muted);margin-top:2px">${esc(session)}</div>
        </div>
        <span class="badge-active">● Active Now</span>
        <button class="adm-btn red" onclick="if(confirm('Force logout this user?')){sessionStorage.removeItem('se_session');renderAdminSessions();toast('User session ended');}">Force Logout</button>
      </div>`
    :'<div style="color:var(--muted);font-size:13px;padding:8px 0">No active user sessions right now</div>';
}

// ─── GROUPS ──────────────────────────────────────
function renderAdminGroups(){
  const users=DB.getUsers();
  const q=(document.getElementById('adm-group-search')?.value||'').toLowerCase();
  const all=[];
  Object.entries(users).forEach(([email,u])=>DB.getGroups(email).forEach(g=>{
    const ec=DB.getExpenses(email).filter(x=>x.groupId===g.id).length;
    all.push({...g,ownerEmail:email,ownerName:u.name||email,ec});
  }));
  const f=all.filter(g=>!q||g.name.toLowerCase().includes(q)||g.ownerName.toLowerCase().includes(q));
  const colMap={teal:'#4fffb0',red:'#ff5e6c',purple:'#a78bfa',yellow:'#ffc94d',blue:'#60a5fa'};
  document.getElementById('adm-groups-title').textContent=`${f.length} Group${f!==1?'s':''}`;
  document.getElementById('adm-groups-tbody').innerHTML=f.map(g=>`
    <tr class="adm-tr">
      <td class="adm-td"><div style="display:flex;align-items:center;gap:8px"><div style="width:8px;height:8px;border-radius:50%;background:${colMap[g.color]||'#4fffb0'};flex-shrink:0"></div><span style="font-weight:600">${esc(g.name)}</span><span style="font-size:11px;color:var(--muted);margin-left:4px">${g.type.split(' ')[0]}</span></div></td>
      <td class="adm-td"><div style="font-size:13px;font-weight:600">${esc(g.ownerName)}</div><div style="font-size:11px;color:var(--muted)">${esc(g.ownerEmail)}</div></td>
      <td class="adm-td">${g.members.length}</td>
      <td class="adm-td">${g.ec}</td>
      <td class="adm-td" style="font-size:12px;color:var(--muted)">${new Date(g.created).toLocaleDateString()}</td>
      <td class="adm-td"><button class="adm-btn red" onclick="admDeleteGroup('${esc(g.ownerEmail)}',${g.id},'${esc(g.name)}')">🗑 Delete</button></td>
    </tr>`).join('')||`<tr><td colspan="6" style="padding:32px;text-align:center;color:var(--muted)">No groups found</td></tr>`;
}
async function admDeleteGroup(ownerEmail,groupId,name){
  if(!confirm(`Delete group "${name}"?`))return;
  const grps=DB.getGroups(ownerEmail).filter(g=>g.id!==groupId);
  await DB.saveGroups(ownerEmail,grps);
  admAudit('DELETE_GROUP',`${name} (${ownerEmail})`);
  renderAdminGroups(); renderAdminOverview(); toast('🗑 Group deleted');
}

// ─── EXPENSES ────────────────────────────────────
function renderAdminExpenses(){
  const users=DB.getUsers();
  const q=(document.getElementById('adm-exp-search')?.value||'').toLowerCase();
  const all=[];
  Object.entries(users).forEach(([email,u])=>DB.getExpenses(email).forEach(e=>all.push({...e,uEmail:email,uName:u.name||email})));
  all.sort((a,b)=>new Date(b.date)-new Date(a.date));
  const f=all.filter(e=>!q||e.desc.toLowerCase().includes(q)||e.uName.toLowerCase().includes(q));
  document.getElementById('adm-exp-title').textContent=`${f.length} Expense${f.length!==1?'s':''}`;
  document.getElementById('adm-exp-tbody').innerHTML=f.slice(0,80).map(e=>`
    <tr class="adm-tr">
      <td class="adm-td" style="font-weight:600;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(e.desc)}</td>
      <td class="adm-td"><div style="font-size:13px">${esc(e.uName)}</div><div style="font-size:11px;color:var(--muted)">${esc(e.uEmail)}</div></td>
      <td class="adm-td" style="font-family:var(--mono);font-weight:700;color:var(--accent)">$${Number(e.amount).toFixed(2)}</td>
      <td class="adm-td" style="font-size:12px">${e.category||'—'}</td>
      <td class="adm-td" style="font-size:12px;color:var(--muted)">${e.date||'—'}</td>
      <td class="adm-td">${e.settled?'<span class="badge-active">Settled</span>':'<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;background:rgba(255,201,77,0.12);color:var(--yellow);border:1px solid rgba(255,201,77,0.2)">Pending</span>'}</td>
    </tr>`).join('')||`<tr><td colspan="6" style="padding:32px;text-align:center;color:var(--muted)">No expenses found</td></tr>`;
}

// ─── BROADCAST ────────────────────────────────────
function sendBroadcast(){
  const msg=document.getElementById('adm-bc-msg').value.trim();
  const color=document.getElementById('adm-bc-type').value;
  if(!msg)return toast('⚠️ Type a message first');
  const users=DB.getUsers(); let count=0;
  Object.keys(users).forEach(email=>{
    const acts=DB.getActivity(email);
    acts.unshift({text:`📢 <strong>Admin announcement:</strong> ${msg}`,color,time:now()});
    DB.saveActivity(email,acts); count++;
  });
  const bc=JSON.parse(localStorage.getItem(ADM_BC_KEY)||'[]');
  bc.unshift({msg,color,time:new Date().toISOString(),sentTo:count});
  localStorage.setItem(ADM_BC_KEY,JSON.stringify(bc));
  admAudit('BROADCAST',msg.slice(0,100));
  document.getElementById('adm-bc-msg').value='';
  renderBCHistory(); toast(`📢 Sent to ${count} user${count!==1?'s':''}!`);
}
function renderBCHistory(){
  const bc=JSON.parse(localStorage.getItem(ADM_BC_KEY)||'[]');
  document.getElementById('adm-bc-history').innerHTML=bc.slice(0,10).map(b=>`
    <div style="display:flex;align-items:flex-start;gap:10px;padding:11px 0;border-bottom:1px solid var(--border)">
      <div style="width:8px;height:8px;border-radius:50%;background:${b.color};margin-top:5px;flex-shrink:0"></div>
      <div><div style="font-size:13px">${esc(b.msg)}</div><div style="font-size:11px;color:var(--muted2);margin-top:2px">Sent to ${b.sentTo} users • ${new Date(b.time).toLocaleString()}</div></div>
    </div>`).join('')||'<div style="color:var(--muted);font-size:13px">No broadcasts sent yet</div>';
}

// ─── SETTINGS ────────────────────────────────────
const ADM_SETTINGS=[
  {key:'registrations',label:'Allow New Registrations',desc:'Let new users sign up for accounts',def:true},
  {key:'invites',label:'Allow Group Invite Links',desc:'Enable invite link & QR code generation',def:true},
  {key:'maintenance',label:'Maintenance Mode',desc:'Show a notice to regular users when enabled',def:false},
];
function loadSettingsUI(){
  const cfg=admCfg();
  document.getElementById('adm-settings-rows').innerHTML=ADM_SETTINGS.map(s=>`
    <div class="adm-setting-row">
      <div style="flex:1"><div class="setting-name" style="font-size:14px;font-weight:600">${s.label}</div><div style="font-size:12px;color:var(--muted);margin-top:2px">${s.desc}</div></div>
      <label class="adm-toggle">
        <input type="checkbox" ${(cfg[s.key]===undefined?s.def:cfg[s.key])?'checked':''} onchange="saveSetting('${s.key}',this.checked)">
        <span class="adm-toggle-track"></span>
      </label>
    </div>`).join('');
  const el=document.getElementById('st-adm-email');
  if(el) el.value=cfg.email;
}
function saveSetting(key,val){
  const cfg=admCfg(); cfg[key]=val; saveAdmCfg(cfg);
  admAudit('SETTING',`${key}=${val}`); toast('✅ Setting saved');
}
async function saveAdminCreds(){
  const email=(document.getElementById('st-adm-email')?.value||'').trim().toLowerCase();
  const pass=document.getElementById('st-adm-pass')?.value||'';
  if(!email)return toast('⚠️ Email required');
  const cfg={...admCfg(), email};
  if(pass){
    const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(pass));
    cfg.passHash=Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
  saveAdmCfg(cfg);
  await DB.saveAdminCfg(cfg);
  if(document.getElementById('st-adm-pass')) document.getElementById('st-adm-pass').value='';
  document.getElementById('adm-topbar-email').textContent=email;
  admAudit('UPDATE_CREDENTIALS',email); toast('✅ Admin credentials updated!');
}
function adminClearInvites(){
  if(!confirm('Clear ALL invite tokens? All invite links will stop working.'))return;
  DB.saveInvites({}); admAudit('CLEAR_INVITES'); renderAdminOverview(); toast('🔗 All invite tokens cleared');
}
function adminExportBackup(){
  const users=DB.getUsers();
  const backup={exportedAt:new Date().toISOString(),users:{}};
  Object.keys(users).forEach(email=>{
    backup.users[email]={profile:users[email],groups:DB.getGroups(email),expenses:DB.getExpenses(email),activity:DB.getActivity(email)};
  });
  backup.invites=DB.getInvites();
  const a=document.createElement('a');
  a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(backup,null,2));
  a.download=`splitease-backup-${new Date().toISOString().split('T')[0]}.json`;
  a.click(); admAudit('EXPORT_BACKUP'); toast('💾 Backup downloaded!');
}

// ─── AUDIT LOG ────────────────────────────────────
function renderAuditLog(){
  const log=JSON.parse(localStorage.getItem(ADM_AUDIT_KEY)||'[]');
  document.getElementById('adm-audit-body').innerHTML=log.slice(0,80).map(l=>`
    <div style="display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="width:8px;height:8px;border-radius:50%;background:var(--purple);margin-top:5px;flex-shrink:0"></div>
      <div><div style="font-size:13px;font-weight:600">${esc(l.action)}</div>${l.detail?`<div style="font-size:12px;color:var(--muted)">${esc(l.detail)}</div>`:''}<div style="font-size:11px;color:var(--muted2);margin-top:2px">${new Date(l.time).toLocaleString()}</div></div>
    </div>`).join('')||'<div style="color:var(--muted);font-size:13px;padding:8px 0">No actions logged yet</div>';
}

// ─── CSV EXPORTS ──────────────────────────────────
function exportUsersCSV(){
  const users=DB.getUsers(); const banned=getBanned();
  const rows=[['Name','Email','Joined','Groups','Expenses','Total Spent','Status']];
  Object.entries(users).forEach(([email,u])=>{
    const exps=DB.getExpenses(email);
    rows.push([u.name,email,new Date(u.joined).toLocaleDateString(),DB.getGroups(email).length,exps.length,'$'+exps.reduce((s,e)=>s+e.amount,0).toFixed(2),banned.includes(email)?'Banned':'Active']);
  });
  dlCSV(rows,'splitease-users'); admAudit('EXPORT_USERS',`${rows.length-1} users`);
}
function exportAllExpensesCSV(){
  const users=DB.getUsers();
  const rows=[['Date','Description','Category','Amount','User','Email','Group','Status']];
  Object.entries(users).forEach(([email,u])=>{
    const grps=DB.getGroups(email);
    DB.getExpenses(email).forEach(e=>{
      const gn=grps.find(g=>g.id===e.groupId)?.name||'Personal';
      rows.push([e.date,e.desc,e.category,e.amount,u.name,email,gn,e.settled?'Settled':'Pending']);
    });
  });
  dlCSV(rows,'splitease-all-expenses'); admAudit('EXPORT_EXPENSES',`${rows.length-1} expenses`);
}
function dlCSV(rows,name){
  const csv=rows.map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download=`${name}-${new Date().toISOString().split('T')[0]}.csv`;
  a.click(); toast('📥 CSV downloaded!');
}

// ─── HOOK: check ban on login ──────────────────────
const _origLogin = typeof login === 'function' ? login : null;
window._admOrigLogin = window.login;
window.login = async function(){
  const email=(document.getElementById('li-email')?.value||'').trim().toLowerCase();
  const banned=getBanned();
  if(banned.includes(email)){
    const el=document.getElementById('li-err');
    if(el){el.style.display='block';el.textContent='🚫 This account has been suspended. Contact support.';}
    return;
  }
  return window._admOrigLogin();
};

// ─── HOOK: admin button in profile ─────────────────
function injectAdminBtn(){
  const cfg=admCfg();
  if(S.user===cfg.email && !document.getElementById('adm-profile-btn')){
    const cards=document.querySelectorAll('#page-profile .profile-card');
    const last=cards[cards.length-1];
    if(last){
      const d=document.createElement('div');
      d.style.cssText='margin-top:14px;padding-top:14px;border-top:1px solid var(--border)';
      d.innerHTML=`<button id="adm-profile-btn" class="admin-access-btn" onclick="openAdminPanel()">🛡 Open Admin Panel</button>`;
      last.appendChild(d);
    }
  }
}

// ─── RESTORE ADMIN SESSION ─────────────────────────
window.addEventListener('load',()=>{
  if(sessionStorage.getItem('se_admin')==='1') ADM.on=true;
},false);

// Inject admin button after navigation to profile
const _origGoTo = window.goTo;
window.goTo = function(page){
  _origGoTo(page);
  if(page==='profile') setTimeout(injectAdminBtn, 100);
};

</script>

<!-- ═══════════════ ADMIN SCREEN ═══════════════ -->
<div id="admin-screen" class="screen">

  <!-- ADMIN LOGIN -->
  <div id="admin-login-view" style="display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;background:radial-gradient(ellipse 70% 50% at 50% 0%,rgba(167,139,250,0.1) 0%,transparent 60%),var(--bg)">
    <div style="width:100%;max-width:420px">
      <div style="text-align:center;margin-bottom:32px">
        <div style="width:60px;height:60px;border-radius:20px;background:linear-gradient(135deg,var(--purple),#60a5fa);display:flex;align-items:center;justify-content:center;font-size:26px;margin:0 auto 14px;box-shadow:0 0 40px rgba(167,139,250,0.4)">🛡</div>
        <div style="font-size:26px;font-weight:800">Admin<span style="color:var(--purple)">Panel</span></div>
        <div style="font-size:13px;color:var(--muted);margin-top:4px">SplitEase — Restricted Access</div>
      </div>
      <div style="background:var(--surface);border:1px solid rgba(167,139,250,0.25);border-radius:20px;padding:32px;box-shadow:0 30px 80px rgba(0,0,0,0.6)">
        <div style="display:inline-flex;align-items:center;gap:7px;background:rgba(167,139,250,0.12);border:1px solid rgba(167,139,250,0.3);color:var(--purple);border-radius:20px;padding:5px 13px;font-size:12px;font-weight:700;letter-spacing:0.5px;margin-bottom:20px">🛡 AUTHORISED PERSONNEL ONLY</div>
        <div class="form-group"><label>Admin Email</label><input type="email" id="adm-email" placeholder="your@email.com" autocomplete="off" onkeydown="if(event.key==='Enter')adminLogin()"></div>
        <div class="form-group"><label>Admin Password</label><input type="password" id="adm-pass" placeholder="••••••••" onkeydown="if(event.key==='Enter')adminLogin()"></div>
        <div id="adm-err" style="font-size:12px;color:var(--red);margin-bottom:12px;min-height:18px;text-align:center"></div>
        <button class="btn btn-primary" style="background:linear-gradient(135deg,var(--purple),#60a5fa);color:white" onclick="adminLogin()">🛡 Access Admin Panel →</button>
        <div style="text-align:center;margin-top:16px;font-size:12px;color:var(--muted)"><a onclick="exitAdminScreen()" style="cursor:pointer;color:var(--muted);text-decoration:underline">← Back to SplitEase</a></div>
      </div>
    </div>
  </div>

  <!-- ADMIN APP (shown after login) -->
  <div id="admin-app-view" style="display:none;flex-direction:column;flex:1;min-height:100vh">

    <!-- Admin Topbar -->
    <div style="background:rgba(8,6,18,0.98);border-bottom:1px solid rgba(167,139,250,0.2);padding:0 24px;height:60px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;backdrop-filter:blur(12px)">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:32px;height:32px;border-radius:9px;background:linear-gradient(135deg,var(--purple),#60a5fa);display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 0 16px rgba(167,139,250,0.35)">🛡</div>
        <div style="font-size:16px;font-weight:800">Split<span style="color:var(--purple)">Ease</span></div>
        <div style="background:rgba(167,139,250,0.15);border:1px solid rgba(167,139,250,0.3);color:var(--purple);border-radius:6px;padding:3px 9px;font-size:10px;font-weight:700;letter-spacing:1px">ADMIN</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <div id="adm-topbar-time" style="font-size:11px;color:var(--muted)"></div>
        <div id="adm-topbar-email" style="font-size:12px;color:var(--purple);font-weight:600"></div>
        <button onclick="exitAdminScreen()" style="background:var(--surface2);border:1px solid var(--border);color:var(--muted);padding:7px 14px;border-radius:8px;cursor:pointer;font-family:var(--font);font-size:12px;font-weight:600;transition:all 0.2s" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--muted)'">← App</button>
        <button onclick="adminLogout()" style="background:var(--red-dim);border:1px solid rgba(255,94,108,0.3);color:var(--red);padding:7px 14px;border-radius:8px;cursor:pointer;font-family:var(--font);font-size:12px;font-weight:600">Sign Out</button>
      </div>
    </div>

    <!-- Admin Body -->
    <div style="display:flex;flex:1;overflow:hidden;height:calc(100vh - 60px)">

      <!-- Admin Sidebar -->
      <nav id="admin-sidebar" style="width:230px;background:var(--surface);border-right:1px solid rgba(167,139,250,0.12);padding:14px 10px;display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0">
        <div style="font-size:10px;font-weight:700;color:var(--muted2);text-transform:uppercase;letter-spacing:1px;padding:8px 10px 5px">Overview</div>
        <div class="adm-nav active" id="adm-nav-overview" onclick="adminGoTo('overview')"><span>📊</span> Dashboard</div>

        <div style="font-size:10px;font-weight:700;color:var(--muted2);text-transform:uppercase;letter-spacing:1px;padding:12px 10px 5px">Users</div>
        <div class="adm-nav" id="adm-nav-users" onclick="adminGoTo('users')"><span>👥</span> All Users <span id="adm-user-badge" style="margin-left:auto;background:var(--purple);color:white;border-radius:10px;padding:1px 7px;font-size:10px;font-weight:700">0</span></div>
        <div class="adm-nav" id="adm-nav-sessions" onclick="adminGoTo('sessions')"><span>🟢</span> Live Sessions</div>

        <div style="font-size:10px;font-weight:700;color:var(--muted2);text-transform:uppercase;letter-spacing:1px;padding:12px 10px 5px">Content</div>
        <div class="adm-nav" id="adm-nav-groups" onclick="adminGoTo('groups')"><span>🏘</span> All Groups</div>
        <div class="adm-nav" id="adm-nav-expenses" onclick="adminGoTo('expenses')"><span>💸</span> All Expenses</div>

        <div style="font-size:10px;font-weight:700;color:var(--muted2);text-transform:uppercase;letter-spacing:1px;padding:12px 10px 5px">Tools</div>
        <div class="adm-nav" id="adm-nav-broadcast" onclick="adminGoTo('broadcast')"><span>📢</span> Broadcast</div>
        <div class="adm-nav" id="adm-nav-settings" onclick="adminGoTo('settings')"><span>⚙️</span> Settings</div>
        <div class="adm-nav" id="adm-nav-logs" onclick="adminGoTo('logs')"><span>📋</span> Audit Log</div>

        <div style="margin-top:auto;padding-top:12px;border-top:1px solid rgba(167,139,250,0.12)">
          <div style="font-size:11px;color:var(--muted2);padding:6px 12px" id="adm-refresh-time"></div>
        </div>
      </nav>

      <!-- Admin Main -->
      <main style="flex:1;overflow-y:auto;padding:28px;background:var(--bg)">

        <!-- ── OVERVIEW ── -->
        <div class="adm-page active" id="adm-page-overview">
          <div style="font-size:22px;font-weight:800;margin-bottom:4px">Dashboard Overview</div>
          <div style="font-size:13px;color:var(--muted);margin-bottom:24px" id="adm-overview-sub">—</div>
          <div id="adm-stats-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:24px"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
            <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px">
              <div style="font-size:13px;font-weight:700;margin-bottom:14px">📈 Registrations by Month</div>
              <div id="adm-reg-chart"></div>
            </div>
            <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px">
              <div style="font-size:13px;font-weight:700;margin-bottom:14px">🏆 Top Groups by Activity</div>
              <div id="adm-top-groups"></div>
            </div>
          </div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px">
            <div style="font-size:13px;font-weight:700;margin-bottom:14px">🔔 Recent Platform Activity</div>
            <div id="adm-recent-act"></div>
          </div>
        </div>

        <!-- ── USERS ── -->
        <div class="adm-page" id="adm-page-users">
          <div style="font-size:22px;font-weight:800;margin-bottom:4px">User Management</div>
          <div style="font-size:13px;color:var(--muted);margin-bottom:24px">View, moderate and manage all registered accounts</div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden">
            <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
              <div style="font-size:14px;font-weight:700" id="adm-users-title">All Users</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                <div style="display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:8px 12px;width:220px">
                  <span style="color:var(--muted);font-size:13px">🔍</span>
                  <input type="text" id="adm-user-search" placeholder="Search name or email…" oninput="renderAdminUsers()" style="background:none;border:none;outline:none;color:var(--text);font-family:var(--font);font-size:13px;flex:1;width:0">
                </div>
                <button onclick="exportUsersCSV()" style="background:rgba(167,139,250,0.1);border:1px solid rgba(167,139,250,0.25);color:var(--purple);padding:8px 14px;border-radius:8px;cursor:pointer;font-family:var(--font);font-size:12px;font-weight:700">⬇ CSV</button>
              </div>
            </div>
            <div style="overflow-x:auto">
              <table style="width:100%;border-collapse:collapse">
                <thead><tr style="background:var(--surface2)">
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">User</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Joined</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Groups</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Expenses</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Status</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Actions</th>
                </tr></thead>
                <tbody id="adm-users-tbody"></tbody>
              </table>
            </div>
            <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-top:1px solid var(--border);font-size:12px;color:var(--muted)">
              <span id="adm-users-info">—</span>
              <div id="adm-users-pages" style="display:flex;gap:5px"></div>
            </div>
          </div>
        </div>

        <!-- ── SESSIONS ── -->
        <div class="adm-page" id="adm-page-sessions">
          <div style="font-size:22px;font-weight:800;margin-bottom:4px">Live Sessions</div>
          <div style="font-size:13px;color:var(--muted);margin-bottom:24px">Users currently active in this browser</div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px" id="adm-sessions-body"></div>
        </div>

        <!-- ── GROUPS ── -->
        <div class="adm-page" id="adm-page-groups">
          <div style="font-size:22px;font-weight:800;margin-bottom:4px">All Groups</div>
          <div style="font-size:13px;color:var(--muted);margin-bottom:24px">Every group created across all user accounts</div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden">
            <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
              <div style="font-size:14px;font-weight:700" id="adm-groups-title">All Groups</div>
              <div style="display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:8px 12px;width:220px">
                <span style="color:var(--muted);font-size:13px">🔍</span>
                <input type="text" id="adm-group-search" placeholder="Search groups…" oninput="renderAdminGroups()" style="background:none;border:none;outline:none;color:var(--text);font-family:var(--font);font-size:13px;flex:1;width:0">
              </div>
            </div>
            <div style="overflow-x:auto">
              <table style="width:100%;border-collapse:collapse">
                <thead><tr style="background:var(--surface2)">
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Group</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Owner</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Members</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Expenses</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Created</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Actions</th>
                </tr></thead>
                <tbody id="adm-groups-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ── EXPENSES ── -->
        <div class="adm-page" id="adm-page-expenses">
          <div style="font-size:22px;font-weight:800;margin-bottom:4px">All Expenses</div>
          <div style="font-size:13px;color:var(--muted);margin-bottom:24px">Every transaction logged across all accounts</div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden">
            <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
              <div style="font-size:14px;font-weight:700" id="adm-exp-title">All Expenses</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                <div style="display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:8px 12px;width:220px">
                  <span style="color:var(--muted);font-size:13px">🔍</span>
                  <input type="text" id="adm-exp-search" placeholder="Search expenses…" oninput="renderAdminExpenses()" style="background:none;border:none;outline:none;color:var(--text);font-family:var(--font);font-size:13px;flex:1;width:0">
                </div>
                <button onclick="exportAllExpensesCSV()" style="background:rgba(167,139,250,0.1);border:1px solid rgba(167,139,250,0.25);color:var(--purple);padding:8px 14px;border-radius:8px;cursor:pointer;font-family:var(--font);font-size:12px;font-weight:700">⬇ CSV</button>
              </div>
            </div>
            <div style="overflow-x:auto">
              <table style="width:100%;border-collapse:collapse">
                <thead><tr style="background:var(--surface2)">
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Description</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">User</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Amount</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Category</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Date</th>
                  <th style="padding:11px 16px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Status</th>
                </tr></thead>
                <tbody id="adm-exp-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ── BROADCAST ── -->
        <div class="adm-page" id="adm-page-broadcast">
          <div style="font-size:22px;font-weight:800;margin-bottom:4px">Broadcast Message</div>
          <div style="font-size:13px;color:var(--muted);margin-bottom:24px">Send a message to all users — appears in their Activity feed</div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:16px">
            <div class="form-group"><label>Message</label><textarea id="adm-bc-msg" placeholder="Type your announcement…" rows="3" style="resize:vertical"></textarea></div>
            <div class="form-group"><label>Type</label>
              <select id="adm-bc-type" style="max-width:260px">
                <option value="#4fffb0">✅ Info / Announcement</option>
                <option value="#ffc94d">⚠️ Warning</option>
                <option value="#ff5e6c">🚨 Important Alert</option>
                <option value="#a78bfa">🎉 Celebration</option>
                <option value="#60a5fa">💙 Product Update</option>
              </select>
            </div>
            <button onclick="sendBroadcast()" class="btn btn-primary" style="background:linear-gradient(135deg,var(--purple),#60a5fa);color:white;width:auto;padding:11px 28px">📢 Send to All Users</button>
          </div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px">
            <div style="font-size:13px;font-weight:700;margin-bottom:14px">📜 Broadcast History</div>
            <div id="adm-bc-history"></div>
          </div>
        </div>

        <!-- ── SETTINGS ── -->
        <div class="adm-page" id="adm-page-settings">
          <div style="font-size:22px;font-weight:800;margin-bottom:4px">Settings</div>
          <div style="font-size:13px;color:var(--muted);margin-bottom:24px">Platform configuration and admin credentials</div>

          <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:14px">
            <div style="font-size:14px;font-weight:700;margin-bottom:16px">🔧 Platform Controls</div>
            <div id="adm-settings-rows"></div>
          </div>

          <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:14px">
            <div style="font-size:14px;font-weight:700;margin-bottom:16px">🛡 Admin Credentials</div>
            <div class="row2">
              <div class="form-group"><label>Admin Email</label><input type="email" id="st-adm-email" placeholder="admin@example.com"></div>
              <div class="form-group"><label>New Password</label><input type="password" id="st-adm-pass" placeholder="Leave blank to keep current"></div>
            </div>
            <button onclick="saveAdminCreds()" class="btn btn-ghost btn-sm" style="width:auto">Save Credentials</button>
          </div>

          <div style="background:var(--surface);border:1px solid rgba(255,94,108,0.2);border-radius:var(--radius);padding:22px">
            <div style="font-size:14px;font-weight:700;margin-bottom:16px;color:var(--red)">⚠️ Danger Zone</div>
            <div style="display:flex;flex-direction:column;gap:10px">
              <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--red-dim);border:1px solid rgba(255,94,108,0.2);border-radius:10px;flex-wrap:wrap;gap:8px">
                <div><div style="font-weight:600;font-size:13px">Clear All Invite Tokens</div><div style="font-size:12px;color:var(--muted);margin-top:2px">Invalidates all existing invite links</div></div>
                <button onclick="adminClearInvites()" style="background:var(--red-dim);border:1px solid rgba(255,94,108,0.3);color:var(--red);padding:7px 14px;border-radius:8px;cursor:pointer;font-family:var(--font);font-size:12px;font-weight:600">Clear All</button>
              </div>
              <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--red-dim);border:1px solid rgba(255,94,108,0.2);border-radius:10px;flex-wrap:wrap;gap:8px">
                <div><div style="font-weight:600;font-size:13px">Export Full Data Backup</div><div style="font-size:12px;color:var(--muted);margin-top:2px">Download all platform data as JSON</div></div>
                <button onclick="adminExportBackup()" style="background:var(--red-dim);border:1px solid rgba(255,94,108,0.3);color:var(--red);padding:7px 14px;border-radius:8px;cursor:pointer;font-family:var(--font);font-size:12px;font-weight:600">Export JSON</button>
              </div>
            </div>
          </div>
        </div>

        <!-- ── AUDIT LOG ── -->
        <div class="adm-page" id="adm-page-logs">
          <div style="font-size:22px;font-weight:800;margin-bottom:4px">Audit Log</div>
          <div style="font-size:13px;color:var(--muted);margin-bottom:24px">All admin actions recorded this session</div>
          <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px">
            <div style="display:flex;justify-content:flex-end;margin-bottom:12px">
              <button onclick="clearAuditLog()" style="background:var(--red-dim);border:1px solid rgba(255,94,108,0.3);color:var(--red);padding:7px 14px;border-radius:8px;cursor:pointer;font-family:var(--font);font-size:12px;font-weight:600">🗑 Clear Log</button>
            </div>
            <div id="adm-audit-body"></div>
          </div>
        </div>

      </main>
    </div>
  </div><!-- end admin-app-view -->
</div><!-- end admin-screen -->

<!-- USER DETAIL MODAL -->
<div class="overlay" id="adm-user-modal">
  <div class="modal" style="max-width:520px">
    <div class="modal-head">
      <div class="modal-title" id="adm-modal-title">User Details</div>
      <button class="close-x" onclick="closeModal('adm-user-modal')">✕</button>
    </div>
    <div id="adm-modal-body"></div>
  </div>
</div>


<!-- DB Loading Overlay -->
<div id="db-loading">
  <div class="db-spinner"></div>
  <div class="db-loading-txt" id="db-loading-txt">Connecting to database…</div>
</div>

</body>
</html>
